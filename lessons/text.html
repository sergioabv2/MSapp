<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lectura Interactiva</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  :root {
    /* Paleta de colores de lectura limpia */
    --bg-color: #ffffff;
    --text-main: #111827;
    --text-secondary: #374151;
    --text-muted: #6b7280;
    
    /* Color para el efecto de subrayado (Un amarillo suave) */
    --highlight-color: #fde68a; 

    /* Colores para la caja de "Nota Importante" */
    --alert-bg: #fff7ed;
    --alert-border: #ffedd5;
    --alert-text: #9a3412;
    --alert-icon: #f97316;

    /* Navegación inferior */
    --nav-border: #e5e7eb;
    --nav-hover: #f9fafb;

    /* Dimensiones */
    --page-width: 760px;
    --padding-x: 24px;
    --space-y: 1.5rem;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-secondary);
    line-height: 1.7; /* Un poco más de aire para lectura cómoda */
    font-size: 18px;  /* Tamaño base ligeramente aumentado */
    -webkit-font-smoothing: antialiased;
    padding-bottom: 4rem;
  }

  /* Contenedor Principal */
  main {
    max-width: var(--page-width);
    margin: 5rem auto;
    padding: 0 var(--padding-x);
  }

  /* --- Tipografía --- */
  h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-main);
    letter-spacing: -0.025em;
    margin-bottom: 2rem;
    line-height: 1.2;
  }

  h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-main);
    margin-top: 3.5rem;
    margin-bottom: 1.25rem;
    letter-spacing: -0.015em;
  }

  h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-top: 2rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  p {
    margin-bottom: var(--space-y);
  }
  
  strong {
    font-weight: 700;
    color: var(--text-main);
  }

  /* --- ESTILOS DEL SUBRAYADO ANIMADO --- */
  /* Esta es la clase que aplicaremos al texto que queremos animar */
  .scroll-highlight {
    /* Preparamos el gradiente pero lo ocultamos inicialmente */
    background-image: linear-gradient(to right, var(--highlight-color) 0%, var(--highlight-color) 100%);
    background-repeat: no-repeat;
    background-size: 0% 100%; /* Empieza con ancho 0 */
    
    /* Animación suave */
    transition: background-size 0.8s cubic-bezier(0.25, 1, 0.5, 1);
    
    /* Pequeños ajustes visuales */
    padding: 2px 2px;
    margin: 0 -2px;
    border-radius: 4px;
    
    /* Asegura que el subrayado funcione bien si la frase se rompe en dos líneas */
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
  }

  /* Cuando GSAP añade la clase 'active', el ancho pasa al 100% */
  .scroll-highlight.active {
    background-size: 100% 100%;
    color: #000; /* Opcional: oscurecer un poco el texto al subrayar */
  }


  /* --- Componentes Varios --- */
  .info-box {
    background-color: var(--alert-bg);
    border-radius: 12px;
    padding: 1.75rem;
    margin: 3rem 0;
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
  }

  .info-box svg {
    flex-shrink: 0;
    color: var(--alert-icon);
    width: 28px;
    height: 28px;
    margin-top: 2px;
  }

  .info-box-content {
    font-size: 1rem;
    color: var(--text-main);
  }

  .info-box-title {
    display: block;
    font-weight: 700;
    color: var(--alert-text);
    margin-bottom: 0.5rem;
  }

  .navigation-footer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 5rem;
    padding-top: 2.5rem;
    border-top: 1px solid var(--nav-border);
  }

  .nav-card {
    border: 1px solid var(--nav-border);
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: #fff;
  }

  .nav-card:hover {
    background-color: var(--nav-hover);
    border-color: #d1d5db;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }

  .nav-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-main);
  }

  .nav-card.next {
    text-align: right;
    align-items: flex-end;
  }
  
  .nav-card.next .nav-label {
    flex-direction: row-reverse;
  }

  @media (max-width: 600px) {
    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    .navigation-footer { grid-template-columns: 1fr; }
  }


  /* --- Botón Flotante (FAB) Contenedor --- */
  .fab-container {
    position: fixed;
    bottom: 2rem;
    left: 2rem; /* Izquierda */
    z-index: 100;
    display: flex;
    flex-direction: column-reverse; /* Las opciones salen hacia arriba */
    align-items: center;
    gap: 1rem;
  }

  /* El botón principal (Trigger) */
  .fab-main {
    width: 3.5rem;
    height: 3.5rem;
    background-color: var(--text-main);
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, background-color 0.3s;
  }

  .fab-main:hover {
    background-color: black;
    transform: scale(1.05);
  }

  /* Animación del icono principal al abrir */
  .fab-container.open .fab-main {
    transform: rotate(45deg); /* Gira a una X */
  }

  /* --- Botones de Acción (Ocultos por defecto) --- */
  .fab-action {
    width: 2.8rem;
    height: 2.8rem;
    border-radius: 50%;
    border: 1px solid var(--nav-border);
    background-color: white;
    color: var(--text-secondary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Estado inicial: invisible y desplazado hacia abajo */
    opacity: 0;
    transform: translateY(20px) scale(0.8);
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Estado cuando está activo (Lápiz activado) */
  .fab-action.active-tool {
    background-color: var(--text-main);
    color: white;
    border-color: var(--text-main);
  }

  /* Animación de apertura (Cascada) */
  .fab-container.open .fab-action {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: all;
  }

  /* Retrasos para efecto escalonado al abrir hacia arriba */
  .fab-container.open .fab-action:nth-child(2) { transition-delay: 0.05s; } /* Ojo */
  .fab-container.open .fab-action:nth-child(3) { transition-delay: 0.1s; }  /* Color */
  .fab-container.open .fab-action:nth-child(4) { transition-delay: 0.15s; } /* Lápiz */

  /* Estilos específicos para el input de color */
  .color-wrapper {
    overflow: hidden;
    padding: 0;
  }
  
  #colorPicker {
    -webkit-appearance: none;
    border: none;
    width: 150%; 
    height: 150%;
    margin: -25%; /* Truco para llenar el botón circular */
    cursor: pointer;
  }
  
  /* Estilos de resaltado manual (igual que antes) */
  .user-highlight {
    background-color: var(--highlight-color, #fde68a);
    cursor: pointer;
  }
  body.hide-highlights .user-highlight {
    background-color: transparent !important;
  }

  /* --- Tooltip de Eliminar (Basura) --- */
  #deleteTooltip {
    position: absolute;
    background-color: #1f2937; /* Gris muy oscuro */
    color: white;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    z-index: 1000;
    display: none; /* Oculto por defecto */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transform: translate(-50%, -100%); /* Centrado horizontal, sube para estar encima */
    margin-top: -8px; /* Un poco de aire */
    transition: opacity 0.2s;
  }

  /* La flechita hacia abajo del tooltip */
  #deleteTooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -6px;
    border-width: 6px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
  }

  #deleteTooltip:hover {
    background-color: #ef4444; /* Rojo al pasar el mouse */
  }
  #deleteTooltip:hover::after {
    border-top-color: #ef4444;
  }

  /* --- 1. Estilos de Texto Estilizado (Como en la imagen) --- */
  
  /* Negritas más fuertes y oscuras */
  strong {
    font-weight: 700; /* Extra bold */
    color: #111827;   /* Negro casi puro */
  }

  /* El estilo "badge" tipo código (fondo gris, texto rojo) */
  .code-badge {
    background-color: #f3f4f6; /* Gris muy claro */
    color: #ef4444;            /* Rojo suave */
    font-family: 'Menlo', 'Monaco', 'Courier New', monospace; /* Fuente monoespaciada */
    font-size: 0.9em;          /* Un poco más pequeño para armonía */
    padding: 2px 6px;          /* Espacio interno */
    border-radius: 6px;        /* Bordes redondeados */
    border: 1px solid #e5e7eb; /* Borde sutil */
    vertical-align: middle;
    font-weight: 500;
  }

  /* --- 2. Imágenes Interactivas --- */
  
  /* Contenedor para asegurar el centrado y márgenes */
  .image-container {
    width: 100%;
    margin: 3rem 0; /* Espacio vertical generoso */
    display: flex;
    justify-content: center;
    position: relative; /* Necesario para el z-index */
  }

  .interactive-img {
    width: 100%;       /* Ocupa todo el ancho del contenedor */
    height: auto;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Sombra suave inicial */
    
    /* La magia de la interacción */
    cursor: zoom-in;   /* El cursor de "lupa con +" */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s ease;
    transform-origin: center center;
    z-index: 10;
  }

  /* Estado "Agrandado" */
  .interactive-img.zoomed {
    transform: scale(1.15); /* Crece un 15% */
    cursor: zoom-out;       /* Cursor de "lupa con -" */
    z-index: 50;            /* Se pone por encima del texto */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* Sombra profunda al levantar */
  }

  /* Pequeño ajuste para móviles para que no se salga de pantalla */
  @media (max-width: 600px) {
    .interactive-img.zoomed {
      transform: scale(1.05); /* Zoom más sutil en celular */
    }
  }

  /* --- 3. Listas Estilizadas (Enumeración y Definición) --- */
  .styled-list {
    list-style: none; /* Quitamos las viñetas por defecto */
    padding-left: 0;
    margin: 2rem 0;
  }

  .styled-list li {
    position: relative;
    padding-left: 1.5rem; /* Espacio para la bolita azul */
    margin-bottom: 1.25rem; /* Espacio entre items */
    color: var(--text-secondary);
  }

  /* La viñeta azul personalizada */
  .styled-list li::before {
    margin-top: 7px;
    content: "•";          /* El carácter de punto */
    color: #4f46e5;        /* Azul índigo moderno (tipo Notion/Tailwind) */
    font-weight: bold;
    font-size: 1.5rem;     /* Tamaño de la viñeta */
    position: absolute;
    left: 0;
    top: -5px;             /* Ajuste fino para alinear con la primera línea */
    line-height: 1;
  }

  /* --- 4. Bloque de Énfasis (Línea Vertical Azul) --- */
  .emphasis-block {
    border-left: 4px solid #4f46e5; /* La línea gruesa azul */
    padding-left: 1.5rem;           /* Aire entre la línea y el texto */
    margin: 2.5rem 0;               /* Separación vertical generosa */
    font-size: 1.05rem;             /* Ligeramente más grande para destacar */
    color: var(--text-main);
  }
  
  /* Ajuste para que los párrafos dentro del bloque no tengan margen extra abajo si es el último */
  .emphasis-block p:last-child {
    margin-bottom: 0;
  }


  /* --- Estilos para el Embed de Partitura --- */

.embed-container {
  width: 100%;
  /* Altura fija calculada: 
     50px (topbar) + 40px (toolbar) + 150px (partitura) + 112px (piano) + espacio extra 
  */
  height: 330px; 
  margin: 3rem 0; /* Espaciado vertical igual que tenías en la imagen */
  
  /* Estética del contenedor */
  background-color: #fafafa;
  border: 1px solid var(--nav-border); /* Usa tu variable de borde existente */
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  overflow: hidden; /* Para que las esquinas del iframe no se salgan */
}

.music-frame {
  width: 100%;
  height: 100%;
  border: none;
  display: block; /* Elimina espacios fantasma inline */
}

/* Ajuste Responsive para móviles */
@media (max-width: 600px) {
  .embed-container {
    margin: 2rem 0;
    border-radius: 8px; /* Radio un poco menor en pantallas chicas */
  }
}
</style>
</head>
<body>

<main>
  <h3>Conceptos Fundamentales</h3>
  <h1>La Frase Musical: Unidad de Sentido</h1>
  
  <p>Una frase musical es una unidad melódica y rítmica completa en sí misma, comparable a una oración en el lenguaje hablado. Se construye típicamente sobre un patrón de pregunta y respuesta, conocido como antecedente y consecuente, y suele abarcar una duración de dos, cuatro u ocho compases. La dirección melódica, los puntos de reposo (cadencias) y el diseño rítmico son clave para definir su carácter y límites.</p>

 <p>Una frase musical es una unidad melódica completa, comparable a una oración en el lenguaje hablado. Para dominarla, primero asegúrate de entender el <strong>ritmo armónico</strong>.</p>


 <div class="embed-container" style="height: 200px">
  <iframe 
    src="https://www.mozart-app.com/lessons/xmls" 
    class="music-frame" 
    title="Partitura Interactiva"
    loading="lazy"
    allow="midi *; microphone *">
  </iframe>
</div>
  
  <p>Tus estudiantes deberían iniciar sesión en <span class="code-badge">aula.tuescuela.com</span>, punto. Si los envías a una URL genérica, pierdes la identidad de tu marca. Esto es lo que llamamos la <strong>prueba de fuego</strong> de la profesionalidad.</p>

  <div class="image-container">
    <img src="https://lh3.googleusercontent.com/d/15XlhDsprrJJrf-UYt70n8a5fu9UIcVMR=s600" 
         alt="Partitura musical detallada" 
         class="interactive-img">
  </div>

  <p>Identificar el final de una frase es fundamental. La cadencia puede ser conclusiva o suspensiva. <span class="scroll-highlight">Escuchar la respiración natural de la línea melódica</span> es el primer paso.</p>

  <p>La articulación y el fraseo en la ejecución dependen de este análisis. Un legato suave puede unir notas dentro de una misma idea, mientras que un ligero descanso o un cambio dinámico (como un decrescendo) pueden marcar el final de una frase. <span class="scroll-highlight">La estructura formal básica, la textura y las indicaciones del compositor</span> son guías esenciales.</p>

  <div class="info-box">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    <div class="info-box-content">
      <span class="info-box-title">NOTA IMPORTANTE</span>
      La comprensión de la frase precede y determina la expresión musical efectiva. Sin análisis previo, la ejecución carecerá de discurso coherente.
    </div>
  </div>

  <h2>La práctica del análisis</h2>
  
  <p>La práctica del análisis y la escucha activa desarrollan esta habilidad. Aislar la línea melódica principal, cantarla para sentir sus puntos de reposo naturales y marcar las cadencias en la partitura son ejercicios fundamentales. <span class="scroll-highlight">La repetición exacta sin variación es menos frecuente que la repetición con modificación</span>.</p>

<div class="emphasis-block">
    <p>
      <strong>¿Qué es una Frase Musical?</strong>
    </p>
    <p>
      Es la unidad estructural con sentido musical completo más pequeña. Es comparable a una <strong>oración gramatical</strong> en el lenguaje hablado: tiene un inicio claro, un desarrollo direccional y un punto de llegada o conclusión.
    </p>
    <p>
      Sin el fraseo adecuado, la música suena mecánica, como un robot leyendo un texto sin signos de puntuación.
    </p>
  </div>

  <p>Para identificar una frase en una partitura (y diferenciarla de un simple motivo o semifrase), debemos buscar ciertos rasgos característicos que le dan su identidad:</p>

  <ul class="styled-list">
    <li>
      <strong>Extensión (La Cuadratura):</strong> En la música occidental tradicional, la frase estándar suele tener una longitud de <strong>4 compases</strong> (frase corta) u <strong>8 compases</strong> (frase larga). Esta simetría es lo que el oído espera naturalmente.
    </li>
    <li>
      <strong>El Punto de Reposo (Cadencia):</strong> Es el requisito más técnico. Toda frase <em>debe</em> terminar en una cadencia armónica. Si no hay una sensación de pausa (ya sea conclusiva como un punto final, o suspensiva como una coma), la frase no ha terminado.
    </li>
    <li>
      <strong>Diseño Melódico (Contorno):</strong> Una frase suele tener una "forma" dibujable, a menudo como un arco: comienza en reposo, sube hacia un punto de tensión máxima (clímax) y desciende hacia la relajación.
    </li>
    <li>
      <strong>Relación Antecedente-Consecuente:</strong> A menudo, las frases funcionan en pares de "Pregunta y Respuesta". Los primeros compases plantean una duda (terminan en tensión/dominante) y los siguientes la resuelven (terminan en reposo/tónica).
    </li>
  </ul>

  <p>Concluya realizando el siguiente ejercicio:</p>

 <div class="embed-container">
  <iframe 
    src="https://www.mozart-app.com/lessons/xml?file=Ode%20to%20Joy.musicxml" 
    class="music-frame" 
    title="Partitura Interactiva"
    loading="lazy"
    allow="midi *; microphone *">
  </iframe>
</div>

  <div class="fab-container" id="fabContainer">
  
  <button class="fab-main" id="fabTrigger" title="Herramientas de lectura">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
  </button>

  <button id="toggleVisibility" class="fab-action" title="Ocultar/Mostrar notas">
    <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
    </svg>
  </button>

  <div class="fab-action color-wrapper" title="Color de resaltado">
    <input type="color" id="colorPicker" value="#fde68a">
  </div>

  <button id="toggleHighlightMode" class="fab-action" title="Activar modo subrayado">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
    </svg>
  </button>

</div>

<div id="deleteTooltip" title="Eliminar subrayado">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
</div>

</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

<script>
  // Variables de Estado
  let isHighlightMode = false;
  let currentColor = '#fde68a';
  let areHighlightsVisible = true;
  let isMenuOpen = false;
  let targetHighlight = null; // Guardará referencia al span que queremos borrar

  // Elementos DOM
  const fabContainer = document.getElementById('fabContainer');
  const fabTrigger = document.getElementById('fabTrigger');
  const btnToggleMode = document.getElementById('toggleHighlightMode');
  const btnVisibility = document.getElementById('toggleVisibility');
  const colorInput = document.getElementById('colorPicker');
  const contentArea = document.querySelector('main');
  
  // Nuevo elemento DOM: El tooltip de basura
  const deleteTooltip = document.getElementById('deleteTooltip');

  // --- Funciones Auxiliares ---

  // Ocultar la basura
  function hideDeleteTooltip() {
    deleteTooltip.style.display = 'none';
    targetHighlight = null;
  }

  // Mostrar la basura encima de un elemento
  function showDeleteTooltip(element) {
    targetHighlight = element;
    
    // Obtenemos coordenadas del subrayado
    const rect = element.getBoundingClientRect();
    
    // Calculamos posición (considerando el scroll de la página)
    // Left: Centro del elemento. Top: Parte superior del elemento.
    const scrollX = window.scrollX || window.pageXOffset;
    const scrollY = window.scrollY || window.pageYOffset;

    deleteTooltip.style.left = (rect.left + rect.width / 2 + scrollX) + 'px';
    deleteTooltip.style.top = (rect.top + scrollY) + 'px';
    deleteTooltip.style.display = 'block';
  }

  // --- Event Listeners ---

  // 1. Abrir / Cerrar Menú Flotante
  fabTrigger.addEventListener('click', () => {
    isMenuOpen = !isMenuOpen;
    fabContainer.classList.toggle('open');
  });

  // 2. Activar Modo Subrayado
  btnToggleMode.addEventListener('click', () => {
    isHighlightMode = !isHighlightMode;
    btnToggleMode.classList.toggle('active-tool');
    document.body.style.cursor = isHighlightMode ? 'text' : 'default';
    if (!isHighlightMode) window.getSelection().removeAllRanges();
    hideDeleteTooltip(); // Ocultar basura si cambiamos modo
  });

  // 3. Color
  colorInput.addEventListener('input', (e) => currentColor = e.target.value);

  // 4. Visibilidad
  btnVisibility.addEventListener('click', () => {
    areHighlightsVisible = !areHighlightsVisible;
    document.body.classList.toggle('hide-highlights');
    hideDeleteTooltip(); // Ocultar basura si ocultamos marcas
    
    // Cambiar icono
    const eyePath = areHighlightsVisible 
      ? '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />'
      : '<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />';
    document.getElementById('eyeIcon').innerHTML = eyePath;
  });

  // 5. CLICK GLOBAL: Maneja creación de subrayados Y detección de clics para borrar
  document.addEventListener('mouseup', (e) => {
    
    // A) Si hacemos click en el botón de basura
    if (deleteTooltip.contains(e.target) && targetHighlight) {
      // "Desenvolver" el texto (borrar el span pero dejar el texto)
      const parent = targetHighlight.parentNode;
      while (targetHighlight.firstChild) {
        parent.insertBefore(targetHighlight.firstChild, targetHighlight);
      }
      parent.removeChild(targetHighlight);
      hideDeleteTooltip();
      return; // Terminamos aquí
    }

    // B) Si hacemos click en un subrayado existente
    if (e.target.classList.contains('user-highlight')) {
      // Solo mostramos la basura si NO estamos seleccionando texto activamente
      if (window.getSelection().toString().length === 0) {
        showDeleteTooltip(e.target);
        return;
      }
    } else {
      // Si clickeamos en cualquier otro lado (texto normal o blanco), ocultar basura
      hideDeleteTooltip();
    }

    // C) Crear NUEVO subrayado (Lógica original)
    if (!isHighlightMode || !areHighlightsVisible) return;
    
    const selection = window.getSelection();
    if (selection.toString().length > 0) {
      const range = selection.getRangeAt(0);
      
      // Validación de zona segura
      if (!contentArea.contains(range.commonAncestorContainer) && range.commonAncestorContainer !== contentArea) return; 

      // Evitar subrayar sobre subrayado (anidamiento complejo)
      // Si la selección ya contiene un user-highlight, cancelamos para evitar romper el HTML
      if (range.cloneContents().querySelector('.user-highlight')) {
        console.warn("No se permite subrayar sobre otro subrayado.");
        return;
      }

      const span = document.createElement('span');
      span.className = 'user-highlight';
      span.style.setProperty('--highlight-color', currentColor);

      try {
        range.surroundContents(span);
        selection.removeAllRanges();
      } catch (e) {
        console.warn("Selección inválida a través de bloques.");
      }
    }
  });


  const images = document.querySelectorAll('.interactive-img');

  images.forEach(img => {
    img.addEventListener('click', (e) => {
      // Evitamos que este click active otras cosas (como cerrar menús)
      e.stopPropagation(); 
      
      // Alternar la clase 'zoomed'
      img.classList.toggle('zoomed');
      
      // Opcional: Si hago click en una, cerrar las otras si estuvieran abiertas
      images.forEach(otherImg => {
        if (otherImg !== img) {
          otherImg.classList.remove('zoomed');
        }
      });
    });
  });

  // Cerrar la imagen si hago click fuera de ella (en cualquier parte del documento)
  document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('interactive-img')) {
      images.forEach(img => {
        img.classList.remove('zoomed');
      });
    }
  });
</script>

</body>
</html>
