<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lectura Interactiva</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  :root {
    /* Paleta de colores de lectura limpia */
    --bg-color: #ffffff;
    --text-main: #111827;
    --text-secondary: #374151;
    --text-muted: #6b7280;
    
    /* Color para el efecto de subrayado (Un amarillo suave) */
    --highlight-color: #fde68a; 

    /* Colores para la caja de "Nota Importante" */
    --alert-bg: #fff7ed;
    --alert-border: #ffedd5;
    --alert-text: #9a3412;
    --alert-icon: #f97316;

    /* Navegación inferior */
    --nav-border: #e5e7eb;
    --nav-hover: #f9fafb;

    /* Dimensiones */
    --page-width: 760px;
    --padding-x: 24px;
    --space-y: 1.5rem;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-secondary);
    line-height: 1.7; /* Un poco más de aire para lectura cómoda */
    font-size: 18px;  /* Tamaño base ligeramente aumentado */
    -webkit-font-smoothing: antialiased;
    padding-bottom: 4rem;
  }

  /* Contenedor Principal */
  main {
    max-width: var(--page-width);
    margin: 5rem auto;
    padding: 0 var(--padding-x);
  }

  /* --- Tipografía --- */
  h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-main);
    letter-spacing: -0.025em;
    margin-bottom: 2rem;
    line-height: 1.2;
  }

  h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-main);
    margin-top: 3.5rem;
    margin-bottom: 1.25rem;
    letter-spacing: -0.015em;
  }

  h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-top: 2rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  p {
    margin-bottom: var(--space-y);
  }
  
  strong {
    font-weight: 700;
    color: var(--text-main);
  }

  /* --- ESTILOS DEL SUBRAYADO ANIMADO --- */
  /* Esta es la clase que aplicaremos al texto que queremos animar */
  .scroll-highlight {
    /* Preparamos el gradiente pero lo ocultamos inicialmente */
    background-image: linear-gradient(to right, var(--highlight-color) 0%, var(--highlight-color) 100%);
    background-repeat: no-repeat;
    background-size: 0% 100%; /* Empieza con ancho 0 */
    
    /* Animación suave */
    transition: background-size 0.8s cubic-bezier(0.25, 1, 0.5, 1);
    
    /* Pequeños ajustes visuales */
    padding: 2px 2px;
    margin: 0 -2px;
    border-radius: 4px;
    
    /* Asegura que el subrayado funcione bien si la frase se rompe en dos líneas */
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
  }

  /* Cuando GSAP añade la clase 'active', el ancho pasa al 100% */
  .scroll-highlight.active {
    background-size: 100% 100%;
    color: #000; /* Opcional: oscurecer un poco el texto al subrayar */
  }


  /* --- Componentes Varios --- */
  .info-box {
    background-color: var(--alert-bg);
    border-radius: 12px;
    padding: 1.75rem;
    margin: 3rem 0;
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
  }

  .info-box svg {
    flex-shrink: 0;
    color: var(--alert-icon);
    width: 28px;
    height: 28px;
    margin-top: 2px;
  }

  .info-box-content {
    font-size: 1rem;
    color: var(--text-main);
  }

  .info-box-title {
    display: block;
    font-weight: 700;
    color: var(--alert-text);
    margin-bottom: 0.5rem;
  }

  .navigation-footer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 5rem;
    padding-top: 2.5rem;
    border-top: 1px solid var(--nav-border);
  }

  .nav-card {
    border: 1px solid var(--nav-border);
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: #fff;
  }

  .nav-card:hover {
    background-color: var(--nav-hover);
    border-color: #d1d5db;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }

  .nav-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-main);
  }

  .nav-card.next {
    text-align: right;
    align-items: flex-end;
  }
  
  .nav-card.next .nav-label {
    flex-direction: row-reverse;
  }

  @media (max-width: 600px) {
    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    .navigation-footer { grid-template-columns: 1fr; }
  }



.fab-main {
  
  position: fixed;
  bottom: 2rem; /* Encima del botón de marcador */
  left: 1.7rem;
  z-index: 99;
  width: 3rem;     /* Un poco más pequeño que el principal */
  height: 3rem;
  background-color: white;
  color: var(--text-main);
  border: 1px solid var(--nav-border);
  border-radius: 50%;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.fab-main:hover { transform: scale(1.05); background-color: #fde68a; }


  .user-highlight {
  background-color: var(--highlight-color);
  cursor: pointer; /* Para indicar que se puede borrar */
}


/* --- Estilos Botón Bocina --- */
.fab-secondary {
  position: fixed;
  bottom: 5.7rem; /* Encima del botón de marcador */
  left: 1.7rem;
  z-index: 99;
  width: 3rem;     /* Un poco más pequeño que el principal */
  height: 3rem;
  background-color: white;
  color: var(--text-main);
  border: 1px solid var(--nav-border);
  border-radius: 50%;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.fab-secondary:hover { transform: scale(1.05); background-color: #f9fafb; }

/* Panel de Controles (Play/Pausa/Stop) */
.tts-controls {
  position: fixed;
  bottom: 6.5rem;
  left: 6rem; /* A la derecha de la bocina */
  background: #1f2937;
  padding: 8px 12px;
  border-radius: 50px;
  display: flex;
  gap: 10px;
  z-index: 100;
  opacity: 0;           /* Oculto por defecto */
  pointer-events: none; /* No clickeable cuando oculto */
  transform: translateX(-10px);
  transition: all 0.3s ease;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.tts-controls.active {
  opacity: 1;
  pointer-events: all;
  transform: translateX(0);
}

.control-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
}
.control-btn:hover { color: var(--highlight-color); }

/* --- Resaltado de Lectura (Karaoke) --- */
.reading-word {
  background-color: #fdba74; /* Naranja suave */
  border-radius: 3px;
  transition: background 0.1s;
}
 
  body.hide-highlights .user-highlight {
    background-color: transparent !important;
  }

  /* --- Tooltip de Eliminar (Basura) --- */
  #deleteTooltip {
    position: absolute;
    background-color: #1f2937; /* Gris muy oscuro */
    color: white;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    z-index: 1000;
    display: none; /* Oculto por defecto */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transform: translate(-50%, -100%); /* Centrado horizontal, sube para estar encima */
    margin-top: -8px; /* Un poco de aire */
    transition: opacity 0.2s;
  }

  /* La flechita hacia abajo del tooltip */
  #deleteTooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -6px;
    border-width: 6px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
  }

  #deleteTooltip:hover {
    background-color: #ef4444; /* Rojo al pasar el mouse */
  }
  #deleteTooltip:hover::after {
    border-top-color: #ef4444;
  }

  /* --- 1. Estilos de Texto Estilizado (Como en la imagen) --- */
  
  /* Negritas más fuertes y oscuras */
  strong {
    font-weight: 700; /* Extra bold */
    color: #111827;   /* Negro casi puro */
  }

  /* El estilo "badge" tipo código (fondo gris, texto rojo) */
  .code-badge {
    background-color: #f3f4f6; /* Gris muy claro */
    color: #ef4444;            /* Rojo suave */
    font-family: 'Menlo', 'Monaco', 'Courier New', monospace; /* Fuente monoespaciada */
    font-size: 0.9em;          /* Un poco más pequeño para armonía */
    padding: 2px 6px;          /* Espacio interno */
    border-radius: 6px;        /* Bordes redondeados */
    border: 1px solid #e5e7eb; /* Borde sutil */
    vertical-align: middle;
    font-weight: 500;
  }

  /* --- 2. Imágenes Interactivas --- */
  
  /* Contenedor para asegurar el centrado y márgenes */
  .image-container {
    width: 100%;
    margin: 3rem 0; /* Espacio vertical generoso */
    display: flex;
    justify-content: center;
    position: relative; /* Necesario para el z-index */
  }

  .interactive-img {
    width: 100%;       /* Ocupa todo el ancho del contenedor */
    height: auto;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Sombra suave inicial */
    
    /* La magia de la interacción */
    cursor: zoom-in;   /* El cursor de "lupa con +" */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s ease;
    transform-origin: center center;
    z-index: 10;
  }

  /* Estado "Agrandado" */
  .interactive-img.zoomed {
    transform: scale(1.15); /* Crece un 15% */
    cursor: zoom-out;       /* Cursor de "lupa con -" */
    z-index: 50;            /* Se pone por encima del texto */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* Sombra profunda al levantar */
  }

  /* Pequeño ajuste para móviles para que no se salga de pantalla */
  @media (max-width: 600px) {
    .interactive-img.zoomed {
      transform: scale(1.05); /* Zoom más sutil en celular */
    }
  }

  /* --- 3. Listas Estilizadas (Enumeración y Definición) --- */
  .styled-list {
    list-style: none; /* Quitamos las viñetas por defecto */
    padding-left: 0;
    margin: 2rem 0;
  }

  .styled-list li {
    position: relative;
    padding-left: 1.5rem; /* Espacio para la bolita azul */
    margin-bottom: 1.25rem; /* Espacio entre items */
    color: var(--text-secondary);
  }

  /* La viñeta azul personalizada */
  .styled-list li::before {
    margin-top: 7px;
    content: "•";          /* El carácter de punto */
    color: #4f46e5;        /* Azul índigo moderno (tipo Notion/Tailwind) */
    font-weight: bold;
    font-size: 1.5rem;     /* Tamaño de la viñeta */
    position: absolute;
    left: 0;
    top: -5px;             /* Ajuste fino para alinear con la primera línea */
    line-height: 1;
  }

  /* --- 4. Bloque de Énfasis (Línea Vertical Azul) --- */
  .emphasis-block {
    border-left: 4px solid #4f46e5; /* La línea gruesa azul */
    padding-left: 1.5rem;           /* Aire entre la línea y el texto */
    margin: 2.5rem 0;               /* Separación vertical generosa */
    font-size: 1.05rem;             /* Ligeramente más grande para destacar */
    color: var(--text-main);
  }
  
  /* Ajuste para que los párrafos dentro del bloque no tengan margen extra abajo si es el último */
  .emphasis-block p:last-child {
    margin-bottom: 0;
  }


  /* --- Estilos para el Embed de Partitura --- */

.embed-container {
  width: 100%;
  /* Altura fija calculada: 
     50px (topbar) + 40px (toolbar) + 150px (partitura) + 112px (piano) + espacio extra 
  */
  height: 370px; 
  margin: 3rem 0; /* Espaciado vertical igual que tenías en la imagen */
  
  /* Estética del contenedor */
  background-color: #fafafa;
  border: 1px solid var(--nav-border); /* Usa tu variable de borde existente */
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  overflow: hidden; /* Para que las esquinas del iframe no se salgan */
}

.music-frame {
  width: 100%;
  height: 100%;
  border: none;
  display: block; /* Elimina espacios fantasma inline */
}

/* Ajuste Responsive para móviles */
@media (max-width: 600px) {
  .embed-container {
    margin: 2rem 0;
    border-radius: 8px; /* Radio un poco menor en pantallas chicas */
  }
}
</style>
</head>
<body>

<main>
  <h3>Conceptos Fundamentales</h3>
  <h1>La Frase Musical: Unidad de Sentido</h1>
  
  <p>Una frase musical es una unidad melódica y rítmica completa en sí misma, comparable a una oración en el lenguaje hablado. Se construye típicamente sobre un patrón de pregunta y respuesta, conocido como antecedente y consecuente, y suele abarcar una duración de dos, cuatro u ocho compases. La dirección melódica, los puntos de reposo (cadencias) y el diseño rítmico son clave para definir su carácter y límites.</p>

 <p>Una frase musical es una unidad melódica completa, comparable a una oración en el lenguaje hablado. Para dominarla, primero asegúrate de entender el <strong>ritmo armónico</strong>.</p>


 <div class="embed-container" style="height: 200px">
  <iframe 
    src="https://www.mozart-app.com/lessons/xmls" 
    class="music-frame" 
    title="Partitura Interactiva"
    loading="lazy"
    allow="midi *; microphone *">
  </iframe>
</div>
  
  <p>Tus estudiantes deberían iniciar sesión en <span class="code-badge">aula.tuescuela.com</span>, punto. Si los envías a una URL genérica, pierdes la identidad de tu marca. Esto es lo que llamamos la <strong>prueba de fuego</strong> de la profesionalidad.</p>

 
  <div class="embed-container">
  <iframe 
    src="https://www.mozart-app.com/lessons/xml?file=Ode%20to%20Joy.musicxml" 
    class="music-frame" 
    title="Partitura Interactiva"
    loading="lazy"
    allow="midi *; microphone *">
  </iframe>
</div>

  <p>Identificar el final de una frase es fundamental. La cadencia puede ser conclusiva o suspensiva. <span class="scroll-highlight">Escuchar la respiración natural de la línea melódica</span> es el primer paso.</p>

  <p>La articulación y el fraseo en la ejecución dependen de este análisis. Un legato suave puede unir notas dentro de una misma idea, mientras que un ligero descanso o un cambio dinámico (como un decrescendo) pueden marcar el final de una frase. <span class="scroll-highlight">La estructura formal básica, la textura y las indicaciones del compositor</span> son guías esenciales.</p>


 <div class="image-container">
    <img src="https://lh3.googleusercontent.com/d/15XlhDsprrJJrf-UYt70n8a5fu9UIcVMR=s600" 
         alt="Partitura musical detallada" 
         class="interactive-img">
  </div>


  <div class="info-box">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    <div class="info-box-content">
      <span class="info-box-title">NOTA IMPORTANTE</span>
      La comprensión de la frase precede y determina la expresión musical efectiva. Sin análisis previo, la ejecución carecerá de discurso coherente.
    </div>
  </div>

  <h2>La práctica del análisis</h2>
  
  <p>La práctica del análisis y la escucha activa desarrollan esta habilidad. Aislar la línea melódica principal, cantarla para sentir sus puntos de reposo naturales y marcar las cadencias en la partitura son ejercicios fundamentales. <span class="scroll-highlight">La repetición exacta sin variación es menos frecuente que la repetición con modificación</span>.</p>

<div class="emphasis-block">
    <p>
      <strong>¿Qué es una Frase Musical?</strong>
    </p>
    <p>
      Es la unidad estructural con sentido musical completo más pequeña. Es comparable a una <strong>oración gramatical</strong> en el lenguaje hablado: tiene un inicio claro, un desarrollo direccional y un punto de llegada o conclusión.
    </p>
    <p>
      Sin el fraseo adecuado, la música suena mecánica, como un robot leyendo un texto sin signos de puntuación.
    </p>
  </div>

  <p>Para identificar una frase en una partitura (y diferenciarla de un simple motivo o semifrase), debemos buscar ciertos rasgos característicos que le dan su identidad:</p>

  <ul class="styled-list">
    <li>
      <strong>Extensión (La Cuadratura):</strong> En la música occidental tradicional, la frase estándar suele tener una longitud de <strong>4 compases</strong> (frase corta) u <strong>8 compases</strong> (frase larga). Esta simetría es lo que el oído espera naturalmente.
    </li>
    <li>
      <strong>El Punto de Reposo (Cadencia):</strong> Es el requisito más técnico. Toda frase <em>debe</em> terminar en una cadencia armónica. Si no hay una sensación de pausa (ya sea conclusiva como un punto final, o suspensiva como una coma), la frase no ha terminado.
    </li>
    <li>
      <strong>Diseño Melódico (Contorno):</strong> Una frase suele tener una "forma" dibujable, a menudo como un arco: comienza en reposo, sube hacia un punto de tensión máxima (clímax) y desciende hacia la relajación.
    </li>
    <li>
      <strong>Relación Antecedente-Consecuente:</strong> A menudo, las frases funcionan en pares de "Pregunta y Respuesta". Los primeros compases plantean una duda (terminan en tensión/dominante) y los siguientes la resuelven (terminan en reposo/tónica).
    </li>
  </ul>

 

 <div id="ttsControls" class="tts-controls">
  <button id="btnStop" class="control-btn" title="Detener">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
  </button>
  <button id="btnPlayPause" class="control-btn" title="Pausar/Reanudar">
    <svg id="iconPause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    <svg id="iconPlay" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
  </button>
</div>

<button id="btnTTS" class="fab-secondary" title="Leer en voz alta">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
  </svg>
</button>

 <button id="btnDirectHighlight" class="fab-main" title="Resaltar texto seleccionado">
 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M18.5 2.5l-16 16V22h3.5l16-16-3.5-3.5z"/> <path d="M13.5 7.5l3 3"/> <path d="M2 22h20"/> </svg>
</button>

<div id="deleteTooltip" title="Eliminar subrayado">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
</div>

</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script>
  // Elementos DOM
  const btnHighlight = document.getElementById('btnDirectHighlight');
  const contentArea = document.querySelector('main');
  const deleteTooltip = document.getElementById('deleteTooltip');
  let targetHighlight = null; 


// --- LÓGICA DE TEXT-TO-SPEECH (LECTURA) ---
  
  const btnTTS = document.getElementById('btnTTS');
  const ttsControls = document.getElementById('ttsControls');
  const btnPlayPause = document.getElementById('btnPlayPause');
  const btnStop = document.getElementById('btnStop');
  const iconPlay = document.getElementById('iconPlay');
  const iconPause = document.getElementById('iconPause');

  let synth = window.speechSynthesis;
  let utterance = null;
  let isSpeaking = false;
  let isPaused = false;
  
  // Guardamos el contenido original para restaurarlo al terminar
  let currentElement = null;
  let originalHTML = "";

  // 1. Iniciar Lectura
  btnTTS.addEventListener('click', () => {
    if (isSpeaking) return; // Si ya está activo, no hace nada (usa los controles)
    startReading();
  });

  function startReading() {
    // Buscar párrafos y títulos legibles
    const readableElements = Array.from(contentArea.querySelectorAll('p, h1, h2, h3, li'));
    if (readableElements.length === 0) return;

    // Mostrar controles
    ttsControls.classList.add('active');
    updatePlayPauseIcon(true);
    isSpeaking = true;

    // Comenzar secuencia de lectura
    readQueue(readableElements, 0);
  }

  function readQueue(elements, index) {
    if (!isSpeaking || index >= elements.length) {
      resetTTS();
      return;
    }

    currentElement = elements[index];
    originalHTML = currentElement.innerHTML; // Guardar estado original (importante para tus subrayados amarillos)
    
    const text = currentElement.innerText;
    
    // Preparar las palabras para resaltado visual
    // (Envolvemos cada palabra en un span temporal)
    const words = text.split(' ');
    currentElement.innerHTML = words.map((word, i) => `<span id="word-${i}">${word}</span>`).join(' ');

    // Configurar Voz
    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'es-ES'; // Español
    utterance.rate = 1.0;     // Velocidad normal

    // Evento: Se dispara cada vez que lee una palabra
    utterance.onboundary = (event) => {
      if (event.name === 'word') {
        // Calcular índice aproximado de la palabra basado en el tiempo/caracteres
        // Nota: WebSpeechAPI es imprecisa con índices, usamos una aproximación simple
        const charIndex = event.charIndex;
        // Buscamos qué palabra corresponde a este índice
        let currentLength = 0;
        for (let i = 0; i < words.length; i++) {
          const wLen = words[i].length + 1; // +1 por el espacio
          if (currentLength >= charIndex || (currentLength + wLen) > charIndex) {
            // Limpiar anterior
            const prev = currentElement.querySelector('.reading-word');
            if (prev) prev.classList.remove('reading-word');
            
            // Resaltar actual
            const span = currentElement.querySelector(`#word-${i}`);
            if (span) span.classList.add('reading-word');
            break;
          }
          currentLength += wLen;
        }
      }
    };

    // Evento: Al terminar este párrafo
    utterance.onend = () => {
      if (currentElement) currentElement.innerHTML = originalHTML; // Restaurar HTML limpio
      if (isSpeaking && !isPaused) {
        readQueue(elements, index + 1); // Leer siguiente
      }
    };

    synth.speak(utterance);
  }

  // 2. Controles
  btnStop.addEventListener('click', () => {
    synth.cancel();
    if (currentElement) currentElement.innerHTML = originalHTML; // Restaurar inmediatamente
    resetTTS();
  });

  btnPlayPause.addEventListener('click', () => {
    if (synth.speaking && !synth.paused) {
      synth.pause();
      isPaused = true;
      updatePlayPauseIcon(false);
    } else if (synth.paused) {
      synth.resume();
      isPaused = false;
      updatePlayPauseIcon(true);
    }
  });

  function resetTTS() {
    isSpeaking = false;
    isPaused = false;
    ttsControls.classList.remove('active');
    currentElement = null;
    synth.cancel();
  }

  function updatePlayPauseIcon(isPlaying) {
    if (isPlaying) {
      iconPlay.style.display = 'none';
      iconPause.style.display = 'block';
    } else {
      iconPlay.style.display = 'block';
      iconPause.style.display = 'none';
    }
  }


  btnHighlight.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Vital: Evita que el botón robe el foco al texto
    
    const selection = window.getSelection();
    
    // Si no hay texto seleccionado, salimos
    if (!selection || selection.toString().length === 0) return;

    const range = selection.getRangeAt(0);

    // Validación: Que la selección esté dentro del contenido
    if (!contentArea.contains(range.commonAncestorContainer) && range.commonAncestorContainer !== contentArea) return;

    // Validación: Evitar subrayar sobre otro subrayado
    if (range.cloneContents().querySelector('.user-highlight')) {
       console.warn("Ya existe un subrayado aquí.");
       return;
    }

    // Crear el elemento amarillo
    const span = document.createElement('span');
    span.className = 'user-highlight';

    try {
      range.surroundContents(span);
      selection.removeAllRanges(); // Quitamos la selección azul
    } catch (error) {
      console.warn("No se puede subrayar selecciones complejas (cruzan etiquetas).");
    }
  });


  // --- LÓGICA DE BORRADO ---
  
  function hideDeleteTooltip() {
    deleteTooltip.style.display = 'none';
    targetHighlight = null;
  }

  function showDeleteTooltip(element) {
    targetHighlight = element;
    const rect = element.getBoundingClientRect();
    const scrollX = window.scrollX || window.pageXOffset;
    const scrollY = window.scrollY || window.pageYOffset;
    
    deleteTooltip.style.left = (rect.left + rect.width / 2 + scrollX) + 'px';
    deleteTooltip.style.top = (rect.top + scrollY) + 'px';
    deleteTooltip.style.display = 'block';
  }

  document.addEventListener('mouseup', (e) => {
    // A) Borrar (Clic en tooltip)
    if (deleteTooltip.contains(e.target) && targetHighlight) {
      const parent = targetHighlight.parentNode;
      while (targetHighlight.firstChild) {
        parent.insertBefore(targetHighlight.firstChild, targetHighlight);
      }
      parent.removeChild(targetHighlight);
      hideDeleteTooltip();
      return;
    }

    // B) Mostrar opción borrar (Clic en amarillo)
    if (e.target.classList.contains('user-highlight')) {
      if (window.getSelection().toString().length === 0) {
        showDeleteTooltip(e.target);
        return;
      }
    } 
    
    // C) Ocultar
    hideDeleteTooltip();
  });

  // --- IMÁGENES INTERACTIVAS ---
  const images = document.querySelectorAll('.interactive-img');
  images.forEach(img => {
    img.addEventListener('click', (e) => {
      e.stopPropagation();
      img.classList.toggle('zoomed');
      images.forEach(other => { if(other !== img) other.classList.remove('zoomed'); });
    });
  });
  
  document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('interactive-img')) {
      images.forEach(img => img.classList.remove('zoomed'));
    }
  });
</script>

</body>
</html>
