<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>


<style>
 :root {
  --body-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  --msger-bg: #fff;
  --border: 2px solid #ddd;
  --left-msg-bg: #ececec;
  --right-msg-bg: #579ffb;
}


*,
*:before,
*:after {
  margin: 0;
  padding: 0;
  box-sizing: inherit;
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: Helvetica, sans-serif;
   overflow: hidden;
}



.msger {
  display: flex;
  flex-flow: column wrap;
  justify-content: space-between;
  width: 100%;
  max-width: 507px;
  /*margin: 25px 10px;*/
  /*height: 100%;*/
  height: 100vh;
  border: var(--border);
  border-radius: 5px;
  background: var(--msger-bg);
  box-shadow: 0 15px 15px -5px rgba(0, 0, 0, 0.2);
}

.msger-header {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  border-bottom: var(--border);
  background: #eee; 
  color: #666;
}

.msger-chat {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column-reverse;
}
.msger-chat::-webkit-scrollbar {
  width: 6px;
}
.msger-chat::-webkit-scrollbar-track {
  background: #ddd;
}
.msger-chat::-webkit-scrollbar-thumb {
  background: #bdbdbd;
}
.msg {
  display: flex;
  align-items: flex-end;
  margin-bottom: 10px;
}
.msg:last-of-type {
  margin: 0;
}

.msg-bubble {
  max-width: 270px;
  padding: 15px;
  border-radius: 15px;
  background: var(--left-msg-bg);
}

.msg-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.msg-info-name {
  margin-right: 10px;
  font-weight: bold;
}
.msg-info-time {
  font-size: 0.85em;
}

.left-msg .msg-bubble {
  border-bottom-left-radius: 0;
}

.right-msg {
  flex-direction: row-reverse;
}
.right-msg .msg-bubble {
  background: var(--right-msg-bg);
  color: #fff;
  border-bottom-right-radius: 0;
}
.right-msg .msg-img {
  margin: 0 0 0 10px;
}

.msger-inputarea {
  display: flex;
  padding: 10px;
  border-top: var(--border);
  background: #eee;
}
.msger-inputarea * {
  padding: 10px;
  border: none;
  border-radius: 3px;
  font-size: 1em;
}
.msger-input {
  flex: 1;
  background: #ddd;
  width: 100%;
}
.msger-send-btn {
  margin-left: 10px;
  background: rgb(0, 196, 65);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.23s;
}
.msger-send-btn:hover {
  background: rgb(0, 180, 50);
}

.msger-record-btn {
  margin-left: 10px;
  background: rgb(221, 221, 221);
  color: black;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.23s;
}
.msger-record-btn:hover {
  background: rgb(211,211,211);
}

.img-container {
  margin-top: 15px;
  width: 250px; /* Ancho deseado del contenedor */
  height: 250px; /* Alto deseado del contenedor */
  overflow: hidden; /* Para asegurarse de que la imagen no se desborde */
}

.img-container img {
  width: 100%; /* La imagen ocupará todo el ancho del contenedor */
  height: 100%; /* La imagen ocupará todo el alto del contenedor */
  object-fit: fill; /* La imagen se deforma para ajustarse al contenedor */
}


 .iframe-container {
          margin-top: 15px;
            position: relative;
            overflow: hidden;
            max-width: 100%;
            height: 180px;
        }

        /* Estilo para hacer el iframe responsivo */
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }









 
  


.main-btn{
  border: white;
  background: transparent;
  border-radius: 50%; /* Esto hace que el contorno sea circular */
  cursor: pointer;
  font-size: 20px;
  float: right;
  margin-right: 20px;
}











.showbox {
  display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.loader {
  position: relative;
  margin: 0px auto;
  width: 100px;
}
.loader:before {
  content: "";
  display: block;
  padding-top: 100%;
}

.circular {
  -webkit-animation: rotate 2s linear infinite;
          animation: rotate 2s linear infinite;
  height: 100%;
  transform-origin: center center;
  width: 100%;
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  margin: auto;
}

.path {
  stroke-dasharray: 1, 200;
  stroke-dashoffset: 0;
  -webkit-animation: dash 1.5s ease-in-out infinite, color 6s ease-in-out infinite;
          animation: dash 1.5s ease-in-out infinite, color 6s ease-in-out infinite;
  stroke-linecap: round;
}

@-webkit-keyframes rotate {
  100% {
    transform: rotate(360deg);
  }
}

@keyframes rotate {
  100% {
    transform: rotate(360deg);
  }
}
@-webkit-keyframes dash {
  0% {
    stroke-dasharray: 1, 200;
    stroke-dashoffset: 0;
  }
  50% {
    stroke-dasharray: 89, 200;
    stroke-dashoffset: -35px;
  }
  100% {
    stroke-dasharray: 89, 200;
    stroke-dashoffset: -124px;
  }
}
@keyframes dash {
  0% {
    stroke-dasharray: 1, 200;
    stroke-dashoffset: 0;
  }
  50% {
    stroke-dasharray: 89, 200;
    stroke-dashoffset: -35px;
  }
  100% {
    stroke-dasharray: 89, 200;
    stroke-dashoffset: -124px;
  }
}
@-webkit-keyframes color {
  100%, 0% {
    stroke: #d62d20;
  }
  40% {
    stroke: #0057e7;
  }
  66% {
    stroke: #008744;
  }
  80%, 90% {
    stroke: #ffa700;
  }
}
@keyframes color {
  100%, 0% {
    stroke: #d62d20;
  }
  40% {
    stroke: #0057e7;
  }
  66% {
    stroke: #008744;
  }
  80%, 90% {
    stroke: #ffa700;
  }
}
  
  











.media-menu {
  position: absolute;
  bottom: 60px; /* Justo debajo del botón */
  right: 20px;
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  padding: 10px;
  display: flex;
  flex-wrap: wrap;
}

.media-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.media-item {
  text-align: center;
  cursor: pointer;
  padding: 5px;
}

.media-item i {
  font-size: 24px;
  color: #3a3b3c;
}

.media-item span {
  font-size: 12px;
  color: #3a3b3c;
}

</style>
 

<section class="msger" ng-app="App" ng-controller="msgCtrl">
  <header class="msger-header">
    <div class="msger-header-title">
      <i class="fas fa-comment-alt"></i> Tutor
    </div>
  </header>
    

  
  <main class="msger-chat" >
    <div class="showbox" ng-if="!userDataLoaded">
      <div class="loader">
        <svg class="circular" viewbox="25 25 50 50">
          <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"></circle>
        </svg>
      </div>
    </div>

     <!--- <div class="msg" ng-repeat="message in messages" ng-class="{ 'right-msg': message.sender === 'admin', 'left-msg': message.sender === 'client' }"> --->
     <div class="msg" ng-repeat="message in messages.slice().reverse()" ng-class="{ 'right-msg': message.sender === 'client', 'left-msg': message.sender === 'admin' }">
      <div class="msg-bubble" ng-style="$last && {'margin-bottom': '10px'}">
        <div class="msg-info" >
          <div class="msg-info-name">{{message.name}}</div>
          <div class="msg-info-time">{{message.timestamp}}</div>
        </div>
        <div class="msg-text">
          {{message.content}}
          
          <div class="img-container" ng-if="message.type == 'image'">
          <img ng-src="{{message.url}}">
          </div>
          
          <div  ng-if="message.type == 'audio'">
   <iframe  ng-src="{{trustAsResourceUrl(message.url)}}" frameborder="0" height="50px" width="270px"></iframe>
          </div>
          
      <div class="iframe-container" ng-if="message.type == 'video'">
   <iframe  ng-src="{{trustAsResourceUrl(message.url)}}" frameborder="0" ></iframe>
          </div>
          
        </div>
      </div>
    </div>
    

    
  </main>

  <form class="msger-inputarea">
     <input type="text" class="msger-input" id="msg-input" ng-model="newMessage" placeholder="Ingresa tu mensaje..." ng-keypress="checkEnter($event)"  ng-show="showMessageInput !== false">
    <div class="uploaded-file-name" style="flex: 1" ng-if="showMessageInput === false">
  {{ uploadedFileName }}
</div>
   <div class="msger-record-btn" ng-click="toggleMediaMenu()"> 
  <i class="ri-attachment-2"></i>
</div>
   <div ng-click="sendMsg(newMessage)" class="msger-send-btn" >Enviar</div>
  </form>
  
  
  <div class="media-menu" ng-show="showMediaMenu">
  <div class="media-grid">
    <div class="media-item upload-image" >
      <i class="ri-image-fill"></i>
      <span>Imagen</span>
    </div>
         <input class="imageData" type="file" style="display: none;" accept="image/*"/>
     <div id="imageData" style="display: none;"> </div>
    <div class="media-item" >
      <i class="ri-volume-up-fill"></i>
      <span>Audio</span>
    </div> 
    <div class="media-item" >
      <i class="ri-file-fill"></i>
      <span>Archivo</span>
    </div>
    <div class="media-item" >
      <i class="ri-mic-fill"></i>
      <span>Grabar</span>
    </div>
  </div>
</div>
  
</section>



<script>
 var alertsApp = angular.module('App', []);

alertsApp.controller('msgCtrl', ['$http', '$scope', '$sce', '$timeout', function($http, $scope, $sce, $timeout) {
  $scope.userDataLoaded = false;
  
  function getData(){
var requestData = {
    action: "getBasicData",
    token: "U2FsdGVkX1+/bx4IRUs+4OVF2BXGHKcse6X5vQSs/AdPqn4wm882qjpkDxXz36kp"
  };
 
  var config = {
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    followRedirects: true, 
  }; 

 $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)
    .then(function(response) {
    $scope.userData = response.data;
    $scope.messages = JSON.parse($scope.userData.messages)
    $scope.userDataLoaded = true;
   
   angular.element(document).ready(function() {
    angular.element(".imageData").on('change', function() {
      readURL(this);
    });
    
    angular.element(".upload-image").on('click', function() {
      angular.element(".imageData").click();
    })
  })
   

  })
  
}
  
  getData();

  
 
     function readURL(input) {
      if (input.files && input.files[0]) {
         var file = input.files[0];
        var reader = new FileReader();

        reader.onload = function(e) {
          $scope.$apply(function() {
            $scope.picture = e.target.result;
             $scope.uploadedFileName = '..' + file.name.slice(-14); // Captura el nombre del archivo
        $scope.showMessageInput = false; 
            $scope.showMediaMenu = false
            document.getElementById("imageData").value = e.target.result
           // $scope.uploadImage() 
          });
        };

        reader.readAsDataURL(input.files[0]);
      } 
    };

 

    $scope.uploadImage = function() {
   var imageData = document.getElementById("imageData").value
    alert(imageData);
  };
  
  

 /* $scope.messages = [{"sender":"client","name":"Sergio  A.","type":"audio","url":"https://drive.google.com/file/d/15pb1f15dRfRA3rGRZKrzpiyzKEMjiyUp/preview","content":"","timestamp":"2024-06-19T01:05:01.757Z"},{"sender":"client","name":"Sergio A.","type":"audio","url":"https://drive.google.com/file/d/15pb1f15dRfRA3rGRZKrzpiyzKEMjiyUp/preview","content":"","timestamp":"2024-06-19T01:05:10.908Z"},{"sender":"client","name":"Sergio Abelardo","type":"audio","url":"https://drive.google.com/file/d/15pb1f15dRfRA3rGRZKrzpiyzKEMjiyUp/preview","content":"","timestamp":"2024-06-19T01:10:36.761Z"}];*/
  
  $scope.trustAsResourceUrl = function(url) {
        return $sce.trustAsResourceUrl(url);
    };
  
  
   $scope.uploadAudio = function() { 
     var base64Audio = document.getElementById("AudioData").value
     
    var requestData = {
    action: "postAudio",
    token: "U2FsdGVkX1/nUuDQw51xvgUc1SJbNB7ovqirHxEhFI0Mq6tuxq5e/7jiW0KqEp3D",
      //token: localStorage.getItem('MStoken'),
    blob: base64Audio
  };

  var config = {
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    followRedirects: true, 
  }; 
   $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)
    .then(function(response) {
     getData();
      //$scope.userData = response.data;
    })
   }; 
    
    
    $scope.checkEnter = function(event) {
        if (event.which === 13) { // 13 is the key code for Enter
            $scope.sendMsg($scope.newMessage);
        }
    };
  
  $scope.sendMsg = function(message) {    
    var name = $scope.userData.name.split(" ")
     var chat =  {
    "sender": "client",
    "name": name[0]+" "+name[1],
    "type": "text",
    "content": message, 
    "timestamp": getNow()
  }
     var imgData = document.getElementById("imageData").value 
     if(imgData){
    chat.type = "image"
       chat.url = imgData
       $scope.showMessageInput = true;
        $scope.uploadedFileName = ''
       document.getElementById("imageData").value = ''
  }
    $scope.messages.push(chat)
      $scope.newMessage = ""; 
     var plan = $scope.userData.plan
if(plan.split(" ")[0] == "Premium" || plan.split(" ")[0] == "Hibrido"){
    $scope.sendMsgtoserver(message)
}else{
  var autoresponse =  {
    "sender": "admin",
    "name": "Mozart Studio", 
    "type": "text",
    "content": "Esta función esta solo disponible para el plan Híbrido y el plan PREMIUM. Actualiza tu plan para recibir este beneficio",
    "timestamp": ""
  }
    
   $timeout(function() {
        $scope.messages.push(autoresponse);
    }, 1000);
}
     
};
    
    
    $scope.sendMsgtoserver = function(message){
 var requestData = {
        action: "newMsgChat",
        token: "U2FsdGVkX1/nUuDQw51xvgUc1SJbNB7ovqirHxEhFI0Mq6tuxq5e/7jiW0KqEp3D",
        //token: localStorage.getItem('MStoken'),
        msg: message
    };

    var config = {
        headers: {
            "Content-Type": "text/plain;charset=utf-8"
        }
    };

    $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)
    .then(function(response) {
    });
}
   
  function getNow() {
  var date = new Date();
  
  const d = "0" + date.getDate();
  const m = "0" + (date.getMonth() + 1);
  const y = date.getFullYear().toString().slice(-2);
  const h = "0" + date.getHours();
  const min = "0" + date.getMinutes();

  return `${d.slice(-2)}/${m.slice(-2)}/${y} ${h.slice(-2)}:${min.slice(-2)}`;
}
  
  
  $scope.showMediaMenu = false;

$scope.toggleMediaMenu = function () {
  $scope.showMediaMenu = !$scope.showMediaMenu;
};

$scope.selectMedia = function (type) {
  if (type === 'image') {
    
  } else if (type === 'video') {
    document.getElementById('.imageInput').click();
  } else if (type === 'audio') {
    // Lógica para subir audio
  } else if (type === 'file') {
    // Lógica para subir otros archivos
  }
  $scope.showMediaMenu = false; // Cierra el menú después de seleccionar
};
  
  
  
  
  
$scope.handleImageUpload = function (event) {
  const file = event.target.files[0];

  if (file) {
    const reader = new FileReader();

    reader.onload = function (e) {
      const base64Image = e.target.result;

      // Crear o actualizar el div oculto con el base64
      let hiddenDiv = document.getElementById("hiddenBase64");
      if (!hiddenDiv) {
        hiddenDiv = document.createElement("div");
        hiddenDiv.id = "hiddenBase64";
        hiddenDiv.style.display = "none";
        document.body.appendChild(hiddenDiv);
      }

      hiddenDiv.textContent = base64Image; // Usar textContent
    };

    reader.readAsDataURL(file);
  }
};





  

}]);




 document.addEventListener('DOMContentLoaded', function(e){ 
      var i18n = {};
      messageArea('.message');
    })

$(function() {
  $('#colorselector').change(function(){
    $('.colors').hide();
    $('#' + $(this).val()).show();
  });
});



</script>



