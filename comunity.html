<!DOCTYPE html>
<html ng-app="postApp">
<head>
<link href="https://cdn.jsdelivr.net/npm/beercss@3.9.6/dist/cdn/beer.min.css" rel="stylesheet" />
<script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.9.6/dist/cdn/beer.min.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.58"></script>
<script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/es6/core.js"></script>
<script src="https://cdn.jsdelivr.net/npm/focus-visible@5"></script>
<script src="https://cdn.jsdelivr.net/npm/html-midi-player@1.5.0"></script>

<style>
body {
  background-color: #DAE0E6 !important;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.main-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  display: flex;
  gap: 20px;
}

.sidebar {
  width: 280px;
  flex-shrink: 0;
}

.sidebar-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.sidebar-title {
  font-size: 14px;
  font-weight: 600;
  color: #1c1c1c;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filter-option {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  margin: 4px 0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  color: #1c1c1c;
}

.filter-option:hover {
  background-color: #f6f7f8;
}

.filter-option.active {
  background-color: #0079D3;
  color: white;
  font-weight: 500;
}

.filter-option i {
  margin-right: 10px;
  font-size: 20px;
  width: 24px;
  text-align: center;
}

.feed-container {
  flex: 1;
  min-width: 0;
}

.create-post-card {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 12px;
}

.create-post-card img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.create-post-input {
  flex: 1;
  background: #f6f7f8;
  border: 1px solid #ccc;
  border-radius: 20px;
  padding: 10px 16px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.create-post-input:hover {
  background: #e9ecef;
  border-color: #0079D3;
}

.create-post-actions {
  display: flex;
  gap: 8px;
}

.post-card {
  background: white;
  border-radius: 8px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: box-shadow 0.2s;
  overflow: hidden;
}

.post-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.post-header {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #f6f7f8;
}

.post-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.post-user-info {
  flex: 1;
}

.post-username {
  font-size: 14px;
  font-weight: 600;
  color: #1c1c1c;
  text-decoration: none;
}

.post-username:hover {
  text-decoration: underline;
}

.post-time {
  font-size: 12px;
  color: #7c7c7c;
  margin-top: 2px;
}

.post-content {
  padding: 16px;
}

.post-title {
  font-size: 18px;
  font-weight: 600;
  color: #1c1c1c;
  margin-bottom: 8px;
  line-height: 1.4;
}

.post-text {
  font-size: 14px;
  color: #1c1c1c;
  line-height: 1.6;
  margin-bottom: 12px;
}

.post-image {
  width: 100%;
  max-width: 600px;
  border-radius: 8px;
  margin-top: 12px;
  cursor: pointer;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.post-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-top: 1px solid #f6f7f8;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 4px;
  background: transparent;
  border: none;
  color: #7c7c7c;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.action-btn:hover {
  background-color: #f6f7f8;
}

.action-btn i {
  font-size: 18px;
}

.action-btn.liked {
  color: #FF4500;
}

.save-btn {
  margin-left: auto;
}

.save-btn.saved {
  color: #0079D3;
}

.midi-thumbnail-wrapper {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 8px;
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.2s;
  margin-top: 12px;
   width: 100%;
      max-width: 400px;
}

.midi-thumbnail-wrapper:hover {
  transform: translateY(-2px);
}

.midi-play-btn {
  width: 70px;
  height: 70px;
  background: rgba(255,255,255,0.3);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
}

.midi-play-btn i {
  color: white;
  font-size: 32px;
  margin-left: 4px;
}

.midi-title {
  color: white;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
}

.midi-subtitle {
  color: rgba(255,255,255,0.9);
  font-size: 14px;
}

.poll-container {
  padding: 16px 0;
}

.poll-option {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 8px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  border: 2px solid #edeff1;
  transition: all 0.2s;
}

.poll-option:hover {
  border-color: #0079D3;
  background: #f6f7f8;
}

.poll-option.voted {
  border-color: transparent;
  background: #f6f7f8;
}

.poll-bar {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  background: rgba(0,121,211,0.1);
  transition: width 0.6s ease;
}

.poll-option-content {
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  width: 100%;
  font-size: 14px;
  font-weight: 500;
}

.poll-footer {
  font-size: 12px;
  color: #7c7c7c;
  margin-top: 8px;
  padding: 0 16px;
}

.midi-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.midi-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.midi-modal {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 700px;
  max-height: 90vh;
  overflow: hidden;
  transform: translateY(20px);
  transition: transform 0.3s;
}

.midi-modal-overlay.active .midi-modal {
  transform: translateY(0);
}

.midi-modal-header {
  padding: 20px;
  border-bottom: 1px solid #edeff1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.midi-modal-title {
  font-size: 20px;
  font-weight: 600;
  margin: 0;
}

.midi-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #7c7c7c;
  cursor: pointer;
}

.midi-modal-body {
  padding: 20px;
}

.comments-section {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-top: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.comment-input-wrapper {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.comment-input-wrapper img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.comment-input {
  flex: 1;
  background: #f6f7f8;
  border: 1px solid #ccc;
  border-radius: 20px;
  padding: 10px 16px;
  font-size: 14px;
}

.comment-item {
  display: flex;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid #f6f7f8;
}

.comment-item:last-child {
  border-bottom: none;
}

.comment-item img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.comment-content {
  flex: 1;
}

.comment-author {
  font-size: 13px;
  font-weight: 600;
  color: #1c1c1c;
  margin-bottom: 4px;
}

.comment-text {
  font-size: 14px;
  color: #1c1c1c;
  line-height: 1.5;
}

.load-more-btn {
  width: 100%;
  padding: 12px;
  background: white;
  border: 1px solid #0079D3;
  color: #0079D3;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 16px;
}

.load-more-btn:hover {
  background: #0079D3;
  color: white;
}

@media (max-width: 968px) {
  .sidebar {
    display: none;
  }
  
  .main-container {
    padding: 12px;
  }
}

.loader-wrapper {
  display: flex;
  justify-content: center;
  padding: 60px 20px;
}

.loader {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #0079D3;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

  #mainMidiVisualizer {
      display: flex;
      justify-content: center;
      transform: scale(0.5);
    }

    @media (max-width: 600px) {
      #mainMidiVisualizer {
        transform: scale(0.4);
      }
    }

    @media (max-width: 470px) {
      #mainMidiVisualizer {
        transform: scale(0.3);
      }
    }
</style>
</head>

<body ng-controller="postController">
  <div class="main-container">
    <aside class="sidebar" ng-if="!selectedPostForComments">
      <div class="sidebar-card">
        <div class="sidebar-title">Comunidades</div>
        <div class="filter-option" ng-class="{'active': filter === 'all'}" ng-click="filterPosts('all')">
          <i class="ri-home-4-line"></i>
          <span>Inicio</span>
        </div>
        <div class="filter-option" ng-class="{'active': filter === 'midi'}" ng-click="filterPosts('midi')">
          <i class="ri-music-2-line"></i>
          <span>Composiciones MIDI</span>
        </div>
        <div class="filter-option" ng-class="{'active': filter === 'user'}" ng-click="filterPosts('user')">
          <i class="ri-user-line"></i>
          <span>Mis Publicaciones</span>
        </div>
        <div class="filter-option" ng-class="{'active': filter === 'saved'}" ng-click="filterPosts('saved')">
          <i class="ri-bookmark-line"></i>
          <span>Guardados</span>
        </div>
      </div>

      <div class="sidebar-card">
        <div class="sidebar-title">Acerca de</div>
        <p style="font-size: 13px; color: #7c7c7c; line-height: 1.6; margin: 0;">
          Comunidad dedicada al aprendizaje musical. Comparte tus composiciones, participa en encuestas y conecta con otros músicos.
        </p>
      </div>
    </aside>

    <main class="feed-container">
      <div class="create-post-card" ng-if="!selectedPostForComments">
        <img ng-src="{{userImg}}" />
        <input class="create-post-input" placeholder="Crear una publicación" ng-model="newText2" />
        <div class="create-post-actions">
          <button class="transparent circle" ng-click="openImagePostDialog()">
            <i class="ri-image-line"></i>
          </button>
          <button ng-click="newPost(newText2)">Publicar</button>
        </div>
      </div>

      <div ng-if="selectedPostForComments" style="margin-bottom: 16px;">
        <button class="action-btn" ng-click="backToFeed()">
          <i class="ri-arrow-left-line"></i>
          Volver al feed
        </button>
      </div>

      <div class="loader-wrapper" ng-if="userDataLoaded">
        <div class="loader"></div>
      </div>

      <div ng-if="!selectedPostForComments">
        <div class="post-card" ng-repeat="post in filteredData.slice(0, itemsPerPage)">
          <div class="post-header">
            <img ng-src="{{post.photo}}" />
            <div class="post-user-info">
              <a href="#" class="post-username">{{post.user}}</a>
              <div class="post-time">{{calculateTimeAgo(post.date)}}</div>
            </div>
          </div>

          <div class="post-content">
            <div ng-if="post.type == 'text'">
                 <div class="post-title" ng-if="post.header">{{post.header}}</div>
              <div class="post-text">{{post.url}}</div>
            </div>

            <div ng-if="post.type == 'img'">
              <div class="post-title" ng-if="post.header">{{post.header}}</div>
              <img class="post-image" ng-src="{{post.url}}" ng-click="openComments(post)" />
            </div>

            <div ng-if="post.type == 'midi'">
              <div class="post-title">{{post.header || 'Composición MIDI'}}</div>
                     <div style="display: flex; justify-content: center;">
              <div class="midi-thumbnail-wrapper" ng-click="openMidiModal(post)">
                <div class="midi-play-btn">
                  <i class="ri-play-fill"></i>
                </div>
                <div class="midi-title">{{post.header}}</div>
                <div class="midi-subtitle">Haz clic para reproducir</div>
              </div>
              </div>
            </div>

            <div ng-if="post.type == 'poll'">
              <div class="post-title">{{post.url}}</div>
              <div class="poll-container">
                <div class="poll-option" ng-repeat="opt in post.likes" ng-click="addVote(post, opt, $index)" ng-class="{'voted': post.userHasVoted}">
                  <div class="poll-bar" ng-if="post.userHasVoted" ng-style="{'width': calculatePercentage(post, opt) + '%'}"></div>
                  <div class="poll-option-content">
                    <span>{{opt.name}} <i ng-if="opt.votedByCurrentUser" class="ri-checkbox-circle-fill"></i></span>
                    <span ng-if="post.userHasVoted">{{calculatePercentage(post, opt)}}%</span>
                  </div>
                </div>
                <div class="poll-footer" ng-if="post.userHasVoted">
                  {{getTotalVotes(post)}} votos totales
                </div>
              </div>
            </div>
          </div>

          <div class="post-actions" ng-if="post.type != 'poll'">
            <button class="action-btn" ng-class="{'liked': isPostLiked(post)}" ng-click="newLike($index, post)">
              <i ng-class="isPostLiked(post) ? 'ri-heart-fill' : 'ri-heart-line'"></i>
              <span>{{post.likes.length}}</span>
            </button>
            <button class="action-btn" ng-click="openComments(post)">
              <i class="ri-chat-3-line"></i>
              <span>{{post.comments.length}}</span>
            </button>
            <button class="action-btn save-btn" ng-class="{'saved': isPostSaved(post)}" ng-click="toggleSave(post)">
              <i ng-class="isPostSaved(post) ? 'ri-bookmark-fill' : 'ri-bookmark-line'"></i>
              <span>{{isPostSaved(post) ? 'Guardado' : 'Guardar'}}</span>
            </button>
          </div>
        </div>

        <button class="load-more-btn" ng-click="loadMorePosts()" ng-if="itemsPerPage < filteredData.length">
          Cargar más publicaciones
        </button>
      </div>

      <div ng-if="selectedPostForComments">
        <div class="post-card">
          <div class="post-header">
            <img ng-src="{{selectedPostForComments.photo}}" />
            <div class="post-user-info">
              <a href="#" class="post-username">{{selectedPostForComments.user}}</a>
              <div class="post-time">{{calculateTimeAgo(selectedPostForComments.date)}}</div>
            </div>
          </div>

          <div class="post-content">
            <div ng-if="selectedPostForComments.type == 'text'">
              <div class="post-text">{{selectedPostForComments.url}}</div>
            </div>

            <div ng-if="selectedPostForComments.type == 'img'">
              <div class="post-title" ng-if="selectedPostForComments.header">{{selectedPostForComments.header}}</div>
              <img class="post-image" ng-src="{{selectedPostForComments.url}}" />
            </div>

            <div ng-if="selectedPostForComments.type == 'midi'">
              <div class="post-title">{{selectedPostForComments.header || 'Composición MIDI'}}</div>
              <div class="midi-thumbnail-wrapper" ng-click="openMidiModal(selectedPostForComments)">
                <div class="midi-play-btn">
                  <i class="ri-play-fill"></i>
                </div>
                <div class="midi-title">{{selectedPostForComments.header}}</div>
                <div class="midi-subtitle">Haz clic para reproducir</div>
              </div>
            </div>
          </div>

          <div class="post-actions">
            <button class="action-btn" ng-class="{'liked': isPostLiked(selectedPostForComments)}" ng-click="newLike(0, selectedPostForComments)">
              <i ng-class="isPostLiked(selectedPostForComments) ? 'ri-heart-fill' : 'ri-heart-line'"></i>
              <span>{{selectedPostForComments.likes.length}}</span>
            </button>
            <button class="action-btn save-btn" ng-class="{'saved': isPostSaved(selectedPostForComments)}" ng-click="toggleSave(selectedPostForComments)">
              <i ng-class="isPostSaved(selectedPostForComments) ? 'ri-bookmark-fill' : 'ri-bookmark-line'"></i>
              <span>{{isPostSaved(selectedPostForComments) ? 'Guardado' : 'Guardar'}}</span>
            </button>
          </div>
        </div>

        <div class="comments-section">
          <div class="comment-input-wrapper">
            <img ng-src="{{userImg}}" />
            <input type="text" class="comment-input" placeholder="Añadir un comentario..." ng-model="newCommentText" />
            <button ng-click="addComment(newCommentText)">Comentar</button>
          </div>

          <div ng-if="selectedPostForComments.comments.length > 0">
            <div class="comment-item" ng-repeat="comment in selectedPostForComments.comments">
              <img ng-src="{{comment.photo}}" />
              <div class="comment-content">
                <div class="comment-author">{{comment.user}}</div>
                <div class="comment-text">{{comment.comment}}</div>
              </div>
            </div>
          </div>

          <div ng-if="selectedPostForComments.comments.length === 0" style="text-align: center; color: #7c7c7c; padding: 20px;">
            Aún no hay comentarios. ¡Sé el primero en comentar!
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="midi-modal-overlay" ng-class="{'active': midiModalOpen}" ng-click="closeMidiModal()">
    <div class="midi-modal" ng-click="$event.stopPropagation()">
      <div class="midi-modal-header">
        <div>
          <h4 class="midi-modal-title">{{currentMidi.header || 'Reproductor MIDI'}}</h4>
          <div class="post-time">Por {{currentMidi.user}}</div>
        </div>
        <button class="midi-modal-close" ng-click="closeMidiModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="midi-modal-body">
        <midi-player id="mainMidiPlayer" sound-font visualizer="#mainMidiVisualizer"></midi-player>
        <div style="height: 200px; margin-top: 20px;">
          <midi-visualizer id="mainMidiVisualizer" type="waterfall"></midi-visualizer>
        </div>
      </div>
    </div>
  </div>

  <dialog id="dialog-post">
    <div style="padding: 20px; width: 500px; max-width: 90vw;">
      <h5>Crear publicación con imagen</h5>
      <div style="margin: 20px 0;">
        <textarea ng-model="newImagePost.header" placeholder="Añade un título o descripción..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; min-height: 100px;"></textarea>
      </div>
      <img ng-if="imagePreview" ng-src="{{imagePreview}}" style="width: 100%; border-radius: 8px; margin-bottom: 16px;" />
      <input type="file" id="imageUpload" accept="image/*" onchange="angular.element(this).scope().handleFileSelect(this.files)" style="display: none;">
      <button onclick="document.getElementById('imageUpload').click()" style="width: 100%; margin-bottom: 12px;">
        <i class="ri-image-add-line"></i> Seleccionar imagen
      </button>
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button onclick="ui('#dialog-post')">Cancelar</button>
        <button ng-click="createImagePost()" ng-disabled="!imagePreview || !newImagePost.header">Publicar</button>
      </div>
    </div>
  </dialog>

<script>
var app = angular.module('postApp', []);
app.controller('postController', ['$scope', '$http', '$timeout', function ($scope, $http, $timeout) {
  $scope.userDataLoaded = true;
  $scope.data = [];
  $scope.filteredData = [];
  $scope.itemsPerPage = 6;
  $scope.filter = 'all';
  $scope.user = "Anónimo";
  $scope.userImg = "https://lh3.googleusercontent.com/d/1h0PAuatp8mguH19cso6wh19mjMVa0K5V";

  var config = {
    headers: { "Content-Type": "text/plain;charset=utf-8" }
  };

  $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', 
    {action: "getPosts"}, config)
    .then(function (response) {
      $scope.data = shuffleArray(response.data);
      $scope.filterPosts('all');
      $scope.userDataLoaded = false;
      $scope.data.forEach(post => {
        if (post.type === 'poll') {
          post.userHasVoted = post.likes.some(opt => opt.users.includes($scope.user));
        }
      });
    });

  $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', 
    {action: "getUserData", token: localStorage.getItem('MStoken')}, config)
    .then(function (response) {
      $scope.user = response.data.name.split(' ').slice(0, 2).join(' ');
      $scope.userImg = response.data.photo;
    });

  function shuffleArray(array) {
    const shuffled = array.slice();
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }

  $scope.filterPosts = function (type) {
    $scope.filter = type;
    if (type === 'all') {
      $scope.filteredData = $scope.data;
    } else if (type === 'user') {
      $scope.filteredData = $scope.data.filter(post => post.user === $scope.user);
    } else if (type === 'saved') {
      $scope.filteredData = $scope.data.filter(post => $scope.isPostSaved(post));
    } else {
      $scope.filteredData = $scope.data.filter(post => post.type === type);
    }
    $scope.itemsPerPage = 6;
  };

  $scope.loadMorePosts = function () {
    $scope.itemsPerPage += 5;
  };

  $scope.selectedPostForComments = null;

  $scope.openComments = function (post) {
    $scope.selectedPostForComments = post;
    window.scrollTo(0, 0);
  };

  $scope.backToFeed = function () {
    $scope.selectedPostForComments = null;
  };

  $scope.addComment = function (commentText) {
    if (!$scope.selectedPostForComments || !commentText) return;

    var newComment = {
      user: $scope.user,
      photo: $scope.userImg,
      comment: commentText
    };

    if (!$scope.selectedPostForComments.comments) {
      $scope.selectedPostForComments.comments = [];
    }
    $scope.selectedPostForComments.comments.push(newComment);
    $scope.newCommentText = '';
  };

  $scope.calculatePercentage = function (post, option) {
    const totalVotes = post.likes.reduce((sum, opt) => sum + opt.users.length, 0);
    if (totalVotes === 0) return 0;
    return Math.round((option.users.length / totalVotes) * 100);
  };

  $scope.getTotalVotes = function (post) {
    return post.likes.reduce((sum, opt) => sum + opt.users.length, 0);
  };

  $scope.addVote = function (post, option, index) {
    if (post.userHasVoted) return;
    option.users.push($scope.user);
    option.votedByCurrentUser = true;
    post.userHasVoted = true;
  };

  $scope.currentMidi = null;
  $scope.midiModalOpen = false;

  $scope.openMidiModal = function (post) {
    $scope.currentMidi = post;
    $scope.midiModalOpen = true;
    $timeout(function () {
      const player = document.getElementById('mainMidiPlayer');
      const visualizer = document.getElementById('mainMidiVisualizer');
      if (player && visualizer) {
        player.setAttribute('src', post.url);
        visualizer.setAttribute('src', post.url);
      }
    }, 100);
  };

  $scope.closeMidiModal = function () {
    const player = document.getElementById('mainMidiPlayer');
    if (player && player.player) {
      player.player.stop();
    }
    $scope.midiModalOpen = false;
    $scope.currentMidi = null;
  };

  $scope.newPost = function (data) {
    if (!data) return;
    var post = {
      user: $scope.user,
      type: "text",
      photo: $scope.userImg,
      url: data,
      date: new Date(),
      likes: [],
      comments: [],
      saved: []
    };
    $scope.data.unshift(post);
    $scope.filterPosts($scope.filter);
    $scope.newText2 = "";
  };

  $scope.newLike = function (index, post) {
    if (!post.likes) post.likes = [];
    const userLikeIndex = post.likes.findIndex(like => like.user === $scope.user);
    if (userLikeIndex === -1) {
      post.likes.push({ user: $scope.user });
    } else {
      post.likes.splice(userLikeIndex, 1);
    }
  };

  $scope.isPostLiked = function(post) {
    if (!post || !post.likes) return false;
    return post.likes.some(like => like.user === $scope.user);
  };

  $scope.isPostSaved = function(post) {
    if (!post.saved) return false;
    return post.saved.some(s => s.user === $scope.user);
  };

  $scope.toggleSave = function(post) {
    if (!post.saved) post.saved = [];
    const userIndex = post.saved.findIndex(s => s.user === $scope.user);
    if (userIndex === -1) {
      post.saved.push({ user: $scope.user });
    } else {
      post.saved.splice(userIndex, 1);
    }
  };

  $scope.calculateTimeAgo = function (alertDate) {
    const alertDateObj = new Date(alertDate);
    const today = new Date();
    const timeDiff = Math.abs(today - alertDateObj);
    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
    if (days > 0) return `hace ${days} día(s)`;
    if (hours > 0) return `hace ${hours} hora(s)`;
    return `hace ${minutes} minuto(s)`;
  };

  $scope.newImagePost = { header: '' };
  $scope.imagePreview = null;

  $scope.openImagePostDialog = function() {
    $scope.newImagePost = { header: '' };
    $scope.imagePreview = null;
    document.getElementById('imageUpload').value = null;
    ui('#dialog-post');
  };

  $scope.handleFileSelect = function(files) {
    if (files && files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        $scope.$apply(function() {
          $scope.imagePreview = e.target.result;
        });
      };
      reader.readAsDataURL(files[0]);
    }
  };

  $scope.createImagePost = function() {
    if (!$scope.imagePreview || !$scope.newImagePost.header) {
      alert("Por favor, selecciona una imagen y añade una descripción.");
      return;
    }

    var post = {
      user: $scope.user,
      type: "img",
      photo: $scope.userImg,
      header: $scope.newImagePost.header,
      url: $scope.imagePreview,
      date: new Date().toISOString(),
      likes: [],
      comments: [{
        user: $scope.user,
        photo: $scope.userImg,
        comment: $scope.newImagePost.header
      }],
      saved: []
    };

    $scope.data.unshift(post);
    $scope.filterPosts($scope.filter || 'all');
    ui('#dialog-post');
  };
}]);
</script>
</body>
</html>
