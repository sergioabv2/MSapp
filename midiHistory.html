
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Recorder & Visualizer</title>
    <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.77,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            min-width: 120px;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        #midiData {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            font-family: monospace;
        }
        midi-visualizer {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .hidden {
            display: none;
        }
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tempo-control label {
            font-weight: bold;
        }
        .tempo-control input {
            width: 60px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>MIDI Recorder & Visualizer</h1>
    
    <div id="status" class="disconnected">No MIDI device connected</div>
    
    <div class="controls">
        <button id="recordBtn">Record</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="playBtn" disabled>Play Sequence</button>
        <button id="clearBtn" disabled>Clear</button>
        <div class="tempo-control">
            <label for="tempoInput">Tempo:</label>
            <input type="number" id="tempoInput" value="120" min="40" max="300">
            <span>BPM</span>
        </div>
    </div>
    
    <textarea id="midiData" readonly placeholder="MIDI data will appear here..."></textarea>
    
    <midi-visualizer type="waterfall" id="visualizer" class="hidden"></midi-visualizer>
    <midi-player id="player" sound-font visualizer="#visualizer" class="hidden"></midi-player>
    
    <script>
        // Global variables
        let midiAccess;
        let midiInput;
        let isRecording = false;
        let recordedEvents = [];
        let startTime;
        let midiBase64 = '';
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const clearBtn = document.getElementById('clearBtn');
        const midiDataEl = document.getElementById('midiData');
        const visualizer = document.getElementById('visualizer');
        const player = document.getElementById('player');
        const tempoInput = document.getElementById('tempoInput');
        
        // Initialize MIDI access
        async function initMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess();
                updateMIDIStatus();
                
                midiAccess.onstatechange = updateMIDIStatus;
                
                // Set up event listeners
                recordBtn.addEventListener('click', startRecording);
                stopBtn.addEventListener('click', stopRecording);
                playBtn.addEventListener('click', playSequence);
                clearBtn.addEventListener('click', clearRecording);
                tempoInput.addEventListener('change', updateTempo);
                
            } catch (error) {
                statusEl.textContent = 'MIDI access denied or not supported: ' + error.message;
                console.error('MIDI initialization error:', error);
            }
        }
        
        // Update MIDI connection status
        function updateMIDIStatus() {
            const inputs = midiAccess.inputs.values();
            let hasInput = false;
            
            // Clear previous input
            if (midiInput) {
                midiInput.onmidimessage = null;
            }
            
            // Find first available input
            for (const input of inputs) {
                if (!hasInput) {
                    midiInput = input;
                    midiInput.onmidimessage = handleMIDIMessage;
                    hasInput = true;
                }
            }
            
            if (hasInput) {
                statusEl.textContent = `Connected to: ${midiInput.name}`;
                statusEl.className = 'status connected';
                recordBtn.disabled = false;
            } else {
                statusEl.textContent = 'No MIDI device connected';
                statusEl.className = 'status disconnected';
                recordBtn.disabled = true;
            }
        }
        
        // Handle incoming MIDI messages
        function handleMIDIMessage(event) {
            if (!isRecording) return;
            
            const [command, note, velocity] = event.data;
            const timestamp = Date.now() - startTime;
            
            // Filter only Note On (0x90-0x9F) and Note Off (0x80-0x8F) messages
            const commandType = command & 0xF0; // Mask channel bits
            
            if ((commandType === 0x90 || commandType === 0x80) && note !== undefined) {
                // Record the event with timestamp
                recordedEvents.push({
                    data: event.data,
                    timestamp: timestamp
                });
                
                // Display raw data in textarea
                const noteType = (commandType === 0x90 && velocity > 0) ? 'Note On' : 'Note Off';
                midiDataEl.value += `Time: ${timestamp}ms | ${noteType} | Note: ${note} | Velocity: ${velocity}\n`;
                midiDataEl.scrollTop = midiDataEl.scrollHeight;
            }
        }
        
        // Update playback tempo
        function updateTempo() {
            const tempo = parseInt(tempoInput.value);
            if (tempo >= 40 && tempo <= 300) {
                player.tempo = tempo + 'bpm';
            } else {
                tempoInput.value = 120; // Reset to default if invalid
                player.tempo = '120bpm';
            }
        }
        
        // Start recording
        function startRecording() {
            if (isRecording) return;
            
            recordedEvents = [];
            midiBase64 = '';
            midiDataEl.value = 'Recording started...\n';
            isRecording = true;
            startTime = Date.now();
            
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            playBtn.disabled = true;
            clearBtn.disabled = true;
            
            // Hide visualizer
            visualizer.classList.add('hidden');
            player.classList.add('hidden');
        }
        
        // Stop recording
        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            midiDataEl.value += 'Recording stopped.\n';
            
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            clearBtn.disabled = false;
            
            // Convert recorded events to MIDI file and encode as Base64
            if (recordedEvents.length > 0) {
                const midiFile = createSimpleMIDIFile(recordedEvents);
                midiBase64 = arrayBufferToBase64(midiFile);
                playBtn.disabled = false;
            }
        }
        
        // Play the recorded sequence
        function playSequence() {
            if (!midiBase64) return;
            
            // Create data URL from Base64
            const midiUrl = 'data:audio/midi;base64,' + midiBase64;
            
            // Set the player source and tempo
            player.src = midiUrl;
            updateTempo(); // Apply current tempo setting
            
            // Show the visualizer and player
            visualizer.classList.remove('hidden');
            player.classList.remove('hidden');
            
            // Start playback
            player.start();
        }
        
        // [Resto de las funciones (createSimpleMIDIFile, toVariableLengthQuantity, etc.) permanecen igual]
        // ... (Mantén todas las otras funciones igual que en el código anterior)
        
        // Initialize when page loads
        window.addEventListener('load', initMIDI);
    </script>
</body>
</html>
