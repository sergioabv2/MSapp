<!DOCTYPE html>
<html lang="es" ng-app="pianoApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Quest Pro</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <link rel="stylesheet" href="styles.css">
</head>

    <style>
        /* Variables CSS */
:root {
    --bg-color: #f0f2f5;
    --main-content-bg: #ffffff;
    --text-color: #333333;
    --sidebar-bg: #f5f5f5;
    --sidebar-text: #212529;
    --header-bg: #212529;
    --header-text: #ffffff;
    --lesson-header-bg: #f8f9fa;
    --lesson-header-hover: #e2e6ea;
    --primary-accent: #6f42c1;
    --success-green: #28a745;
    --danger-red: #dc3545;
    --modal-bg: rgba(0,0,0,0.5);
    --modal-content-bg: #ffffff;
    --medium-gray: #adb5bd;
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text-color);
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    height: 100vh;
    overflow: hidden;
    transition: background-color 0.3s, color 0.3s;
}

#levelSelector, #pianoApp {
    height: 100%;
}

/* ========== SELECTOR DE NIVELES ========== */
#levelSelector {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 100px;
    padding: 120px 0 0 0;
    position: relative;
    z-index: 2;
}

.level-container {
    display: grid;
    grid-template-columns: 230px 1fr;
    gap: 15px;
    max-width: 1200px;
    width: 100%;
    padding: 20px;
    position: relative;
    /* ESTA ES LA CLAVE: Empujamos el contenido hacia abajo para revelar el banner */
    padding-top: 160px; 
    padding-bottom: 60px;
    z-index: 2;
}

.level-header {
    background: var(--sidebar-bg);
    color: var(--sidebar-text);
    padding: 40px 30px;
    text-align: center;
}

.level-header h1 { 
    font-size: 2.2rem; 
    margin-bottom: 12px; 
}

.level-header p { 
    font-size: 1.1rem; 
    opacity: 0.9; 
}

.levels-grid {
    display: grid;
    grid-template-columns: 1fr; 
    padding: 10px 20px;
    gap: 20px;
}

/* Tarjetas de nivel */
.level-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e5e7;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.level-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
}

.level-card.locked {
    opacity: 0.6;
    cursor: auto;
    filter: grayscale(80%);
}

.level-card.locked:hover {
    transform: none;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.card-content {
    display: flex;
    align-items: flex-start;
    gap: 20px;
}

.level-number {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #8B5CF6, #A855F7);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
}

.level-info {
    flex: 1;
    min-width: 0;
}

.level-title {
    font-size: 24px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 8px;
}

.level-description {
    color: #6e6e73;
    font-size: 16px;
    line-height: 1.5;
    margin-bottom: 16px;
}

.level-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.time-icon {
    width: 16px;
    height: 16px;
    opacity: 0.6;
}

.time-text {
    color: #8B5CF6;
    font-size: 14px;
    font-weight: 500;
}

.progress-container2 {
    width: 190px;
    height: 12px;
    background: #f0f0f0;
    border-radius: 2px;
    overflow: hidden;
    position: relative;
}

.progress-bar2 {
    height: 100%;
    background: linear-gradient(90deg, #8B5CF6, #A855F7);
    border-radius: 2px;
    width: 0%;
    transition: width 0.5s ease-out;
}

.lockLvlIco {
    position: absolute;
    font-size: 20px;
    right: 15px;
    top: 15px;
}

/* ========== APP DE PIANO ========== */
#pianoApp { 
    display: flex; 
    flex-direction: column; 
}

.app-header { 
    display: none; 
}

.app-container { 
    display: flex; 
    flex: 1; 
    overflow: hidden; 
}

.menu-toggle-btn { 
    display: none; 
    position: fixed; 
    top: 10px; 
    left: 15px; 
    background: var(--sidebar-bg); 
    color: var(--sidebar-text); 
    border: none; 
    font-size: 1.5rem; 
    cursor: pointer; 
    z-index: 1002; 
    width: 45px; 
    height: 45px; 
    border-radius: 50%; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
}

/* ========== SIDEBAR REDISEÑADO ========== */
.sidebar { 
    width: 380px; 
    background-color: #ffffff;
    color: var(--sidebar-text); 
    display: flex; 
    flex-direction: column; 
    padding: 25px; 
    flex-shrink: 0; 
    border-left: 1px solid #dee2e6; 
    box-shadow: -2px 0 8px rgba(0,0,0,0.05); 
}



.main-content { 
    flex-grow: 1; 
    background-color: #f5f5f5;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    height: 100%;
}

.video-wrapper {
    width: 100%;
    min-height: calc(100vh - 0px); /* Altura completa visible */
    background-color: #000000;
    flex-shrink: 0;
    position: sticky;
    top: 0;
}

#youtube-container,
#content-iframe { 
    width: 100%; 
    height: 100%;
    border: none;
}

.content-below {
    background-color: #ffffff;
    padding: 30px;
    min-height: 80vh;
}

.content-below h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 20px;
}

.content-below p {
    color: #6e6e73;
    line-height: 1.6;
    margin-bottom: 15px;
}


.lesson-description {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.lesson-description h3 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 12px;
}

/* Sección de objetivos */
.lesson-objectives {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.lesson-objectives h3 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 15px;
}

.lesson-objectives ul {
    list-style: none;
    padding: 0;
}

.lesson-objectives li {
    padding: 10px 0;
    padding-left: 30px;
    position: relative;
    color: #4b5563;
}

.lesson-objectives li::before {
    content: '✓';
    position: absolute;
    left: 0;
    color: #8B5CF6;
    font-weight: bold;
    font-size: 1.2rem;
}

/* Notas importantes */
.lesson-notes {
    background: #fff8e1;
    border-left: 4px solid #ffc107;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 20px;
}

.lesson-notes h4 {
    color: #f57c00;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.lesson-notes p {
    color: #5d4037;
    margin: 0;
}

.main-content::-webkit-scrollbar {
    width: 8px;
}

.main-content::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.main-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.main-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* ========== USER PROFILE REDISEÑADO ========== */
.user-profile { 
    display: flex; 
    align-items: center; 
    margin-top: 10px;
    margin-bottom: 20px; 
    padding-bottom: 10px; 
}

.user-avatar { 
    width: 48px; 
    height: 48px; 
    border-radius: 12px; 
    background: linear-gradient(135deg, #8B5CF6, #A855F7); 
    color: white; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 1.5rem; 
    font-weight: 700; 
    margin-right: 15px; 
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); 
}

.user-info .name { 
    font-size: 1rem; 
    font-weight: 600; 
    color: #1d1d1f; 
    margin-bottom: 4px; 
}

.user-info .plan { 
    font-size: 0.75rem; 
    color: #6e6e73; 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
}

/* ========== PROGRESS BAR REDISEÑADO ========== */
.progress-bar { 
    width: 100%; 
    height: 20px; 
    background-color: #e9ecef; 
    border-radius: 10px; 
    overflow: hidden; 
    margin-bottom: 25px; 
}

.progress-fill { 
    height: 100%; 
    background: linear-gradient(90deg, #8B5CF6, #A855F7); 
    width: 0%; 
    transition: width 0.5s ease-in-out; 
    border-radius: 10px; 
}

/* ========== LESSONS CONTAINER REDISEÑADO ========== */
.lessons-container { 
    flex-grow: 1; 
    overflow-y: auto; 
    padding-right: 8px; 
    border-top: 1px solid #e9ecef; 
}

.lessons-container::-webkit-scrollbar { 
    width: 6px; 
}

.lessons-container::-webkit-scrollbar-track { 
    background: transparent; 
}

.lessons-container::-webkit-scrollbar-thumb { 
    background: #d1d5db; 
    border-radius: 10px; 
}

.lessons-container::-webkit-scrollbar-thumb:hover { 
    background: #9ca3af; 
}

/* ========== LESSON HEADER REDISEÑADO ========== */
/* Agregar chevron y línea divisora a lesson-header */
.lesson-header {
    display: flex;
    align-items: center;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 14px 12px;
    background-color: transparent;
    border-radius: 8px;
    margin-bottom: 4px;
    transition: background-color 0.2s;
    color: #1d1d1f;
    border-bottom: 1px solid #D3D3D3; 
    position: relative; 
}

/* Agregar chevron con ::after */
.lesson-header::after {
    content: '\EA4E'; 
    font-family: 'remixicon';
    margin-left: auto;
    font-size: 1.2rem;
    color: #9ca3af;
    transition: transform 0.3s ease;
}

/* Rotar chevron cuando está expandido */
.lesson-header.expanded::after {
    transform: rotate(180deg);
}

/* Ajustar el span del título para que no empuje el chevron */
.lesson-header span {
    flex: 1;
}

.lesson-header.unlocked { 
    cursor: pointer; 
}

.lesson-header.unlocked:hover { 
    background-color: #f5f5f7; 
}



.lesson-header .icon { 
    font-size: 1.1rem; 
    margin-right: 12px; 
    opacity: 0.6; 
}

/* ========== TASKS LIST REDISEÑADO ========== */
.tasks-list { 
    list-style: none; 
    padding-left: 8px; 
    max-height: 0; 
    overflow: hidden; 
    transition: max-height 0.4s ease-out; 
    margin-bottom: 8px; 
}

.tasks-list.expanded { 
    max-height: 500px; 
}

.task-item { 
    display: flex; 
    align-items: center; 
    padding: 10px 12px; 
    font-size: 0.85rem; 
    opacity: 0.7; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: all 0.2s; 
    margin-bottom: 2px; 
}

.task-item:hover { 
    background-color: #f5f5f7; 
    opacity: 1; 
}

.task-item.is-viewing { 
    background-color: rgba(139, 92, 246, 0.08); 
}

.task-item.active { 
    opacity: 1; 
    font-weight: 600; 
    background-color: rgba(139, 92, 246, 0.15); 
    border-left: 3px solid #8B5CF6; 
    padding-left: 10px; 
}

.task-item.completed { 
    opacity: 1; 
}

.task-item.completed .task-title { 
    text-decoration: line-through; 
    color: #6e6e73; 
}

.task-item.task-locked {
    opacity: 0.5;
    cursor: default; 
}

/* Quitar cualquier efecto hover que tengas en tareas bloqueadas */
.task-item.task-locked:hover {
    background-color: transparent; 
    color: inherit; 
}

.task-status { 
    width: 16px; 
    height: 16px; 
    border-radius: 50%; 
    border: 2px solid #d1d5db; 
    margin-right: 10px; 
    flex-shrink: 0; 
}

.task-item.active .task-status { 
    border-color: #8B5CF6; 
    background-color: #8B5CF6; 
}

.task-item.completed .task-status { 
    background-color: var(--success-green); 
    border-color: var(--success-green); 
    position: relative; 
}

.task-item.completed .task-status::after { 
    content: '✓'; 
    position: absolute; 
    color: white; 
    font-size: 10px; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
}

.task-interaction-icon { 
    cursor: pointer; 
    margin-left: auto; 
    font-size: 1.5rem; 
    z-index: 2; 
}

/* ========== UNIT SEPARATOR REDISEÑADO ========== */
.unit-separator {
    font-weight: 700;
    color: #1d1d1f;
    padding: 12px 12px 8px;
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 1.2px;
    background-color: transparent;
    margin-top: 16px;
    margin-bottom: 8px;
}

.unit-separator:first-child {
    margin-top: 0;
}



.player-header {
    margin-top: -10px;
    padding: 12px 10px;
    background: #ffffff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
    flex-wrap: wrap;
}

#back-to-levels-btn {
    background: #f5f5f7;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-weight: 500;
    color: #1d1d1f;
    transition: background 0.2s;
}

#back-to-levels-btn:hover {
    background: #e5e5e7;
}

/* ========== MODALES REDISEÑADOS ========== */
.modal-overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: var(--modal-bg); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 1010; 
}

/* MODAL PARA VIDEO (dentro del contenedor) */
.video-modal-overlay { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.85); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 100; 
    backdrop-filter: blur(4px); 
}

.modal-content { 
    background: var(--modal-content-bg); 
    padding: 20px; 
    border-radius: 8px; 
    width: 90%; 
    max-width: 640px; 
    text-align: center; 
}

.video-modal-content { 
    background: white; 
    padding: 32px; 
    border-radius: 16px; 
    max-width: 400px; 
    text-align: center; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
}

.video-modal-content h2 { 
    margin: 0 0 16px 0; 
    font-size: 1.5rem; 
}

.video-modal-content p { 
    margin: 0 0 24px 0; 
    color: #6e6e73; 
    line-height: 1.6; 
}

.video-modal-content .modal-button { 
    width: 100%; 
    padding: 14px 24px; 
    font-size: 1rem; 
    border-radius: 10px; 
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.video-modal-content .modal-button:hover {
    transform: scale(1.02);
}

#audio-playback { 
    width: 100%; 
    margin: 15px 0; 
}

.modal-buttons { 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    margin-top: 15px; 
}

.modal-button { 
    padding: 10px 20px; 
    border: none; 
    border-radius: 5px; 
    background-color: var(--primary-accent); 
    color: white; 
    font-size: 1rem; 
    cursor: pointer; 
}

.modal-button.delete { 
    background-color: var(--danger-red); 
}


.confetti { 
    position: fixed; 
    width: 10px; 
    height: 10px; 
    opacity: 0; 
    animation: confetti-fall 5s ease-out forwards; 
}

@keyframes confetti-fall { 
    0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 
    100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } 
}

/* ========== BANNER ========== */
.banner-header {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 240px; /* REDUCIDO: De 450px a 300px */
    overflow: hidden;
    will-change: transform, opacity;
    z-index: 1;
}

.banner-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.85); /* Un poco oscuro para resaltar texto */
}


.banner-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.6) 100%);
}

.banner-text {
    position: absolute;
    top: 50%; /* Subimos un poco el texto */
    left: 6%;
    transform: translateY(-50%);
    z-index: 5;
    color: white;
    text-shadow: 0 2px 20px rgba(0,0,0,0.6);
}

.banner-text h1 {
    font-size: 42px;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 8px;
}

.banner-text .subtitle {
    font-size: 12px; /* REDUCIDO */
    color: rgba(255,255,255,0.8);
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.banner-text p {
    font-size: 1rem;
    max-width: 450px;
    display: none; /* OPCIONAL: Ocultar descripción en móviles o si queda muy apretado */
}



.pending-tasks {
    background-color: var(--main-content-bg);
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    height: fit-content;
}

.pending-tasks h4 {
    margin-bottom: 15px;
    font-size: 1rem;
    color: var(--text-color);
}

.pending-tasks ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.pending-tasks li {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

/* Estilos para tareas completadas en pending-tasks */
.pending-tasks li.completed {
    opacity: 0.5;
}

.pending-tasks li.completed .task-info .info {
    text-decoration: line-through;
    color: #9ca3af;
}

.pending-tasks li.completed .task-icon {
    color: #28a745;
}

.pending-tasks li.completed .task-icon i::before {
    content: '\EB7B'; /* Código de check-line de Remix Icon */
}

/* Animación sutil cuando se completa */
.pending-tasks li.completed {
    transition: all 0.3s ease;
}

.task-icon {
    font-size: 1.5rem;
    color: var(--primary-accent);
    margin-right: 15px;
}

.task-info span {
    display: block;
    font-size: 0.8rem;
    color: #6c757d;
}

.task-info .info {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-color);
    text-decoration: none;
}

.view-all-tasks {
    display: block;
    margin-top: 10px;
    text-align: right;
    font-size: 0.9rem;
    color: var(--primary-accent);
    text-decoration: none;
    font-weight: 600;
}


/* Wrapper para apilar la barra lateral verticalmente */
.sidebar-wrapper {
    display: flex;
    flex-direction: column;
    gap: 20px; /* Espacio entre los cuadros */
}

/* Reutilizamos estilos base de pending-tasks para mantener consistencia */
.practice-card {
    background-color: var(--main-content-bg);
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    height: fit-content;
}

.practice-card h4 {
    margin-bottom: 10px;
    font-size: 1rem;
    color: var(--text-color);
}

.practice-card p {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 15px;
    line-height: 1.4;
}

/* Botón Vistoso */
.btn-shiny {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #8B5CF6 0%, #6366f1 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-shiny:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    filter: brightness(110%);
}

.btn-shiny i {
    font-size: 1.2rem;
}

/* ACTUALIZACIÓN RESPONSIVE: Aseguramos que el wrapper se oculte en móviles */
@media (max-width: 900px) {
    .sidebar-wrapper {
        display: none;
    }
}

/* ========== QUIZ ========== */
.quiz-options { 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    margin: 20px 0; 
}

.quiz-option { 
    padding: 12px; 
    border: 1px solid var(--medium-gray); 
    color: var(--text-color); 
    background-color: transparent; 
    border-radius: 5px; 
    cursor: pointer; 
    transition: background-color 0.2s;
}

.quiz-option:hover { 
    background-color: var(--lesson-header-hover); 
}

.sidebar-overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.5); 
    z-index: 1000; 
    opacity: 0; 
    visibility: hidden; 
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; 
}

.sidebar-overlay.is-active { 
    opacity: 1; 
    visibility: visible; 
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
    
    .pending-tasks {
        display: none; 
    }

    .level-container {
        grid-template-columns: 1fr;
        gap: 0;
        padding: 10px;
        padding-top: 160px; 
    }
}

@media (max-width: 800px) {
  
    .levels-grid { 
        grid-template-columns: 1fr; 
        padding: 30px 20px; 
    }
    
    .level-header { 
        padding: 30px 20px; 
    }
    
    .level-header h1 { 
        font-size: 1.8rem; 
    }
    
    .app-header {
        display: flex; 
        align-items: center; 
        justify-content: center;
        padding: 0 15px; 
        height: 45px;
        position: fixed; 
        top: 0; 
        width: 100%; 
        z-index: 999;
        background-color: var(--header-bg);
    }
    
    .menu-toggle-btn { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        top: 50px; 
        left: 15px; 
        right: auto; 
    }
    
    .sidebar { 
        position: fixed; 
        top: 0; 
        right: 0; 
        height: 100%; 
        width: 300px; 
        max-width: 80%; 
        z-index: 1001; 
        transform: translateX(100%); 
        transition: transform 0.3s ease-in-out; 
        border-left: 1px solid var(--lesson-header-bg); 
        border-right: none; 
    }
    
    .sidebar.is-open { 
        transform: translateX(0); 
    }

    .video-wrapper {
        height: 300px;
        min-height: 300px;
    }
    
    .content-below {
        padding: 20px 15px;
    }
}

@media (max-width: 550px) { 
    .level-card {
        transform: scale(0.9);
    }
    
    .level-description {
        font-size: 13px;
    }
    
    .level-title {
        font-size: 22px;
    }
    
    .level-card:hover {
        transform: scale(0.92);
    }

  

    .levels-grid {
        padding: 10px 10px;
        gap: 2px;
    }
    
    .mobile {
        display: none;
    }
    
    .player-header {
        justify-content: space-between;
    }
    .banner-text h1 { font-size: 2rem; }
    .banner-text .subtitle { font-size: 1.25rem; }
    .floating-header { padding: 15px; }
}


/* ========== LOADER DE CARGA (Estilo Level-Card) ========== */
.loader-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* Un fondo más sutil para que la tarjeta blanca resalte */
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}


.loader-content {
    background: white;
    border-radius: 16px; /* de .level-card */
    padding: 32px 40px; /* Un poco más de padding que una tarjeta normal */
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12); /* Sombra de .level-card:hover */
    border: 1px solid #e5e5e7; /* de .level-card */
    display: flex;
    flex-direction: column; /* Para apilar el icono y el texto */
    align-items: center;
    max-width: 350px;
    width: 90%;
}


.loader-content i {
    font-size: 3.5rem;
    margin-bottom: 16px;
    display: inline-block;
    color: var(--primary-accent, #6f42c1);
}

.loader-content p {
    font-size: 1.5rem; /* similar a .level-title */
    font-weight: 600; /* similar a .level-title */
    color: #1d1d1f; /* similar a .level-title */
    margin: 0;
}

.blur-content {
    pointer-events: none;
}

@keyframes ri-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.ri-spin {
    animation: ri-spin 1s linear infinite;
}
    </style>
<body ng-controller="PianoController">

    <div class="banner-header" ng-show="currentView === 'levelSelector'">
    <img src="https://lh3.googleusercontent.com/d/172NBqADTbyzw-YGNQNjWDSxL2FoJoxN0" class="banner-image">
    
    <div class="banner-overlay"></div>
    
    <div class="banner-text">
        <h1>
            <span class="subtitle">Tu Camino Musical</span>
            Classroom
        </h1>
        <p>
            Domina el piano paso a paso con nuestro método estructurado.
            Desde lo básico hasta nivel avanzado.
        </p>
    </div>


    
    
</div>
    
    <div id="levelSelector" ng-show="currentView === 'levelSelector'">
        <div class="level-container">



<div class="sidebar-wrapper">

<div class="pending-tasks" >
    <h4>Tareas Pendientes</h4>
    <ul ng-if="pendingTasks.length > 0">
        <li ng-repeat="task in pendingTasks" ng-class="{'completed': task.completed}">
            <div class="task-icon"><i class="{{task.iconClass}}"></i></div>
            <div class="task-info">
                <span>{{task.lessonTitle}}</span>
                <div class="info">{{task.taskTitle}}</div>
            </div>
        </li>
    </ul>
    <div ng-if="pendingTasks.length === 0" style="text-align: center; color: #6e6e73; padding: 20px;">
        <i class="ri-checkbox-circle-line" style="font-size: 2rem; color: #28a745;"></i>
        <p style="margin-top: 10px;">¡No tienes tareas pendientes!</p>
    </div>
</div>


<div class="practice-card">
            <h4>Práctica libre</h4>
            <p>Explora el teclado sin límites o practica tus canciones favoritas.</p>
            <button class="btn-shiny" onclick="window.location.href='https://www.mozart-app.com/bookfinder'">
                <i class="ri-piano-line"></i> Empezar
            </button>
        </div>

</div>
      
      <div class="loader-overlay" ng-show="isLoading">
        <div class="loader-content">
            <i class="ri-loader-4-line ri-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>
            <div class="levels-grid" ng-class="{'blur-content': isLoading}">
                <div class="level-card" ng-repeat="level in levels" 
                    ng-click="selectLevel(level)"
                    ng-class="{'selected': selectedLevel.id === level.id, 'locked': currentLevelIndex < level.id}">
                    <div class="card-content">
                        <div class="lockLvlIco" ng-if="currentLevelIndex < level.id"><i class="ri-lock-fill"></i></div>
                        <div class="level-number" ng-if="level.id === 0">P</div>
                        <div class="level-number" ng-if="level.id !== 0">{{level.id}}</div>
                        <div class="level-info">
                            <h2 class="level-title">{{level.title}}</h2>
                            <p class="level-description">{{level.description}}</p>
                            <div class="level-meta">
                                <svg class="time-icon" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                </svg>
                                <span class="time-text">~{{level.duration}}</span>
                            </div>
                            <div class="progress-container2">
                                <div class="progress-bar2" style="width: {{level.progress}}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="pianoApp" ng-show="currentView === 'app'">
        <button id="menu-toggle" class="menu-toggle-btn" ng-click="toggleSidebar()"><i class="ri-menu-line"></i></button>
        
        <div class="app-container">

            <main class="main-content">
                <div id="youtube-container" style="display: none; width: 100%; height: 100%; position: relative;">
                    <div id="player"></div>
                    
                    <!-- Modal de Pausa dentro del contenedor de video -->
                    <div id="pauseModal" class="video-modal-overlay">
                        <div class="video-modal-content">
                            <h2 style="color: #f59e0b;">¡Atención!</h2>
                            <p>Debes terminar de ver el video para poder avanzar. Por favor, reanuda el video.</p>
                            <button id="closePauseButton" class="modal-button" style="background-color: #f59e0b; color: white; border: none;">
                                Cerrar y Reanudar
                            </button>
                        </div>
                    </div>

                    <!-- Modal de Video Terminado dentro del contenedor de video -->
                    <div id="finishedModal" class="video-modal-overlay">
                        <div class="video-modal-content">
                            <h2 style="color: #10b981;">¡Video Terminado!</h2>
                            <p>Has completado el video. ¡Ahora puedes continuar con la siguiente actividad!</p>
                            <button id="continueVideoButton" class="modal-button" style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; border: none;">Continuar</button>
                        </div>
                    </div>
                </div>
                
                <iframe id="content-iframe" ng-src="{{ currentTaskUrl | trustAsResourceUrl }}" 
                        title="Contenido principal" ng-show="!showingVideo"></iframe>

                        <!-- Contenido debajo del video dinámico -->
<div class="content-below" ng-if="currentViewingTask">
    
    <div class="lesson-description">
        <h3>Sobre esta actividad</h3>
        <p>{{currentViewingTask.title}}</p>
    </div>
    
    <div class="lesson-notes" ng-if="currentViewingTask.instructions">
        <h4>
            <i class="ri-video-line" ng-if="currentViewingTask.type === 'video'"></i>
            <i class="ri-pencil-ruler-2-line" ng-if="currentViewingTask.type === 'exercise'"></i>
            <i class="ri-question-line" ng-if="currentViewingTask.type === 'quiz'"></i>
            Instrucciones
        </h4>
        <p>{{currentViewingTask.instructions}}</p>
    </div>
    
    <div class="lesson-notes" style="background: #e6f7ff; border-left-color: #17a2b8;" ng-if="currentViewingTask.tip">
        <h4><i class="ri-flashlight-line"></i> Consejo</h4>
        <p>{{currentViewingTask.tip}}</p>
    </div>

    <div class="lesson-objectives" ng-if="currentViewingTask.objective && currentViewingTask.objective.length > 0">
        <h3>Objetivos de la actividad</h3>
        <ul>
            <li ng-repeat="obj in currentViewingTask.objective">{{obj}}</li>
        </ul>
    </div>
</div>
            </main>

            <aside class="sidebar" ng-class="{'is-open': sidebarOpen}">

                <div class="player-header">
                    <button class="tool-btn" id="back-to-levels-btn" ng-click="showLevelSelector()">
                        <i class="ri-arrow-left-line"></i> Volver
                    </button>
                </div>

                <div class="user-profile">
                    <div class="user-avatar" ng-if="selectedLevel.id === 0">P</div>
                    <div class="user-avatar" ng-if="selectedLevel.id !== 0">{{selectedLevel.id}}</div>
                    
                    <div class="user-info">
                        <div class="name">{{selectedLevel.title}}</div>
                        <div class="plan">Unidad {{lessons[currentLessonIndex].unit || ''}}</div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{progress}}%;"></div>
                </div>
                
                <div class="lessons-container">

                    <div class="unit-separator" 
                         ng-repeat-start="lesson in lessons" 
                         ng-if="$index === 0 || lessons[$index - 1].unit !== lesson.unit">
                        Unidad {{lesson.unit}}
                    </div>
                                 
                    <div class="lesson-item" ng-repeat-end data-lesson-index="{{$index}}">
                        <div class="lesson-header" 
                              ng-class="{
                                    'completed': lesson.completed, 
                                    'unlocked': $index === 0 || lessons[$index - 1].completed,
                                    'locked': $index > 0 && !lessons[$index - 1].completed,
                                    'expanded': lesson.expanded
                                 }"
                             ng-click="toggleLesson(lesson)">
                            <i class="icon" 
                       ng-class="{
                           'ri-check-line': lesson.completed,
                           'ri-lock-fill': !lesson.completed && $index > 0 && !lessons[$index - 1].completed
                       }"
                       ng-style="{'color': lesson.completed ? 'var(--success-green)' : 'inherit'}">
                    </i>
                            <span>{{lesson.title}}</span>
                        </div>
                        <ul class="tasks-list" ng-class="{'expanded': lesson.expanded}">
                            <li class="task-item" 
                                ng-repeat="task in lesson.tasks" 
                                ng-click="viewTask($parent.$index, $index)"
                                ng-class="{
                                    'completed': task.completed,
                                    'active': currentLessonIndex === $parent.$index && currentTaskIndex === $index,
                                    'is-viewing': viewingLessonIndex === $parent.$index && viewingTaskIndex === $index,
                                    'task-locked': ($parent.$index > currentLessonIndex) || ($parent.$index === currentLessonIndex && $index > currentTaskIndex)
                                }">
                                <div class="task-status"></div>
                                <span class="task-title">{{task.title}}</span>
                                <i class="task-interaction-icon {{task.iconClass}}" ng-if="task.iconClass" ng-click="handleTaskInteraction($event, $parent.$index, $index)"></i>
                            </li>
                        </ul>
                    </div>
                </div>
            </aside>
        </div>
        
        <div class="modal-overlay" id="modalOverlay" ng-style="{'display': modal.show ? 'flex' : 'none'}">
            <div class="modal-content" id="modalContent" ng-bind-html="modal.content"></div>
        </div>
        
        <div class="sidebar-overlay" id="sidebarOverlay" ng-class="{'is-active': sidebarOpen}" ng-click="toggleSidebar()"></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="app.js"></script>

</body>

    <script>
        const app = angular.module('pianoApp', []);

// Filtro de seguridad para poder usar URLs dinámicas en ng-src
app.filter('trustAsResourceUrl', ['$sce', function($sce) {
    return function(val) {
        return $sce.trustAsResourceUrl(val);
    };
}]);

app.controller('PianoController', function($scope, $http, $sce, $timeout) {


    $scope.currentView = 'levelSelector';
    
    $scope.levels = [
        { 
            id: 0, 
            title: 'Nivel Preparatorio', 
            description: 'Empieza desde cero. Aprenderás la postura, las notas y tus primeras melodías simples.', 
            duration: '5 horas',
            progress: 0,
            lessons: [
                {
      title: "Lección 1: Fundamentos",
      unit: 1,
      description: "En esta lección aprenderás el concepto de rítmo y métrica, como usar un metrónomo, la posición de las manos y la posición de Do.",
      tasks: [
        { 
          type: 'video', 
          title: "Ritmo y Posición de Do", 
          videoId: "Q4r5gnfAtzs", 
          iconClass: 'ri-play-circle-line', 
          instructions: "Mira este video con mucha atención. Aprenderás los fundamentos del ritmo y cómo encontrar la posición de Do en el piano.", 
          tip: "No te saltes partes. Puedes pausar y tomar notas si lo necesitas.", 
          objective: ["Comprender el concepto de ritmo y métrica", "Aprender a localizar la posición de Do", "Tocar tus primeras notas"] 
        },
        { 
          type: 'exercise', 
          title: "Ode to Joy - var1", 
          contentUrl: "https://drive.google.com/file/d/13I13Ec1sCqw8TNVQ98wSuGuSeJS6EEAr/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica esta primera variación de Ode to Joy usando la posición de Do que acabas de aprender.",
          tip: "Comienza muy lento. Es mejor tocar despacio y correcto que rápido con errores.",
          objective: ["Aplicar la posición de Do en una melodía conocida", "Desarrollar coordinación básica", "Mantener un tempo constante"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios en Posición de Do", 
          contentUrl: "https://drive.google.com/file/d/1s5bZw8XCq5cHPcDgOniZSqwpmc6xcKYG/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Completa estos ejercicios diseñados para fortalecer tu técnica en la posición de Do.",
          tip: "Presta atención a la digitación sugerida. Los números indican qué dedo usar.",
          objective: ["Fortalecer la memoria muscular en posición de Do", "Mejorar la precisión de las notas", "Practicar cambios de dedo suaves"]
        },
        { 
          type: 'video', 
          title: "Melodía y Armonía", 
          videoId: "bVWXlV8Neic", 
          iconClass: 'ri-play-circle-line',
          instructions: "Observa cómo la melodía y la armonía trabajan juntas para crear música completa.",
          tip: "Identifica cuál mano toca la melodía y cuál toca el acompañamiento.",
          objective: ["Distinguir entre melodía y armonía", "Comprender el rol de cada mano", "Prepararte para tocar con ambas manos simultáneamente"]
        },
        { 
          type: 'exercise', 
          title: "Ode to Joy - var2", 
          contentUrl: "https://drive.google.com/file/d/1ijz--ytWa1WkdnngZW3sO6ukzAKCphZt/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Toca esta segunda variación que incorpora armonía básica con la mano izquierda.",
          tip: "Practica cada mano por separado primero, luego júntalas lentamente.",
          objective: ["Coordinar ambas manos tocando juntas", "Aplicar conceptos de melodía y armonía", "Desarrollar independencia entre las manos"]
        },
        { 
          type: 'quiz', 
          title: "Quiz de Review", 
          contentUrl: "https://mozart-app.com/lessons/quiz", 
          iconClass: 'ri-question-line',
          instructions: "Responde estas preguntas para verificar tu comprensión de los conceptos fundamentales.",
          tip: "Si fallas alguna pregunta, revisa el contenido correspondiente antes de continuar.",
          objective: ["Evaluar tu comprensión de ritmo y métrica", "Verificar conocimiento de la posición de Do", "Reforzar conceptos de melodía y armonía"]
        }
      ]
    },
    {
      title: "Lección 2: Grand Staff",
      unit: 1,
      description: "En esta lección aprenderás la postura correcta, la posición de las manos y tus primeras notas en el piano.",
      tasks: [
        { 
          type: 'video', 
          title: "El Grand Staff", 
          videoId: "HHF95sBbmwQ", 
          iconClass: 'ri-play-circle-line',
          instructions: "Aprende a leer el pentagrama completo con las claves de Sol y Fa juntas.",
          tip: "Memoriza que la clave de Sol es para la mano derecha y la clave de Fa para la izquierda.",
          objective: ["Comprender la estructura del Grand Staff", "Identificar notas en ambas claves", "Relacionar el pentagrama con las teclas del piano"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1Ys_fybQsMIjS4zaCRLO9lV8qsvmvooXq/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica la lectura de notas en el Grand Staff con estos ejercicios progresivos.",
          tip: "Di el nombre de cada nota en voz alta antes de tocarla para reforzar el aprendizaje.",
          objective: ["Mejorar la lectura a primera vista", "Reconocer rápidamente notas en ambas claves", "Desarrollar fluidez en la lectura musical"]
        },
        { 
          type: 'exercise', 
          title: "Ode to Joy - var3", 
          contentUrl: "https://www.mozart-app.com/xml2?file=Ode to Joy.musicxml", 
          iconClass: 'ri-file-music-line',
          instructions: "Interpreta esta variación leyendo directamente del Grand Staff completo.",
          tip: "Usa el reproductor interactivo para escuchar cómo debe sonar antes de practicar.",
          objective: ["Aplicar lectura del Grand Staff en una pieza musical", "Integrar conocimientos previos", "Ganar confianza en la lectura de partituras"]
        }
      ]
    },
    {
      title: "Lección 3: Dirección",
      unit: 1,
      tasks: [
        { 
          type: 'video', 
          title: "Intervalos de 2da y 3era", 
          videoId: "H4x0TPlSoaQ", 
          iconClass: 'ri-play-circle-line',
          instructions: "Descubre cómo se mueven las notas por pasos (2das) y saltos pequeños (3eras) en el teclado.",
          tip: "Los intervalos son la distancia entre dos notas. Practica identificarlos visualmente en el pentagrama.",
          objective: ["Reconocer intervalos de 2da y 3era", "Comprender el movimiento melódico", "Tocar intervalos con precisión"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1Dom_0ZjNoslBKZpUa3IUDN8XMzcxZ1Jd/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Completa estos ejercicios para dominar el reconocimiento y ejecución de intervalos de 2da y 3era.",
          tip: "Observa la dirección del movimiento: ¿la nota sube o baja? Esto te ayudará a anticipar.",
          objective: ["Practicar intervalos ascendentes y descendentes", "Mejorar la lectura direccional", "Desarrollar anticipación visual"]
        }
      ]
    },
    {
      title: "Lección 4: Intervalos",
      unit: 1,
      tasks: [
        { 
          type: 'video', 
          title: "Intervalos de 4ta y 5ta", 
          videoId: "M6DCHr2wVh8", 
          iconClass: 'ri-play-circle-line',
          instructions: "Explora intervalos más grandes que crean sonidos característicos en la música.",
          tip: "Las 5tas suenan muy estables y potentes. Las 4tas tienen un sonido abierto y brillante.",
          objective: ["Identificar intervalos de 4ta y 5ta", "Comprender sus cualidades sonoras", "Tocar saltos más amplios con precisión"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1G3Cun9yL_xl8ZJUhDJE5CAYTXMQUCIZY/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica estos ejercicios que combinan todos los intervalos aprendidos hasta ahora.",
          tip: "Los saltos grandes requieren preparación visual. Mira con anticipación dónde irán tus dedos.",
          objective: ["Dominar intervalos de 4ta y 5ta", "Combinar diferentes tipos de intervalos", "Mejorar la precisión en saltos"]
        },
        { 
          type: 'exercise', 
          title: "Teoría", 
          contentUrl: "https://drive.google.com/file/d/1PmVBq1jbKZyFOK3T-CWDNhZ7Tba428Lr/preview", 
          iconClass: 'ri-question-line',
          instructions: "Refuerza tu comprensión teórica de los intervalos con estos ejercicios escritos.",
          tip: "Entender la teoría te ayudará a aprender piezas más rápido en el futuro.",
          objective: ["Consolidar conocimiento teórico de intervalos", "Identificar intervalos en partituras", "Conectar teoría con práctica"]
        }
      ]
    },
    {
      title: "Lección 5: Frases",
      unit: 2,
      tasks: [
        { 
          type: 'video', 
          title: "Construcción de Frases", 
          videoId: "RJnwVQHexW0", 
          iconClass: 'ri-play-circle-line',
          instructions: "Aprende cómo las notas se agrupan en frases musicales, similar a las oraciones en el lenguaje.",
          tip: "Las frases musicales tienen un inicio, desarrollo y final. Respira entre frases como al hablar.",
          objective: ["Comprender el concepto de frase musical", "Identificar frases en partituras", "Tocar con expresión natural"]
        },
        { 
          type: 'exercise', 
          title: "Práctica de Frases", 
          contentUrl: "https://mozart-app.com/lessons/text", 
          iconClass: 'ri-file-text-line',
          instructions: "Trabaja estos ejercicios prestando atención especial a la forma de las frases.",
          tip: "Levanta ligeramente las manos al final de cada frase para crear separación natural.",
          objective: ["Aplicar fraseo en ejercicios prácticos", "Desarrollar sensibilidad musical", "Crear interpretaciones más expresivas"]
        },
        { 
          type: 'quiz', 
          title: "Quiz de Review", 
          contentUrl: "https://mozart-app.com/lessons/quiz", 
          iconClass: 'ri-question-line',
          instructions: "Responde estas preguntas para verificar tu comprensión de los conceptos fundamentales.",
          tip: "Si fallas alguna pregunta, revisa el contenido correspondiente antes de continuar.",
          objective: ["Evaluar tu comprensión de ritmo y métrica", "Verificar conocimiento de la posición de Do", "Reforzar conceptos de melodía y armonía"]
        },
        { 
          type: 'exercise', 
          title: "Práctica de Frases", 
          contentUrl: "https://drive.google.com/file/d/1gum-qE-LUdxxRNmjh39A1xImbqYRABAX/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Trabaja estos ejercicios prestando atención especial a la forma de las frases.",
          tip: "Levanta ligeramente las manos al final de cada frase para crear separación natural.",
          objective: ["Aplicar fraseo en ejercicios prácticos", "Desarrollar sensibilidad musical", "Crear interpretaciones más expresivas"]
        },
        { 
          type: 'exercise', 
          title: "Run Away River", 
          contentUrl: "https://www.mozart-app.com/xml2?file=Run Away River.musicxml", 
          iconClass: 'ri-file-music-line',
          instructions: "Interpreta esta pieza aplicando todo lo aprendido sobre frases musicales.",
          tip: "Imagina que estás contando una historia. Cada frase es parte de la narrativa.",
          objective: ["Ejecutar una pieza completa con buen fraseo", "Demostrar comprensión musical", "Expresar musicalidad personal"]
        }
      ]
    },
    {
      title: "Lección 6: Acordes",
      unit: 2,
      tasks: [
        { 
          type: 'video', 
          title: "Construcción de Acordes", 
          videoId: "Y2MokfVUSqs", 
          iconClass: 'ri-play-circle-line',
          instructions: "Descubre cómo se construyen los acordes a partir de intervalos apilados.",
          tip: "Un acorde es simplemente tres o más notas tocadas simultáneamente. Comienza identificando la nota base.",
          objective: ["Comprender la estructura de los acordes", "Identificar las notas que forman un acorde", "Preparar las manos para tocar acordes"]
        },
        { 
          type: 'video', 
          title: "Acorde C y G7", 
          videoId: "n7qaCP5a-Pc", 
          iconClass: 'ri-play-circle-line',
          instructions: "Aprende a formar y tocar los acordes de Do mayor y Sol séptima, fundamentales en muchas piezas.",
          tip: "Memoriza la forma de estos acordes. Son los más usados en música para principiantes.",
          objective: ["Dominar los acordes de C y G7", "Cambiar entre acordes suavemente", "Comprender su función armónica"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1UtQsQYtjkYxqbVnCGfTmNa85xtnhG3W7/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica cambios de acordes y patrones de acompañamiento con estos ejercicios.",
          tip: "Mantén los dedos curvados y toca todas las notas del acorde al mismo tiempo.",
          objective: ["Ejecutar acordes con claridad", "Desarrollar fuerza en los dedos", "Practicar transiciones entre acordes"]
        },
        { 
          type: 'exercise', 
          title: "Trumpet Voluntary", 
          contentUrl: "https://www.mozart-app.com/xml2?file=Trumpet Voluntary.musicxml", 
          iconClass: 'ri-file-music-line',
          instructions: "Interpreta esta pieza clásica que incorpora los acordes que has aprendido.",
          tip: "La mano derecha lleva la melodía principal. Asegúrate de que suene más fuerte que los acordes.",
          objective: ["Combinar melodía y acordes en una interpretación", "Aplicar balance dinámico", "Ejecutar una pieza de repertorio clásico"]
        }
      ]
    },
    {
      title: "Lección 7: Corcheas y Staccato",
      unit: 2,
      tasks: [
        { 
          type: 'video', 
          title: "Corcheas", 
          videoId: "LJIBynkI1Cs", 
          iconClass: 'ri-play-circle-line',
          instructions: "Aprende a tocar corcheas, las notas que duran la mitad de un tiempo.",
          tip: "Las corcheas se cuentan '1-y-2-y-3-y-4-y'. Practica contando en voz alta.",
          objective: ["Comprender el valor rítmico de las corcheas", "Tocar ritmos con corcheas", "Mantener pulso constante en ritmos más rápidos"]
        },
        { 
          type: 'video', 
          title: "Staccato", 
          videoId: "5zX6CFXf6cQ", 
          iconClass: 'ri-play-circle-line',
          instructions: "Descubre el staccato, una técnica que crea notas cortas y separadas.",
          tip: "Staccato significa 'picado'. Imagina que tocas una estufa caliente - rápido y ligero.",
          objective: ["Ejecutar la articulación staccato correctamente", "Distinguir entre legato y staccato", "Añadir variedad expresiva a tu interpretación"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1DquyL0GuDR3zojHcmzBLPZaA598DMLbu/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica corcheas y staccato con estos ejercicios diseñados específicamente para estas técnicas.",
          tip: "Alterna entre tocar legato y staccato para sentir la diferencia en tu cuerpo.",
          objective: ["Dominar ritmos con corcheas", "Perfeccionar la técnica staccato", "Combinar diferentes articulaciones"]
        },
        { 
          type: 'exercise', 
          title: "Old German Dance", 
          contentUrl: "https://www.mozart-app.com/xml2?file=old-german-dance-michael-praetorius.musicxml", 
          iconClass: 'ri-file-music-line',
          instructions: "Interpreta esta danza alemana que utiliza corcheas y staccato para crear un carácter alegre.",
          tip: "Esta pieza debe sonar juguetona y ligera. Deja que tu muñeca esté relajada.",
          objective: ["Aplicar corcheas en contexto musical", "Usar staccato expresivamente", "Interpretar música del periodo renacentista"]
        }
      ]
    },
    {
      title: "Lección 8: Posición de Do",
      unit: 3,
      tasks: [
        { 
          type: 'video', 
          title: "Posición de Do II", 
          videoId: "KopYT505jHA", 
          iconClass: 'ri-play-circle-line',
          instructions: "Expande tu conocimiento de la posición de Do explorando diferentes octavas y variaciones.",
          tip: "La posición de Do puede empezar en diferentes lugares del teclado. El patrón es siempre el mismo.",
          objective: ["Reconocer la posición de Do en diferentes octavas", "Trasladar posiciones fluidamente", "Ampliar tu rango en el teclado"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1uuu7dX6SRoOIi1aqzTEJ1xj8CbfW6Uft/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Trabaja estos ejercicios que te llevan por diferentes posiciones de Do en el teclado.",
          tip: "Mantén la forma de la mano constante cuando cambies de posición.",
          objective: ["Practicar cambios de posición", "Desarrollar orientación en el teclado", "Fortalecer técnica en múltiples registros"]
        },
        { 
          type: 'video', 
          title: "Marcas de Tempo y Dinámicas", 
          videoId: "fOHFGsq-cGw", 
          iconClass: 'ri-play-circle-line',
          instructions: "Aprende a interpretar las indicaciones de velocidad y volumen en las partituras.",
          tip: "Términos como 'forte' (fuerte) y 'piano' (suave) son en italiano. Son universales en la música.",
          objective: ["Comprender términos de tempo comunes", "Reconocer símbolos dinámicos", "Aplicar variaciones de velocidad y volumen"]
        },
        { 
          type: 'exercise', 
          title: "Waltz", 
          contentUrl: "https://www.mozart-app.com/xml2?file=waltz-carl-czerny.musicxml", 
          iconClass: 'ri-file-music-line',
          instructions: "Interpreta este vals aplicando todas las indicaciones de tempo y dinámicas.",
          tip: "Un vals tiene ritmo de 3/4. El primer tiempo debe sentirse más fuerte que el 2 y 3.",
          objective: ["Ejecutar un vals con estilo apropiado", "Aplicar indicaciones de interpretación", "Desarrollar sensibilidad musical avanzada"]
        }
      ]
    },
    {
      title: "Lección 9: Posición de Sol",
      unit: 3,
      tasks: [
        { 
          type: 'video', 
          title: "Posición de Sol", 
          videoId: "jGM_qOcewYg", 
          iconClass: 'ri-play-circle-line',
          instructions: "Aprende una nueva posición fundamental: la posición de Sol, que expande tus posibilidades melódicas.",
          tip: "En posición de Sol, tu pulgar derecho empieza en la nota Sol. Encuentra todas las teclas Sol primero.",
          objective: ["Dominar la posición de Sol", "Comparar con la posición de Do", "Tocar en nuevas tonalidades"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/1CfqcsxDsyCwxo8ZhhOrejiiJcgyEzxCE/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica estos ejercicios específicos para familiarizarte con la posición de Sol.",
          tip: "Compara la sensación de esta posición con la de Do. Nota las similitudes y diferencias.",
          objective: ["Establecer memoria muscular en posición de Sol", "Practicar digitación correcta", "Ganar confianza en la nueva posición"]
        },
        { 
          type: 'exercise', 
          title: "Bagpipe", 
          contentUrl: "https://drive.google.com/file/d/16hYD36HcMS-WRqzR9pBvSLHCxifOTkWc/preview", 
          iconClass: 'ri-file-music-line',
          instructions: "Toca esta pieza que imita el sonido de la gaita, usando la posición de Sol.",
          tip: "Las gaitas tienen un sonido constante y mantenido. Toca con articulación suave y fluida.",
          objective: ["Aplicar posición de Sol en repertorio", "Crear carácter específico en la interpretación", "Desarrollar control de sonido sostenido"]
        }
      ]
    },
    {
      title: "Lección 10: Ligaduras",
      unit: 3,
      tasks: [
        { 
          type: 'video', 
          title: "Ligadura de prolongación", 
          videoId: "edjG-czdX2Y", 
          iconClass: 'ri-play-circle-line',
          instructions: "Descubre cómo las ligaduras conectan notas para extender su duración.",
          tip: "Una ligadura une dos notas de la misma altura. Solo tocas la primera, pero mantienes el sonido.",
          objective: ["Comprender el concepto de ligadura", "Identificar ligaduras en partituras", "Ejecutar ritmos sincopados correctamente"]
        },
        { 
          type: 'exercise', 
          title: "Ejercicios", 
          contentUrl: "https://drive.google.com/file/d/16dc7Bkc7KtoP95hA1Tcni_i4M7eDfNLf/preview", 
          iconClass: 'ri-todo-line',
          instructions: "Practica con ejercicios que incluyen ligaduras en diferentes contextos rítmicos.",
          tip: "Cuenta en voz alta y mantén el dedo presionado durante toda la duración combinada.",
          objective: ["Ejecutar ligaduras correctamente", "Desarrollar precisión rítmica avanzada", "Mantener pulso constante con ritmos complejos"]
        },
        { 
          type: 'exercise', 
          title: "Sonatina", 
          contentUrl: "https://www.mozart-app.com/xml2?file=sonatina.musicxml", 
          iconClass: 'ri-file-music-line',
          instructions: "Interpreta esta sonatina que incorpora todas las técnicas aprendidas, incluyendo ligaduras.",
          tip: "Una sonatina es una 'pequeña sonata'. Tócala con elegancia y atención al detalle.",
          objective: ["Integrar todas las técnicas aprendidas", "Interpretar una pieza de forma musical completa", "Demostrar progreso técnico y musical"]
        }
      ]
    }
            ]
        },
        { 
            id: 1, 
            title: 'Nivel 1', 
            progress: 0,
            description: 'Construye sobre lo básico con escalas, acordes simples y lectura de partituras inicial.', 
            duration: '4 horas',
            lessons: [
                {
                    title: "Lección 1: Escalas Mayores",
                    unit: 1,
                    tasks: [
                        { type: 'video', title: "Postura correcta de manos", videoId: "Q4r5gnfAtzs", iconClass: 'ri-play-circle-line' },
                        { type: 'quiz', title: "Quiz de Postura", question: "¿Qué forma deben tener tus manos sobre el piano?", options: ["Planas como panqueques", "Como si sostuvieras una pelota", "Tensas y rectas"], correctAnswer: 1, iconClass: 'ri-question-line' },
                        { type: 'record', title: "Graba tu primera melodía", contentUrl: "https://app.mozartacademy.mx/grandstaff", iconClass: 'ri-mic-line' }
                    ]
                },
                {
                    title: "Lección 2: Tonalidad de G",
                    unit: 1,
                    tasks: [
                        { type: 'video', title: "Entendiendo las Negras", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' },
                        { type: 'note', title: "Toca la nota Si", key: 'B', contentUrl: "https://app.mozartacademy.mx/books2/page/10" }
                    ]
                },
                {
                    title: "Lección 3: Pentaescalas",
                    unit: 1,
                    tasks: [
                        { type: 'video', title: "Pentaescalas", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 4: Cambio de Posición",
                    unit: 2,
                    tasks: [
                        { type: 'video', title: "Cambios", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 5: Intervalos de 6ta",
                    unit: 2,
                    tasks: [
                        { type: 'video', title: "Sextas", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 6: Tonalidad de F",
                    unit: 2,
                    tasks: [
                        { type: 'video', title: "Fa Mayor", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 7: Grupo 1",
                    unit: 3,
                    tasks: [
                        { type: 'video', title: "Grupo 1", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 8: Más Notación",
                    unit: 3,
                    tasks: [
                        { type: 'video', title: "Notación Avanzada", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 9: Síncopas",
                    unit: 3,
                    tasks: [
                        { type: 'video', title: "Ritmos Sincopados", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                },
                {
                    title: "Lección 10: Pieza Final",
                    unit: "Final",
                    tasks: [
                        { type: 'video', title: "Pieza de Conclusión", videoId: "ec4ZRGMYgrY", iconClass: 'ri-play-circle-line' }
                    ]
                }
            ]
        },
        { 
            id: 2, 
            title: 'Nivel 2', 
            progress: 0,
            description: 'Profundiza en técnicas avanzadas y piezas más complejas.', 
            duration: '6 horas',
            lessons: [
                { title: "Lección 1: Escalas Avanzadas", unit: 1, tasks: [] }
            ]
        },
        { 
            id: 3, 
            title: 'Nivel 3', 
            progress: 0,
            description: 'Domina técnicas profesionales y repertorio clásico.', 
            duration: '8 horas',
            lessons: [
                { title: "Lección 1: Técnica Avanzada", unit: 1, tasks: [] }
            ]
        },
        { 
            id: 4, 
            title: 'Nivel 4', 
            progress: 0,
            description: 'Perfecciona tu interpretación y expresión musical.', 
            duration: '10 horas',
            lessons: [
                { title: "Lección 1: Interpretación", unit: 1, tasks: [] }
            ]
        },
        { 
            id: 5, 
            title: 'Nivel 5', 
            progress: 0,
            description: 'Nivel maestro: repertorio complejo y composición.', 
            duration: '12 horas',
            lessons: [
                { title: "Lección 1: Composición", unit: 1, tasks: [] }
            ]
        }
    ];



  
    $scope.lessons = [];
    $scope.pendingTasks = [];
    $scope.selectedLevel = null;
    $scope.sidebarOpen = false;
    $scope.savedProgress = {};
    $scope.isLoading = true;

   $scope.currentLevelIndex = 0;
  $scope.currentLessonIndex = 0;
    $scope.currentTaskIndex = 0;
    $scope.viewingLessonIndex = 0;
    $scope.viewingTaskIndex = 0;
    $scope.totalTasksCompleted = 0;
    $scope.totalTasks = 0;
    $scope.progress = 0;
    $scope.currentTaskUrl = '';
    $scope.serverLevelIndex = 0; 
    $scope.serverLessonIndex = 0;
    
    // Variables para control de video de YouTube
    $scope.showingVideo = false;
    let youtubePlayer = null;
    let videoHasEnded = false;
    let pauseTimer = null;
    let isYouTubeAPIReady = false;
    let shouldAutoplayVideo = false;
    $scope.currentViewingTask = null;

    $scope.modal = { show: false, content: '' };


       const requestData = {
            action: "getUserData",
           token: localStorage.getItem('MStoken')
           // token: "U2FsdGVkX1+pTAJ/i/vnElIrTlT7VjKJ6kuzk2FlnAIkGq9xl29aZsKgbGygQIfF"
        };

        const config = {
            headers: {
                "Content-Type": "text/plain;charset=utf-8"
            },
        };

        $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)
            .then(function(response) {
                $scope.userStatus = response.data.status
                const stage = JSON.parse(response.data.stage);
                $scope.serverLevelIndex = stage.lvl;
            $scope.serverLessonIndex = stage.lsn;
            $scope.currentLevelIndex = stage.lvl; 
            $scope.levels.forEach(level => {
                if (level.id < $scope.currentLevelIndex) {
                    level.progress = 100; // Marcar niveles anteriores como 100%
                } else if (level.id > $scope.currentLevelIndex) {
                    level.progress = 0; // Marcar niveles futuros como 0%
                }
                // Si el nivel es el actual, dejamos el progreso que trae por defecto
            });
            initApp($scope.serverLevelIndex, $scope.serverLessonIndex);
               // $scope.userSubmittedRecordings = stage.exes || [];
            }).catch(function(error) {
               $scope.serverLevelIndex = 0;
            $scope.serverLessonIndex = 0;
            $scope.currentLevelIndex = 0;

            $scope.levels.forEach(level => {
            level.progress = 0;
        });
               initApp(0, 0);
            }).finally(function() {
            $scope.isLoading = false;
        });

    // =============================================
    // == LÓGICA DE CAMBIO DE VISTAS Y NIVELES
    // =============================================
    $scope.selectLevel = (level) => {
        if ($scope.currentLevelIndex >= level.id) {
            $scope.selectedLevel = level;
            $scope.startApp();
        }
    };

    $scope.startApp = () => {
        if (!$scope.selectedLevel) return;

        const levelToLoad = $scope.selectedLevel.id;
        let lessonToLoad = 0; 
        if (levelToLoad === $scope.serverLevelIndex) {
            lessonToLoad = $scope.serverLessonIndex;
        }

        $scope.currentView = 'app';
        initApp(levelToLoad, lessonToLoad);
    };

$scope.showLevelSelector = () => {
    // Guardar el progreso actual antes de salir
    if ($scope.selectedLevel) {
        $scope.savedProgress[$scope.selectedLevel.id] = {
            lessons: angular.copy($scope.lessons),
            currentLessonIndex: $scope.currentLessonIndex,
            currentTaskIndex: $scope.currentTaskIndex,
            totalTasksCompleted: $scope.totalTasksCompleted,
            progress: $scope.progress
        };
        
        // Actualizar el progreso en el objeto level
        $scope.selectedLevel.progress = $scope.progress;
        
        // Actualizar currentLevelIndex si completó todas las tareas
        if ($scope.currentLessonIndex >= $scope.lessons.length) {
            $scope.currentLevelIndex = Math.max($scope.currentLevelIndex, $scope.selectedLevel.id + 1);
        }
    }
    
    // NUEVO: Recalcular el progreso de todos los niveles basado en savedProgress
    $scope.levels.forEach(level => {
        if ($scope.savedProgress[level.id]) {
            level.progress = $scope.savedProgress[level.id].progress;
        }
    });
    
    $scope.currentView = 'levelSelector';
};

    $scope.toggleSidebar = () => {
        $scope.sidebarOpen = !$scope.sidebarOpen;
    };
    
function initApp(startLevelIdx, startLessonIdx, autoLoad = true) {
    if (!$scope.levels[startLevelIdx]) {
        console.error("El nivel " + startLevelIdx + " no existe. Empezando en 0.");
        startLevelIdx = 0;
        startLessonIdx = 0;
    }

    $scope.selectedLevel = $scope.levels[startLevelIdx];

    // NUEVO: Marcar como completados todos los niveles inferiores
    $scope.levels.forEach((level, idx) => {
        if (idx < startLevelIdx) {
            // Marcar todas las lecciones del nivel como completadas
            if (!$scope.savedProgress[level.id]) {
                const completedLessons = angular.copy(level.lessons);
                completedLessons.forEach(lesson => {
                    lesson.completed = true;
                    lesson.expanded = false;
                    lesson.tasks.forEach(task => {
                        task.completed = true;
                    });
                });
                
                // Guardar el progreso completo del nivel
                $scope.savedProgress[level.id] = {
                    lessons: completedLessons,
                    currentLessonIndex: completedLessons.length,
                    currentTaskIndex: 0,
                    totalTasksCompleted: completedLessons.reduce((acc, l) => acc + l.tasks.length, 0),
                    progress: 100
                };
            }
            // Actualizar el progreso visual del nivel
            level.progress = 100;
        }
    });

    if ($scope.savedProgress[$scope.selectedLevel.id]) {
        const saved = $scope.savedProgress[$scope.selectedLevel.id];
        
        // Restaurar el progreso guardado
        $scope.lessons = angular.copy(saved.lessons);
        $scope.currentLessonIndex = saved.currentLessonIndex;
        $scope.currentTaskIndex = saved.currentTaskIndex;
        $scope.totalTasksCompleted = saved.totalTasksCompleted;
        $scope.progress = saved.progress;
        $scope.totalTasks = $scope.lessons.reduce((acc, lesson) => acc + lesson.tasks.length, 0);
        
        updatePendingTasks();
        if (autoLoad) {
            loadCurrentTask();
        }

    } else {
        $scope.lessons = angular.copy($scope.selectedLevel.lessons);
        $scope.totalTasks = $scope.lessons.reduce((acc, lesson) => acc + lesson.tasks.length, 0);

        const defaultLessonIndex = startLessonIdx; // Lección de inicio
        const defaultTaskIndex = 0; // Siempre empezamos al inicio de la lección
        
        $scope.totalTasksCompleted = 0; // Iniciar contador

        $scope.lessons.forEach((lesson, l_idx) => {
            if (l_idx < defaultLessonIndex) {
                // Lección ANTERIOR: Marcar todo como completo
                lesson.completed = true;
                lesson.expanded = false; // Colapsada
                lesson.tasks.forEach(task => {
                    task.completed = true;
                    $scope.totalTasksCompleted++;
                });

            } else if (l_idx === defaultLessonIndex) {
                // Lección ACTUAL: Expandir y marcar como activa
                lesson.completed = false;
                lesson.expanded = true; // Expandir esta lección
                lesson.tasks.forEach((task, t_idx) => {
                    // Marcar tareas previas como completas (si defaultTaskIndex fuera > 0)
                    if (t_idx < defaultTaskIndex) { 
                        task.completed = true;
                        $scope.totalTasksCompleted++;
                    } else {
                        task.completed = false;
                    }
                });

            } else {
                // Lección FUTURA: Todo bloqueado
                lesson.completed = false;
                lesson.expanded = false;
                lesson.tasks.forEach(task => task.completed = false);
            }
        });
        $scope.currentLessonIndex = defaultLessonIndex;
        $scope.currentTaskIndex = defaultTaskIndex;
        updateProgress();
        updatePendingTasks();
        if (autoLoad) {
            loadCurrentTask();
        }
    }
    $scope.selectedLevel.progress = $scope.progress;
}

function updatePendingTasks() {
    $scope.pendingTasks = [];
    
    if ($scope.currentLessonIndex < $scope.lessons.length) {
        const currentLesson = $scope.lessons[$scope.currentLessonIndex];
        

        const tasksToShow = currentLesson.tasks.slice(0, 3);
        
        tasksToShow.forEach((task, index) => {
            $scope.pendingTasks.push({
                lessonTitle: currentLesson.title,
                taskTitle: task.title,
                taskType: task.type,
                lessonIndex: $scope.currentLessonIndex,
                taskIndex: index,
                iconClass: task.iconClass || getIconForTaskType(task.type),
                completed: task.completed 
            });
        });
    }
}

    $scope.toggleLesson = (lesson) => {
        const lessonIndex = $scope.lessons.indexOf(lesson);
        const isUnlocked = lessonIndex === 0 || $scope.lessons[lessonIndex - 1].completed;
        if (isUnlocked) {
            lesson.expanded = !lesson.expanded;
        }
    };
    
$scope.viewTask = (lessonIndex, taskIndex) => {
    // 1. Comprobar si la tarea es futura
    const isFutureTask = (lessonIndex > $scope.currentLessonIndex) || 
                         (lessonIndex === $scope.currentLessonIndex && taskIndex > $scope.currentTaskIndex);

    if (isFutureTask) {
        console.log("Tarea bloqueada. Completa la actual primero.");
        return; // No hacer nada
    }

    // 2. Si no es futura (es actual o pasada), mostrar su contenido
    $scope.viewingLessonIndex = lessonIndex;
    $scope.viewingTaskIndex = taskIndex;
    
    const task = $scope.lessons[lessonIndex].tasks[taskIndex];
    $scope.currentViewingTask = task;
    const youtubeContainer = document.getElementById('youtube-container');
    const contentIframe = document.getElementById('content-iframe');

    if (task.type === 'video') {
        // Mostrar video
        $scope.showingVideo = true;
        contentIframe.style.display = 'none';
        youtubeContainer.style.display = 'block';
        openVideoModal(task); // Tu función ya maneja la carga del video
    } else {
        // Mostrar iframe (ejercicio, quiz, etc.)
        $scope.showingVideo = false;
        youtubeContainer.style.display = 'none';
        contentIframe.style.display = 'block';
        $scope.currentTaskUrl = task.contentUrl;
    }
    
    if($scope.sidebarOpen) {
        $timeout(() => $scope.sidebarOpen = false, 200);
    }
};
    
function loadCurrentTask() {
    if ($scope.currentLessonIndex >= $scope.lessons.length) {
        // Nivel completado - mostrar última lección en lugar de mensaje
        $scope.currentLessonIndex = $scope.lessons.length - 1;
        $scope.currentTaskIndex = $scope.lessons[$scope.currentLessonIndex].tasks.length - 1;
        
        const lesson = $scope.lessons[$scope.currentLessonIndex];
        const task = lesson.tasks[$scope.currentTaskIndex];
        
        $scope.currentViewingTask = task;
        lesson.expanded = true;
        $scope.viewingLessonIndex = $scope.currentLessonIndex;
        $scope.viewingTaskIndex = $scope.currentTaskIndex;
        
        // Cargar el contenido de la última tarea
        if (task.type === 'video') {
            openVideoModal(task);
        } else {
            $scope.showingVideo = false;
            document.getElementById('youtube-container').style.display = 'none';
            document.getElementById('content-iframe').style.display = 'block';
            $scope.currentTaskUrl = task.contentUrl;
        }
        return;
    }
    
    const lesson = $scope.lessons[$scope.currentLessonIndex];
    const task = lesson.tasks[$scope.currentTaskIndex];
    
    $scope.currentViewingTask = task;
    lesson.expanded = true;
    $scope.viewingLessonIndex = $scope.currentLessonIndex;
    $scope.viewingTaskIndex = $scope.currentTaskIndex;
    
    if (task.type === 'video') {
        speak(`Siguiente: ${task.title}.`);
        openVideoModal(task);
    } else {
        $scope.currentTaskUrl = task.contentUrl;
        if (task.type === 'note') {
            speak(`Ahora, ${task.title}`, 'important');
        } else {
            speak(`Siguiente: ${task.title}. Haz clic en el ícono para comenzar.`);
        }
    }
    
    if($scope.sidebarOpen) {
        $timeout(() => $scope.sidebarOpen = false, 200);
    }
}
    
  function completeCurrentTask() {
    const task = $scope.lessons[$scope.currentLessonIndex].tasks[$scope.currentTaskIndex];
    task.completed = true;

    $scope.totalTasksCompleted++;
    updateProgress();
    updatePendingTasks(); // AGREGAR ESTA LÍNEA
    
    $scope.currentTaskIndex++;
    if ($scope.currentTaskIndex >= $scope.lessons[$scope.currentLessonIndex].tasks.length) {
        completeLesson();
    } else {
        shouldAutoplayVideo = true;
        $timeout(loadCurrentTask, 1200);
    }
}
    
function completeLesson() {
    const lesson = $scope.lessons[$scope.currentLessonIndex];
    speak(`¡Felicidades! Has completado la ${lesson.title}.`, 'important');
    lesson.completed = true;
    showConfetti();
    
    $scope.currentLessonIndex++;
    $scope.currentTaskIndex = 0;

    if ($scope.currentLessonIndex >= $scope.lessons.length) {
        $scope.currentLevelIndex = Math.max($scope.currentLevelIndex, $scope.selectedLevel.id + 1);
        speak("¡Has completado todo el nivel! El siguiente nivel ha sido desbloqueado.", 'important');
        showConfetti(200);
        
        $timeout(() => {
            alert("¡Nivel Completado! 🎉\n\nHas terminado todas las lecciones de este nivel.\nEl siguiente nivel ha sido desbloqueado.");
            $scope.showLevelSelector();
        }, 1500);
        
        return; 
    }
    shouldAutoplayVideo = true;
    $timeout(loadCurrentTask, 1500);
}

    function updateProgress() {
        $scope.progress = ($scope.totalTasksCompleted / $scope.totalTasks) * 100;
    }

 


    function initYouTubePlayer(videoId) {
        videoHasEnded = false;
        youtubePlayer = new YT.Player('player', {
            width: '100%',
            height: '100%',
            videoId: videoId,
            playerVars: {
                'playsinline': 1,
                'rel': 0
            },
            events: {
                'onReady': function(event) {
                    if (shouldAutoplayVideo) {
                        event.target.playVideo();
                    }
                },
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        console.log('Estado del video:', event.data);
        
        const pauseModal = document.getElementById('pauseModal');
        const finishedModal = document.getElementById('finishedModal');
        
        clearTimeout(pauseTimer);

        switch (event.data) {
            case YT.PlayerState.PLAYING:
                console.log('Reproduciendo');
                pauseModal.style.display = 'none';
                break;
            
            case YT.PlayerState.PAUSED:
                console.log('Pausado');
                if (!videoHasEnded) {
                    pauseTimer = setTimeout(() => {
                        if (youtubePlayer && youtubePlayer.getPlayerState() === YT.PlayerState.PAUSED) {
                            pauseModal.style.display = 'flex';
                        }
                    }, 250);
                }
                break;
            
            case YT.PlayerState.ENDED:
                console.log('Video terminado');
                videoHasEnded = true;
                pauseModal.style.display = 'none';
                finishedModal.style.display = 'flex';
                break;

            case YT.PlayerState.BUFFERING:
                console.log('Cargando...');
                clearTimeout(pauseTimer);
                break;
        }
    }

    function openVideoModal(task) {
        $scope.showingVideo = true;
        $scope.currentTaskUrl = '';
        
        const youtubeContainer = document.getElementById('youtube-container');
        const contentIframe = document.getElementById('content-iframe');
        
        youtubeContainer.style.display = 'block';
        contentIframe.style.display = 'none';
        
        if (!isYouTubeAPIReady) {
            const checkAPI = setInterval(() => {
                if (typeof YT !== 'undefined' && YT.Player) {
                    isYouTubeAPIReady = true;
                    clearInterval(checkAPI);
                    createOrLoadVideo(task.videoId);
                }
            }, 100);
        } else {
            createOrLoadVideo(task.videoId);
        }
    }

    function createOrLoadVideo(videoId) {
        if (!youtubePlayer) {
            initYouTubePlayer(videoId);
        } else {
            youtubePlayer.loadVideoById(videoId);
            videoHasEnded = false;
            if (shouldAutoplayVideo) {
                youtubePlayer.playVideo();
            }
        }
        shouldAutoplayVideo = false;
    }

    function openQuizModal(task) {
        const optionsHTML = task.options.map((option, index) => 
            `<button class="quiz-option" data-index="${index}">${option}</button>`
        ).join('');
        
        const content = `
            <h3>Quiz Rápido</h3>
            <p>${task.question}</p>
            <div class="quiz-options">${optionsHTML}</div>`;
            
        $scope.modal.content = $sce.trustAsHtml(content);
        $scope.modal.show = true;

        $timeout(() => {
            document.querySelectorAll('.quiz-option').forEach(button => {
                button.onclick = (e) => {
                    const selectedIndex = parseInt(e.target.dataset.index);
                    if (selectedIndex === task.correctAnswer) {
                        $scope.$apply(() => {
                            closeModal();
                            completeCurrentTask();
                        });
                    } else {
                        e.target.style.backgroundColor = 'var(--danger-red)';
                        e.target.style.color = 'white';
                        speak("Respuesta incorrecta. Intenta de nuevo.");
                    }
                };
            });
        });
    }
    
 
    
  
    
    function closeModal() {
        $scope.modal.show = false;
        $scope.modal.content = '';
    }

    // =============================================
    // == VOZ Y EFECTOS
    // =============================================
    function speak(text, priority = 'normal') {
        if ('speechSynthesis' in window) {
            if (priority === 'important') speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-MX';
            utterance.rate = 1.1;
            speechSynthesis.speak(utterance);
        }
    }
    
    function showConfetti(count = 100) {
        const colors = ['#6f42c1', '#48aee9', '#28a745', '#ffc107', '#dc3545'];
        for (let i = 0; i < count; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.top = `${-10 - Math.random() * 10}vh`;
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = `${Math.random() * 0.5}s`;
            confetti.style.animationDuration = `${3 + Math.random() * 2}s`;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 5000);
        }
    }

    // =============================================
    // == COMUNICACIÓN ENTRE FRAMES
    // =============================================
    window.addEventListener('message', function(event) {
        if (event.data === 'siguienteActividad') {
            $scope.$apply(() => {
                completeCurrentTask();
            });
        }
    });

    // =============================================
    // == INICIALIZACIÓN DE EVENTOS
    // =============================================
    $timeout(function() {
        const levelSelector = document.getElementById('levelSelector');
        const banner = document.querySelector('.banner-header');
        const closePauseButton = document.getElementById('closePauseButton');
        const continueVideoButton = document.getElementById('continueVideoButton');

        // Parallax del banner
        if (levelSelector && banner) {
            levelSelector.addEventListener('scroll', function() {
                let scrollTop = this.scrollTop;
                let bannerHeight = banner.offsetHeight;
                banner.style.transform = `translateY(-${scrollTop * 0.5}px)`;
                let opacity = 1 - (scrollTop / bannerHeight);
                banner.style.opacity = Math.max(0, opacity);
            });
        }

        // Botón cerrar modal de pausa
        if (closePauseButton) {
            closePauseButton.onclick = () => {
                console.log('Cerrando modal de pausa');
                document.getElementById('pauseModal').style.display = 'none';
                if (youtubePlayer) youtubePlayer.playVideo();
            };
        }
        
        // Botón continuar después del video
        if (continueVideoButton) {
            continueVideoButton.onclick = () => {
                console.log('Continuando después del video');
                $scope.$apply(() => {
                    document.getElementById('finishedModal').style.display = 'none';
                    $scope.showingVideo = false;
                    document.getElementById('youtube-container').style.display = 'none';
                    document.getElementById('content-iframe').style.display = 'block';
                    videoHasEnded = false;
                    completeCurrentTask();
                });
            };
        }
    });

});
    </script>
</html>
