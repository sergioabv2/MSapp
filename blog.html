<!DOCTYPE html>
<html ng-app="postApp">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mozart Blog</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<style>
    
 *, *::before, *::after {
    box-sizing: border-box;
}
    
:root {
    --primary-color: #7c3aed; /* Púrpura Mozart */
    --primary-light: #f5f3ff;
    --border-color: #e5e7eb;
    --text-main: #111827;
    --text-sub: #6b7280;
    --bg-body: #f0f2f5;
    --alert-bg: #fef2f2;
    --alert-text: #b91c1c;
    --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

body {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
     transition: background-color 0.3s, color 0.3s;
    font-family: var(--font-stack);
    color: var(--text-main);
    margin: 0;
    padding: 0;
    /* Sin padding-top porque va embedido */
}





/* --- 2. Hero Header (Imagen de Fondo) --- */
.hero-wrapper {
    position: relative;
    height: 240px;
    background: #1f2937; /* Fallback */
    background-image: linear-gradient(to bottom, 
                rgba(248, 249, 250, 0.35) 0%, 
                rgba(248, 249, 250, 0.25) 50%, 
                rgba(248, 249, 250, 1) 100%), url('https://lh3.googleusercontent.com/d/15FbOHaYX6jPjCkgfaayMDU3cPpbEM0W3=s700');
    background-size: cover;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 0 5%;
    margin-bottom: 40px;
}

.hero-subtitle {
    color: #FF4757;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
}

.hero-title {
    color: #1a1a1a;
    text-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    font-size: 42px;
    font-weight: 800;
    margin: 0;
}

/* --- 3. Contenedor Principal (Lista) --- */
.content-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px 60px 20px;
}

/* Filtros / Buscador estilo "Database" */
.search-bar-wrapper {
    margin-bottom: 24px;
}

.search-input {
    width: 100%;
    padding: 16px 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px; /* Redondeado suave */
    font-size: 16px;
    background-color: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    outline: none;
    transition: border-color 0.2s;
}

.search-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.filters-row {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    overflow-x: auto;
    padding-bottom: 5px;
}

.filter-pill {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-sub);
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    background: transparent;
    transition: all 0.2s;
}

.filter-pill:hover {
    background: #f3f4f6;
    color: var(--text-main);
}

.filter-pill.active {
    background: var(--primary-light);
    color: var(--primary-color);
    font-weight: 600;
}

/* --- 4. LIST ROW ITEMS (El cambio principal) --- */
.story-row {
    display: flex;
    flex-direction: column; /* Estructura interna vertical, pero el card es horizontal visualmente si se expande */
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 16px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

/* Efecto hover estilo Starter Story (borde azul/púrpura) */
.story-row:hover {
    border-color: var(--primary-color);
    background-color: #F8F9FF;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.08);
    transform: translateY(-1px);
}

/* Layout interno del Row */
.row-header {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 12px;
}

.row-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%; /* Circular */
    object-fit: cover;
    border: 1px solid #eee;
    flex-shrink: 0;
}

.row-main-content {
    flex: 1;
}

.row-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 6px;
    line-height: 1.3;
}

.row-excerpt {
    font-size: 15px;
    color: var(--text-sub);
    line-height: 1.5;
    margin-bottom: 16px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Stats Footer dentro del Row */
.row-stats {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-top: 1px solid #f3f4f6;
    padding-top: 12px;
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-main);
    font-weight: 600;
}

.stat-group {
    display: flex;
    gap: 15px;
}

.stat-item span {
    color: var(--text-sub);
    font-weight: 400;
    margin-left: 4px;
}

.read-by {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-sub);
    font-weight: 400;
}

/* Botón flotante para crear (FAB) */
.fab-create {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: var(--primary-color);
    color: white;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    cursor: pointer;
    font-size: 24px;
    border: none;
    z-index: 100;
    transition: transform 0.2s;
}
.fab-create:hover { transform: scale(1.05); }

/* --- Modal de Lectura (Overlay) --- */
.reader-modal {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background-color: #ffffff; /* Blanco sólido, no rgba */
    z-index: 2147483647; /* El z-index máximo permitido en CSS para tapar todo */
    overflow-y: auto;
    padding: 0; /* Quitamos padding del contenedor para que el header ocupe todo */
}

.reader-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 60px 20px 100px 20px; /* Padding interno */
    background: #fff;
    min-height: 100vh;
}
.reader-content {
    max-width: 700px;
    margin: 0 auto;
}


.comments-section {
    margin-top: 60px;
    padding-top: 40px;
    border-top: 2px solid #e7e9ee;
}

.comments-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.comments-count {
    font-weight: 700;
    font-size: 18px;
    color: #2a2e2e;
}

.comments-login-btn {
    font-weight: 700;
    font-size: 14px;
    color: #687a86;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Input Box Area */
.comment-input-area {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
}

.comment-avatar-placeholder {
    width: 48px;
    height: 48px;
    background: #7c3aed; /* Tu color morado */
    color: white;
    font-weight: 700;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px; /* Cuadrado redondeado como Disqus */
    flex-shrink: 0;
}

.comment-box-wrapper {
    flex: 1;
}

.comment-textarea {
    width: 100%;
    border: 2px solid #dbdfe4;
    border-radius: 6px;
    padding: 12px;
    font-size: 16px;
    color: #2a2e2e;
    min-height: 100px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
    font-family: inherit;
}

.comment-textarea:focus {
    border-color: #7c3aed;
}

/* Fila de iconos de "Log in with" */
.login-options {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.login-label {
    font-size: 11px;
    font-weight: 700;
    color: #687a86;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.social-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

/* Action Bar (Heart, Share, Sort) */
.comments-toolbar {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e7e9ee;
}

.toolbar-item {
    font-weight: 600;
    font-size: 14px;
    color: #656c7a;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    margin-right: 20px;
}

.sort-dropdown {
    margin-right: auto;
    font-weight: 600;
    font-size: 14px;
    color: #2a2e2e;
    cursor: pointer;
}

/* Lista de Comentarios */
.comment-node {
    display: flex;
    gap: 15px;
    margin-bottom: 24px;
}

.node-avatar img {
    width: 48px;
    height: 48px;
    border-radius: 50%; /* Disqus usa circular en los items */
    object-fit: cover;
}

.node-content {
    flex: 1;
}

.node-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 6px;
}

.node-author {
    font-weight: 700;
    font-size: 15px;
    color: #2a2e2e; /* Tu púrpura */
}

.node-time {
    font-size: 13px;
    color: #656c7a;
    font-weight: 400;
}

.node-text {
    font-size: 15px;
    line-height: 1.5;
    color: #2a2e2e;
    margin-bottom: 8px;
}

.node-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.node-action-link {
    font-weight: 600;
    font-size: 13px;
    color: #656c7a;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.node-action-link:hover {
    color: #7c3aed;
}

.vote-divider {
    color: #dbdfe4;
    font-size: 12px;
}


/* --- Nuevos Estilos para Funcionalidades --- */

/* 1. Share Popover */
.share-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.share-popover {
    position: absolute;
    bottom: 130%; /* Que aparezca arriba del botón */
    left: 50%;
    transform: translateX(-50%);
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 8px 12px;
    min-width: 140px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.share-btn-copy {
    background: none;
    border: none;
    color: var(--text-main);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px;
    width: 100%;
}
.share-btn-copy:hover { color: var(--primary-color); }

/* 2. Likes Activos */
.liked {
    color: #ef4444 !important; /* Rojo corazón */
}
.ri-heart-fill {
    animation: pop 0.3s ease;
}

@keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* 3. Respuestas (Nesting) */
.replies-container {
    margin-left: 50px; /* Indentación */
    margin-top: -10px;
    margin-bottom: 20px;
    border-left: 2px solid #f0f2f5;
    padding-left: 15px;
}

.reply-input-box {
    margin-top: 10px;
    margin-left: 60px;
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease;
}

/* Ajustes Input */
.comment-textarea {
    min-height: 60px; /* Un poco más compacto */
}


/* --- 1. SHARE & SORT POPOVERS (Estilo unificado) --- */
.toolbar-action-wrapper {
    position: relative;
    display: inline-block;
}

.popover-menu {
    position: absolute;
    bottom: 100%; /* Arriba del botón */
    left: 50%;
    transform: translateX(-50%);
    background: white;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 6px;
    min-width: 160px;
    z-index: 20;
    display: flex;
    flex-direction: column;
    margin-bottom: 10px;
    animation: fadeInPopover 0.2s ease;
}

.popover-item {
    padding: 8px 12px;
    font-size: 14px;
    color: var(--text-main);
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}

.popover-item:hover {
    background-color: #f3f4f6;
    color: var(--primary-color);
}

.popover-item.active {
    font-weight: 700;
    color: var(--primary-color);
    background-color: var(--primary-light);
}

@keyframes fadeInPopover {
    from { opacity: 0; transform: translate(-50%, 10px); }
    to { opacity: 1; transform: translate(-50%, 0); }
}

/* --- 2. INPUT ESTILO IMAGEN (Material Design) --- */
.reply-input-box {
    margin-top: 15px;
    margin-left: 60px; /* Alineado con el texto del comentario padre */
    margin-bottom: 25px;
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.material-input-container {
    flex: 1;
    position: relative;
}

.material-input {
    width: 100%;
    border: none;
    border-bottom: 2px solid #000; /* Línea negra gruesa como la imagen */
    background: transparent;
    padding: 8px 0;
    font-size: 15px;
    color: #000;
    outline: none;
    font-family: inherit;
    transition: border-color 0.3s;
}

.material-input:focus {
    border-bottom-color: var(--primary-color); /* Color de foco opcional */
}

/* Botones Cancelar / Responder */
.reply-actions-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 12px;
    margin-top: 12px;
}

.btn-cancel {
    background: none;
    border: none;
    font-weight: 700;
    font-size: 14px;
    color: #111;
    cursor: pointer;
}

.btn-reply-material {
    background-color: #f0f0f0; /* Gris claro default */
    color: #888;
    border: none;
    padding: 8px 20px;
    border-radius: 20px; /* Bordes muy redondeados como la imagen */
    font-weight: 600;
    font-size: 14px;
    cursor: not-allowed;
    transition: all 0.2s;
}

.btn-reply-material.active {
    background-color: #111; /* Negro o Primary */
    color: white;
    cursor: pointer;
}

/* --- 3. TOGGLE RESPUESTAS --- */
.replies-toggler {
    font-weight: 600;
    font-size: 13px;
    color: var(--primary-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    background: var(--primary-light);
}
.replies-toggler:hover {
    background: #ede9fe;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Estilos para Artículos (Rich Text) --- */

.article-body-content {
    font-size: 19px;
    line-height: 1.8;
    color: #2a2e2e;
    margin-bottom: 60px;
}

/* Títulos dentro del post */
.article-body-content h2 {
    font-size: 24px;
    font-weight: 700;
    margin-top: 40px;
    margin-bottom: 20px;
    color: #111;
}

/* Caja de Información (Info Box) */
.info-box {
    background-color: #f0fdf4; /* Verde muy suave */
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 20px;
    margin: 30px 0;
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.info-box-icon {
    color: #16a34a; /* Verde icono */
    font-size: 24px;
    margin-top: 2px;
}

.info-box-title {
    display: block;
    font-weight: 700;
    color: #15803d;
    margin-bottom: 4px;
    font-size: 16px;
}

/* Bloque de énfasis (Citas) */
.emphasis-block {
    border-left: 4px solid var(--primary-color);
    background: #f8faff;
    padding: 20px 30px;
    font-style: italic;
    font-size: 21px;
    color: #4b5563;
    margin: 40px 0;
    border-radius: 0 8px 8px 0;
}

/* Listas estilizadas */
.styled-list {
    padding-left: 20px;
    margin-top: 20px;
}

.styled-list li {
    margin-bottom: 12px;
    position: relative;
    padding-left: 10px;
}

.styled-list li::marker {
    color: var(--primary-color);
    font-weight: bold;
}

/* Responsive */
@media (max-width: 600px) {
    .hero-title { font-size: 32px; }
    .hero-wrapper { height: 200px; }
    .row-stats { flex-direction: column; align-items: flex-start; gap: 10px; }
    .read-by { display: none; } /* Ocultar avatares de "leído por" en móvil para limpiar */
}
</style>
<body ng-controller="postController">

    

    <div class="hero-wrapper">
        <div class="hero-subtitle">Experiencias de aprendizaje</div>
        <h1 class="hero-title">Blog</h1>
          <p style="color: #596275; margin-top: 10px; font-weight: 500;">
                Sistema de aprendizaje secuencial. 
            </p>
    </div>

    <div class="content-container" ng-if="!selectedPostForComments">
        
      

        <div class="filters-row">
            <div class="filter-pill" ng-class="{'active': filter === 'all'}" ng-click="filterPosts('all')">Todo</div>
            <div class="filter-pill" ng-class="{'active': filter === 'tip'}" ng-click="filterPosts('tip')">Tips</div>
            <div class="filter-pill" ng-class="{'active': filter === 'story'}" ng-click="filterPosts('story')">Anécdotas</div>
            <div class="filter-pill" ng-class="{'active': filter === 'article'}" ng-click="filterPosts('article')">Artículos</div>
       
        </div>

          <div class="search-bar-wrapper">
            <input type="text" class="search-input" placeholder="Buscar lección, historia o tip..." ng-model="searchText">
        </div>
        

        <div class="story-list">
            <div ng-if="userDataLoaded" style="text-align:center; padding:40px; color:#666;">
                <i class="ri-loader-4-line ri-spin" style="font-size:24px;"></i> Cargando base de datos...
            </div>

            <div class="story-row" ng-repeat="post in filteredData | filter:searchText | limitTo: itemsPerPage" ng-click="openComments(post)">
                
                <div class="row-header">
                    <img ng-src="{{post.photo}}" class="row-avatar">
                    
                    <div class="row-main-content">
                        <div class="row-title">
                            {{post.header || 'Nueva publicación'}}
                        </div>
                        
                        <div class="row-excerpt">
                            {{post.content}}
                        </div>
                    </div>
                </div>

                <div class="row-stats">
                    <div class="stat-group">
                        <div class="stat-item" style="color:var(--text-main);">
                            {{post.category}} •
                  
                        </div>
                        <div class="stat-item" style="color:var(--text-main);">
                           {{post.comments.length}}
                            <span>Comentarios</span>
                        </div>
                    </div>

                    <div class="read-by">
                        <div style="display:flex; margin-right:8px;">
                            <div style="width:20px; height:20px; background:#ddd; border-radius:50%; border:1px solid white;"></div>
                            <div style="width:20px; height:20px; background:#ccc; border-radius:50%; border:1px solid white; margin-left:-8px;"></div>
                            <div style="width:20px; height:20px; background:#bbb; border-radius:50%; border:1px solid white; margin-left:-8px;"></div>
                        </div>
                        Leído por {{ 120 + post.likes.length }} estudiantes
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align:center; margin-top:30px;" ng-if="filteredData.length > itemsPerPage">
            <button style="background:white; border:1px solid #ddd; padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:600; color:#555;" ng-click="loadMorePosts()">
                Cargar más resultados
            </button>
        </div>

    </div>

 

  <div class="reader-modal" ng-if="selectedPostForComments">
    <div class="reader-container">
        
        <button style="background:none; border:none; font-weight:600; cursor:pointer; margin-bottom:30px; color:#666; display:flex; align-items:center; gap:5px; font-size:15px;" ng-click="backToFeed()">
            <i class="ri-arrow-left-line"></i> Volver 
        </button>

        <h1 style="font-size:40px; font-weight:800; line-height:1.1; margin-bottom:15px; color:#111; letter-spacing: -0.5px;">
            {{selectedPostForComments.header || 'Publicación sin título'}}
        </h1>
        
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:40px; font-size:15px; color:#555; padding-bottom:20px; border-bottom:1px solid #eee;">
            <img ng-src="{{selectedPostForComments.photo}}" style="width:44px; height:44px; border-radius:50%; border:1px solid #eee;">
            <div>
                <div style="font-weight:700; color:#222;">{{selectedPostForComments.user}}</div>
                <div style="color:#666; font-size:13px;">Publicado {{calculateTimeAgo(selectedPostForComments.date)}}</div>
            </div>
        </div>

        <img ng-if="selectedPostForComments.media == 'img'" ng-src="{{selectedPostForComments.photo}}" style="width:100%; border-radius:8px; margin-bottom:40px; box-shadow:0 4px 20px rgba(0,0,0,0.05);">

       <div ng-bind-html="selectedPostForComments.content" 
     class="article-body-content">
</div>

       

  <div class="comments-section">
    
    <div class="comments-header-row">
        <div class="comments-count">{{selectedPostForComments.comments.length}}  Comentarios</div>
    </div>

    <div class="comments-toolbar">
        
        <div class="sort-dropdown toolbar-action-wrapper">
            <div ng-click="toggleSortMenu($event)">
                Ordenar por <span style="font-weight:800">{{ sortType === 'top' ? 'Top' : 'Recientes' }}</span>
                <i class="ri-arrow-down-s-line"></i>
            </div>

            <div class="popover-menu" ng-if="showSortMenu">
                <div class="popover-item" ng-class="{'active': sortType === 'top'}" ng-click="setSort('top')">
                    <i class="ri-fire-line"></i> Más Votados (Top)
                </div>
                <div class="popover-item" ng-class="{'active': sortType === 'recent'}" ng-click="setSort('recent')">
                    <i class="ri-time-line"></i> Más Recientes
                </div>
            </div>
        </div>

        <div class="share-wrapper toolbar-action-wrapper" style="margin-left:20px;">
            <div class="toolbar-item" ng-click="showShareMenu = !showShareMenu">
                <i class="ri-share-forward-line" style="font-size:18px;"></i> Compartir
            </div>
            
            <div class="popover-menu" ng-if="showShareMenu" style="width:140px; align-items: flex-start;">
                <div class="popover-item" ng-click="copyLink()" style="width:100%">
                    <i class="ri-file-copy-line"></i> Copiar Link
                </div>
            </div>
        </div>

    </div>

    <div class="comments-list">
        <div ng-if="selectedPostForComments.comments.length === 0" style="text-align:center; padding:30px; color:#999;">
            Sé el primero en comentar.
        </div>

        <div ng-repeat="comment in selectedPostForComments.comments | orderBy:sortExpression">
            
            <div class="comment-node">
                <div class="node-avatar">
                    <img ng-src="{{comment.photo}}">
                </div>
                <div class="node-content">
                    <div class="node-header">
                        <span class="node-author">{{comment.user}}</span>
                        <span class="node-time">{{calculateTimeAgoDetailed(comment.date)}}</span>
                    </div>
                    <div class="node-text">
                        {{comment.comment}}
                    </div>
                    <div class="node-actions">
                        <div class="node-action-link" ng-click="likeItem(comment)" ng-class="{'liked': comment.isLiked}">
                            <i ng-class="comment.isLiked ? 'ri-heart-fill' : 'ri-heart-line'" style="font-size:18px;"></i> 
                            {{comment.likes || 0}}
                        </div>
                        <span class="vote-divider">|</span>
                        <div class="node-action-link" ng-click="comment.showReplyForm = !comment.showReplyForm">
                            Responder
                        </div>

                        <div class="replies-toggler" 
                             ng-if="comment.replies.length > 0" 
                             ng-click="comment.showReplies = !comment.showReplies">
                            {{comment.replies.length}} Respuestas 
                            <i ng-class="comment.showReplies ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="reply-input-box" ng-if="comment.showReplyForm">
                <img ng-src="{{userImg}}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                
                <div class="material-input-container">
                    <input type="text" 
                           class="material-input" 
                           placeholder="Agrega una respuesta..." 
                           ng-model="comment.newReplyText"
                           ng-keydown="checkEnterReply($event, comment)">
                    
                    <div class="reply-actions-row">
                        <button class="btn-cancel" ng-click="comment.showReplyForm = false">Cancelar</button>
                        
                        <button class="btn-reply-material" 
                                ng-class="{'active': comment.newReplyText.length > 0}"
                                ng-disabled="!comment.newReplyText || comment.newReplyText.length === 0"
                                ng-click="replyToComment(comment)">
                            Responder
                        </button>
                    </div>
                </div>
            </div>

            <div class="replies-container" ng-if="comment.replies.length > 0 && comment.showReplies">
                <div class="comment-node" ng-repeat="reply in comment.replies">
                    <div class="node-avatar">
                        <img ng-src="{{reply.photo}}" style="width:32px; height:32px;">
                    </div>
                    <div class="node-content">
                        <div class="node-header">
                            <span class="node-author" style="font-size:14px;">{{reply.user}}</span>
                            <span class="node-time">{{calculateTimeAgoDetailed(reply.date)}}</span>
                        </div>
                        <div class="node-text" style="font-size:14px;">
                            {{reply.comment}}
                        </div>
                        <div class="node-actions">
                            <div class="node-action-link" ng-click="likeItem(reply)" ng-class="{'liked': reply.isLiked}">
                                <i ng-class="reply.isLiked ? 'ri-heart-fill' : 'ri-heart-line'" style="font-size:16px;"></i> 
                                {{reply.likes || 0}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="comment-input-area">
        <div class="comment-avatar-placeholder">
            {{user.charAt(0)}}
        </div>
        <div class="comment-box-wrapper">
            <textarea class="comment-textarea" 
                      id="mainCommentInput"
                      placeholder="Únete a la discusión..." 
                      ng-model="inputState.mainComment" 
                      ng-keydown="checkEnterMain($event)"></textarea>
            
            <div style="text-align:right; margin-top:10px;" ng-if="inputState.mainComment.trim().length > 0">
                <button ng-click="addComment()" style="background:var(--primary-color); color:white; border:none; padding:10px 24px; font-weight:700; border-radius:4px; cursor:pointer;">
                    Publicar <i class="ri-arrow-right-line"></i>
                </button>
            </div>
        </div>
    </div>
</div>


</div>
</div>

   

</body>

<script>
    var app = angular.module('postApp', []);

app.controller('postController', ['$scope', '$http', '$timeout', '$sce', function ($scope, $http, $timeout, $sce) {
  
  // --- Configuración Inicial ---
  $scope.userDataLoaded = true;
  $scope.data = [];
  $scope.filteredData = [];
  $scope.itemsPerPage = 10; // Lista larga
  $scope.filter = 'all';
  $scope.user = "Invitado"; 
  $scope.userImg = "https://ui-avatars.com/api/?name=Invitado&background=random"; 
  $scope.sortType = 'top'; // 'top' o 'recent'
$scope.sortExpression = '-likes'; // Por defecto ordena por likes descendente
$scope.showShare = false;
$scope.showSortMenu = false;
$scope.showShareMenu = false;
$scope.inputState = {
      mainComment: ''
  };

   var mockData = [
    {
      header: "Tip: Cómo mejorar la lectura a primera vista",
      content: `
    <p>La lectura a primera vista es el "superpoder" que todo pianista desea. Muchos creen que es un talento innato, pero en realidad es una habilidad que se entrena. El error número uno es mirar constantemente tus manos para asegurar la nota.</p>

    <div class="emphasis-block">
        "Tus ojos deben actuar como un escáner: siempre un compás por delante de lo que tus dedos están tocando."
    </div>

    <h2>La regla de oro: No te detengas</h2>
    <p>Cuando leemos a primera vista, el ritmo es más importante que la nota correcta. Si fallas una nota, sigue tocando. Si te detienes a corregir, rompes el flujo musical y el sentido de la frase.</p>

    <div class="info-box">
        <i class="ri-eye-off-line info-box-icon"></i> <div class="info-box-content">
            <span class="info-box-title">Ejercicio: El mapa táctil</span>
            Tapa tus manos con una tela ligera o un cartón sobre el teclado. Toca escalas simples o piezas que ya conoces sin mirar. Esto fuerza a tu cerebro a desarrollar un "mapa mental" de las distancias entre teclas (propiocepción).
        </div>
    </div>

    <p>Para mejorar hoy mismo, aplica estos pasos antes de tocar la primera nota:</p>
    <ul class="styled-list">
        <li><strong>Escanea la armadura:</strong> Identifica la tonalidad y las alteraciones fijas.</li>
        <li><strong>Busca patrones:</strong> ¿Hay escalas? ¿Arpegios? ¿Acordes repetidos?</li>
        <li><strong>Establece un tempo lento:</strong> Elige una velocidad donde puedas tocar la parte más difícil de la obra, no la más fácil.</li>
    </ul>
`,
      photo: "https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?auto=format&fit=crop&w=150&q=80",
      category: "tip",
      user: "Prof. Mozart",
      date: "2023-10-25T10:00:00",
      media: "img",
      comments: [
      { 
        user: "Ana García", 
        photo: "https://i.pravatar.cc/150?u=a", 
        comment: "¡Excelente consejo!", 
        date: new Date().toISOString(), // Necesario para sort
        likes: 1,
        isLiked: false,
        replies: [] 
      },
      { 
        user: "Carlos M.", 
        photo: "https://i.pravatar.cc/150?u=c", 
        comment: "¿Algún libro recomendado?", 
        date: new Date(Date.now() - 86400000).toISOString(), // Ayer
        likes: 2,
        isLiked: false,
        replies: [
            { user: "Prof. Mozart", photo: "https://lh3.googleusercontent.com/d/15FbOHaYX6jPjCkgfaayMDU3cPpbEM0W3=s700", comment: "Te recomiendo el método Bastien.", date: new Date().toISOString(), likes: 5 }
        ] 
      }
    ]
    },
 
    {
      header: "Anécdota: Como vencí el miedo a presentarme en un escenario",
    content: `
    <p>Recuerdo mi primer recital importante. Tenía 19 años y las manos me sudaban tanto que temía resbalar sobre las teclas negras. Estaba tras bambalinas, repasando obsesivamente ese pasaje difícil del tercer movimiento, convencido de que iba a fallar.</p>
    
    <p>Mi maestro me vio temblando, me puso una mano en el hombro y me dijo algo que cambió mi perspectiva para siempre.</p>

    <div class="emphasis-block">
        "El público no está aquí para juzgarte con una hoja de calificaciones. Están aquí porque quieren sentir algo. No toques para impresionarlos, toca para regalarles la música."
    </div>

    <h2>El cambio de mentalidad</h2>
    <p>Al salir al escenario, dejé de pensar en "no fallar" y empecé a pensar en "compartir". Me equivoqué en dos compases, sí. Una nota sucia por allá, un ritmo apresurado por acá. Pero esa noche, toqué con más dinámica y emoción que nunca.</p>

    <div class="info-box">
        <i class="ri-heart-pulse-fill info-box-icon"></i>
        <div class="info-box-content">
            <span class="info-box-title">La realidad fisiológica</span>
            El miedo escénico es adrenalina. Tu cuerpo te está preparando para correr o pelear. Si aprendes a respirar y canalizar esa energía extra hacia la expresión musical, el miedo se convierte en emoción pura.
        </div>
    </div>

    <p>Hoy en día, sigo sintiendo cosquillas en el estómago antes de salir, pero ya no es miedo; es la emoción de saber que tengo algo valioso que decir a través de mi piano.</p>
`,
      category: "story",
      photo: "https://lh3.googleusercontent.com/d/1646Kq_drvK1Oz0H1LvCkerIzQZxhqqMS",
      user: "Pedro García",
      date: "2023-11-01T08:00:00",
      media: "img",
      comments: []
    },
    {
      "header": "La frase musical: Unidad de sentido",
      "category": "article",
      // CONTENIDO HTML PURO PARA EL DISEÑO
      "content": `
        <p>Una frase musical es una unidad melódica y rítmica completa en sí misma, comparable a una oración en el lenguaje hablado. Se construye típicamente sobre un patrón de pregunta y respuesta, conocido como antecedente y consecuente.</p>
        
        <div class="info-box">
            <i class="ri-alert-fill info-box-icon"></i>
            <div class="info-box-content">
                <span class="info-box-title">Nota Importante</span>
                La comprensión de la frase precede y determina la expresión musical efectiva. Sin análisis previo, la ejecución carecerá de discurso coherente.
            </div>
        </div>

        <h2>La práctica del análisis</h2>
        <p>La práctica del análisis y la escucha activa desarrollan esta habilidad. Aislar la línea melódica principal, cantarla para sentir sus puntos de reposo naturales y marcar las cadencias en la partitura son ejercicios fundamentales.</p>

        <div class="emphasis-block">
            "La repetición exacta sin variación es menos frecuente que la repetición con modificación."
        </div>

        <p>Para identificar una frase en una partitura, busca estos rasgos:</p>
        <ul class="styled-list">
            <li><strong>Extensión:</strong> Generalmente 4 u 8 compases.</li>
            <li><strong>Punto de Reposo:</strong> Debe terminar en una cadencia armónica.</li>
            <li><strong>Diseño Melódico:</strong> Suele tener forma de arco (tensión y relajación).</li>
        </ul>
      `,
      "media": "text",
      "date": new Date().toISOString(),
      "user": "Prof. Alejandro",
      "photo": "https://i.pravatar.cc/150?u=a042581f4e29026024d",
      "comments": [],
    },
  ];

  var config = {
    headers: { "Content-Type": "text/plain;charset=utf-8" }
  };

  $timeout(function() {
      var processedData = mockData.map(function(post) {
              post.content = $sce.trustAsHtml(post.content); 
          return post;
      });

      $scope.data = shuffleArray(processedData);
      $scope.filterPosts('all');
      $scope.userDataLoaded = false;
  }, 100);

  // --- Carga de Usuario ---
  var token = localStorage.getItem('MStoken');
  if(token){
      $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', 
        {action: "getUserData", token: token}, config)
        .then(function (response) {
          if(response.data && response.data.name) {
              $scope.user = response.data.name.split(' ').slice(0, 2).join(' ');
              $scope.userImg = response.data.photo;
          }
        });
  }

  // --- Utilidades ---
  function shuffleArray(array) {
    const shuffled = array.slice();
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }

 $scope.calculateTimeAgoDetailed = function (dateString) {
    if (!dateString) return "";
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    let interval = Math.floor(seconds / 31536000);
    if (interval >= 1) return "hace " + interval + " año" + (interval > 1 ? "s" : "");

    interval = Math.floor(seconds / 2592000);
    if (interval >= 1) return "hace " + interval + " mes" + (interval > 1 ? "es" : "");

    interval = Math.floor(seconds / 604800); // Semanas
    if (interval >= 1) return "hace " + interval + " sem.";

    interval = Math.floor(seconds / 86400); // Días
    if (interval >= 1) return "hace " + interval + " día" + (interval > 1 ? "s" : "");

    interval = Math.floor(seconds / 3600); // Horas
    if (interval >= 1) return "hace " + interval + " h";

    interval = Math.floor(seconds / 60); // Minutos
    if (interval >= 1) return "hace " + interval + " min";

    return "hace un momento";
};

  // --- Filtros ---
 $scope.filterPosts = function (type) {
    $scope.filter = type;
    if (type === 'all') {
      $scope.filteredData = $scope.data;
    } else {
      // Filtrar por la propiedad 'category'
      $scope.filteredData = $scope.data.filter(post => post.category === type);
    }
    $scope.itemsPerPage = 10;
  };

  $scope.loadMorePosts = function () {
    $scope.itemsPerPage += 5;
  };

  // --- Modal de Lectura ---
  $scope.selectedPostForComments = null;



$scope.openComments = function (post) {
    $scope.selectedPostForComments = post;
    document.body.style.overflow = 'hidden'; // Bloquea el scroll de la lista de atrás
};

$scope.backToFeed = function () {
    $scope.selectedPostForComments = null;
    document.body.style.overflow = ''; // Restaura el scroll
};





$scope.toggleSortMenu = function(e) {
    e.stopPropagation(); // Evitar burbujeo
    $scope.showSortMenu = !$scope.showSortMenu;
    $scope.showShareMenu = false; // Cerrar el otro si está abierto
};

$scope.setSort = function(type) {
    $scope.sortType = type;
    if (type === 'top') {
        $scope.sortExpression = '-likes';
    } else {
        $scope.sortExpression = '-date';
    }
    $scope.showSortMenu = false; // Cerrar al seleccionar
};



$scope.copyLink = function() {
    // Simular URL del post
    const dummyLink = window.location.href + "?post=" + Math.floor(Math.random() * 1000);
    
    navigator.clipboard.writeText(dummyLink).then(function() {
        alert("Link copiado al portapapeles");
        $scope.$apply(function(){
           $scope.showShareMenu = false; 
        });
    }, function(err) {
        console.error('Error al copiar', err);
    });
};

// --- 3. Likes y Respuestas ---
$scope.likeItem = function(item) {
    if(!item.likes) item.likes = 0;
    
    if(item.isLiked) {
        item.likes--;
        item.isLiked = false;
    } else {
        item.likes++;
        item.isLiked = true;
    }
};


$scope.addComment = function () {
    if (!$scope.selectedPostForComments || !$scope.inputState.mainComment || $scope.inputState.mainComment.trim() === '') return;
    
    var newComment = {
      user: $scope.user,
      photo: $scope.userImg,
      comment: $scope.inputState.mainComment, // Usar el objeto
      date: new Date().toISOString(),
      likes: 0,
      replies: []
    };

    if (!$scope.selectedPostForComments.comments) $scope.selectedPostForComments.comments = [];
    
    $scope.selectedPostForComments.comments.unshift(newComment);

    $scope.inputState.mainComment = ''; 
    var inputElement = document.getElementById('mainCommentInput');
    if(inputElement) inputElement.blur();
  };

$scope.checkEnterMain = function(event) {
    if (event.keyCode === 13 && !event.shiftKey) {
        event.preventDefault();
        $scope.addComment();
    }
  };
// b) Respuestas a Comentarios
$scope.replyToComment = function(parentComment) {
    if (!parentComment.newReplyText || parentComment.newReplyText.trim() === '') return;

    var newReply = {
        user: $scope.user,
        photo: $scope.userImg,
        comment: parentComment.newReplyText,
        date: new Date().toISOString(),
        likes: 0
    };

    if (!parentComment.replies) parentComment.replies = [];
    
    parentComment.replies.push(newReply);
    parentComment.newReplyText = ''; // Limpiar input
    parentComment.showReplyForm = false; // Cerrar form
    
    // Auto-abrir la lista de respuestas al responder
    parentComment.showReplies = true;
};

$scope.checkEnterReply = function(event, parentComment) {
    if (event.keyCode === 13) {
        event.preventDefault();
        $scope.replyToComment(parentComment);
    }
};




}]);
</script>
</html>
