<!DOCTYPE html>
<html lang="es" ng-app="dashboardApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<style>
:root {
    --primary-color: #FF4757;
    --secondary-color: #2ed573;
    --bg-light: #f8f9fa;
    --card-bg: #ffffff;
    --text-dark: #2f3542;
    --text-muted: #6c757d;
    --border-color: #dee2e6;
    --danger-color: #ff4757;
    --piano-bg: #2a2a2a;
    --piano-height: 150px;
    --key-white-height: 100px;
    --key-black-height: 65px;
    --accent-red: #FF4757;
    --font-mono: 'JetBrains Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: 'Inter', sans-serif; 
    background: var(--bg-light);
    min-height: 100vh; 
    color: var(--text-dark);
}


/* ==================== HIGH KEY BANNER ==================== */
.banner-header {
    position: relative;
    width: 100%;
    height: 240px;
    overflow: hidden;
    background-color: #fff;
    margin-bottom: 0; /* Pegado al contenido */
}

.banner-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
   object-position: center 40%;
}

.banner-overlay {
    position: absolute;
    inset: 0;
     background: linear-gradient(to bottom, 
                rgba(248, 249, 250, 0.35) 0%, 
                rgba(248, 249, 250, 0.25) 50%, 
                rgba(248, 249, 250, 1) 100%);
}

.banner-text {
    position: absolute;
    top: 50%;
    left: 6%; /* Alineado a la izquierda como el dashboard */
    transform: translateY(-50%);
    z-index: 5;
    color: #1a1a1a;
    text-shadow: 0 4px 12px rgba(0,0,0,0.1); 
}

.banner-text h1 {
    font-size: 38px;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 5px;
    letter-spacing: -1px;
}

.banner-text .subtitle {
  font-family: var(--font-mono);
    font-size: 12px; /* REDUCIDO */
   color: var(--accent-red);
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}


.banner-loader {
    position: absolute;
    bottom: 25px;
    right: 30px;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(5px);
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.05);
    color: #4b5563;
    font-size: 0.85rem;
    font-weight: 600;
    transition: opacity 0.3s ease;
}

.container { max-width: 1100px; margin: 0 auto; padding: 20px; }

/* ==================== DASHBOARD STYLES ==================== */
.dashboard-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 25px;
}

.card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid var(--border-color);
}

.section-title {
    font-size: 18px; 
    margin-bottom: 20px; 
    font-weight: 800;
}

/* AGENDA STYLES */
.agenda-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 260px;  /* Altura máxima (ajusta este número según el espacio que quieras) */
    overflow-y: auto;   /* Activa el scroll vertical automático */
    padding: 10px;
}

.agenda-list::-webkit-scrollbar {
    width: 6px;
}

.agenda-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.agenda-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
}

.agenda-list::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color); /* Se pone roja al pasar el mouse */
}

.agenda-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    background: white;
}

.agenda-item.past {
    background: #f1f2f6;
    border-color: transparent;
    color: #a4b0be;
}

.agenda-item.past h4 {
    text-decoration: line-through;
    color: #a4b0be;
}

.agenda-item.past .date-box {
    opacity: 0.6;
}

.status-finished {
    font-size: 10px;
    text-transform: uppercase;
    background: #dfe4ea;
    color: #747d8c;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 700;
    display: inline-block;
    margin-top: 4px;
    text-decoration: none !important;
}

.agenda-item.next {
    background: #ffffff;
    border: 2px solid var(--primary-color);
    box-shadow: 0 8px 20px rgba(255, 71, 87, 0.15);
    transform: scale(1.01);
    z-index: 2;
}

.agenda-item.next h4 {
    color: var(--primary-color);
    font-weight: 800;
}

.status-next-badge {
    background: var(--primary-color);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.agenda-item.future:hover {
    border-color: var(--primary-color);
    transform: translateX(5px);
    cursor: pointer;
}

.agenda-date {
    display: flex;
    align-items: center;
    gap: 15px;
}

.date-box {
    text-align: center;
    min-width: 50px;
    padding-right: 15px;
    border-right: 1px solid var(--border-color);
}

.date-day { font-size: 20px; font-weight: 800; line-height: 1; }
.date-month { font-size: 11px; text-transform: uppercase; font-weight: 600; }

.class-details h4 { font-size: 15px; margin-bottom: 2px; font-weight: 700; }
.meta-text { font-size: 13px; color: var(--text-muted); }

/* SIDEBAR */
.sidebar-title { font-size: 15px; margin-bottom: 20px; font-weight: 700; }
.sidebar-card { margin-bottom: 20px; }

.materials-list { display: flex; flex-direction: column; gap: 10px; }

.material-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-radius: 8px;
    background: var(--bg-light);
    transition: 0.2s;
}

.material-item:hover { background: #e9ecef; }

.file-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }

.file-icon {
    width: 32px; height: 32px;
    background: white;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    color: #e74c3c;
    flex-shrink: 0;
}

.file-details h4 {
    font-size: 13px; font-weight: 600;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 140px;
}

.file-details p { font-size: 11px; color: var(--text-muted); }

.download-btn {
    width: 28px; height: 28px;
    background: var(--primary-color);
    color: white;
    display: flex; align-items: center; justify-content: center;
    border-radius: 6px;
    font-size: 12px;
    text-decoration: none;
    flex-shrink: 0;
    border: none;
    cursor: pointer;
}

.download-btn:hover { background: #ff6b81; }

/* CLASS HEADER */
.class-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
}

.class-title h2 { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
.class-title p { font-size: 13px; color: var(--text-muted); }

.status-badge {
    background: #d1fae5; color: #065f46;
    padding: 6px 12px; border-radius: 20px;
    font-size: 12px; font-weight: 700;
}

.class-info-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;
}

.info-box {
    background: var(--bg-light); padding: 15px; border-radius: 12px;
    display: flex; align-items: center; gap: 12px;
}

.info-icon {
    width: 40px; height: 40px; background: white; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.status-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.led-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.led-red {
    background-color: #dc3545; /* Rojo */
    box-shadow: 0 0 5px #dc3545;
}

.led-green {
    background-color: #28a745; /* Verde */
    box-shadow: 0 0 5px #28a745;
}

.led-orange-blink {
    background-color: #fd7e14; /* Naranja */
    box-shadow: 0 0 5px #fd7e14;
    animation: blink-animation 1s infinite;
}

@keyframes blink-animation {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
}

.status-text h4 {
    margin: 0;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

.status-text small {
    color: #666;
    font-size: 12px;
}

.join-btn {
    width: 100%; background: var(--primary-color); color: white;
    border: none; padding: 16px; border-radius: 12px;
    font-size: 16px; font-weight: 700; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); transition: 0.3s;
    transition: background-color 0.3s;
}

.join-btn:hover { background: #ff6b81; transform: translateY(-2px); }
.join-btn:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; transform: none; }

.btn-blue { background-color: #007bff; color: white; } /* Normal */
.btn-orange { background-color: #fd7e14; color: white; cursor: wait; } /* Conectando */
.btn-red { background-color: #dc3545; color: white; }

.security-note { text-align: center; margin-top: 12px; font-size: 12px; color: var(--text-muted); }

/* TEACHER PROFILE */
.teacher-profile { text-align: center; }

.teacher-avatar {
    width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
    margin-bottom: 10px; border: 3px solid var(--bg-light);
}

.teacher-name { font-weight: 700; margin-bottom: 2px; }
.teacher-specialty { font-size: 12px; color: var(--text-muted); margin-bottom: 15px; }

.teacher-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.action-btn {
    background: white; border: 1px solid var(--border-color);
    padding: 10px; border-radius: 8px; color: var(--text-dark);
    font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
}

.action-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
.action-btn.cancel { color: #2ed573; }
.action-btn.cancel:hover { border-color: #2ed573; background: #f0fff4; }

/* LIBRARY BUTTON */
.library-btn {
    width: 100%;
    background: white;
    border: 1px solid var(--border-color);
    color: var(--text-dark);
    padding: 14px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    display: flex; align-items: center; justify-content: center; gap: 8px;
}

.library-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

/* MODAL BIBLIOTECA */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    display: flex; justify-content: center; align-items: center;
    opacity: 0; visibility: hidden; transition: 0.3s; z-index: 1000;
}

.modal-overlay.active { opacity: 1; visibility: visible; }

.library-content {
    background: #f8f9fa;
    width: 850px;
    max-width: 95%;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    position: relative;
}

.library-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px;
}

.library-header h3 { font-size: 20px; font-weight: 800; }

.close-icon {
    background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted);
}

.close-icon:hover { color: var(--danger-color); }

/* CAROUSEL */
.carousel-wrapper {
    display: flex;
    overflow-x: auto;
    gap: 25px;
    padding: 10px 5px 25px 5px;
    scroll-behavior: smooth;
    scrollbar-width: thin; 
    scrollbar-color: #ccc transparent;
}

.carousel-wrapper::-webkit-scrollbar { height: 6px; }
.carousel-wrapper::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
.carousel-wrapper::-webkit-scrollbar-track { background: transparent; }

.book-card {
    min-width: 180px;
    max-width: 180px;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.3s ease;
    text-decoration: none;
}

.book-card:hover { transform: translateY(-8px); }

.book-cover-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    margin-bottom: 15px;
    background: white;
}

.book-img {
    width: 100%;
    height: auto;
    display: block;
    aspect-ratio: 3/4;
    object-fit: cover;
}

.book-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex; justify-content: center; align-items: center;
    opacity: 0; transition: 0.3s;
}

.book-card:hover .book-overlay { opacity: 1; }
.book-overlay i { color: white; font-size: 30px; }

.book-info h4 {
    font-size: 16px; font-weight: 800; color: var(--text-dark);
    margin-bottom: 4px; line-height: 1.2;
}

.book-info p {
    font-size: 14px; color: var(--text-muted); font-weight: 500;
}

/* ==================== LIVE SESSION STYLES ==================== */
.live-wrapper {
    width: 100%;
    height: 100vh;
    overflow: hidden;
    position: fixed;
    top: 0; left: 0;
    z-index: 999;
    background: #000;
    font-family: 'Inter', sans-serif;
}

.live-session-container {
    display: grid;
    grid-template-columns: 1fr 320px;
    height: 100%;
    width: 100%;
}

.live-stage-area {
    display: flex;
    flex-direction: column;
    height: 100vh; 
    max-height: 100vh;
    background: #000;
    position: relative;
    /* CAMBIO: Eliminar o cambiar overflow: hidden */
    overflow: hidden; /* Mantenlo hidden aquí para que el piano no se mueva */
}

.live-main-video {
    flex-grow: 1;
    min-height: 0;
    position: relative;
    
    /* CAMBIO 1: Habilitar scroll aquí */
    overflow-y: auto !important; 
    overflow-x: hidden;
    
    /* CAMBIO 2: Cambiar display flex a block para que el scroll fluya natural */
    display: block; 
}

#remote-video {
    width: 100%; /* Ocupa todo el ancho */
    
    /* CAMBIO CRÍTICO: Deja que la altura crezca lo que sea necesario */
    height: auto !important; 
    min-height: 100%; /* Para asegurar que al menos llene la pantalla */
    
    /* CAMBIO OPCIONAL: Elimina object-fit o usa contain */
    object-fit: contain; 
    display: block;
}

/* HEADER OVERLAY */
.live-overlay-header {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px;
background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
display: flex; justify-content: space-between; align-items: flex-start;
z-index: 20; pointer-events: none;
}.live-class-meta { display: flex; align-items: center; gap: 15px; pointer-events: auto; }
.live-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary-color); }.live-text h2 {
color: white; font-size: 18px;
text-shadow: 0 2px 4px rgba(0,0,0,0.8);
margin: 0;
}.live-text p { color: #ddd; font-size: 14px; margin: 0; }.live-timer {
background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
padding: 5px 15px; border-radius: 20px; color: white;
border: 1px solid rgba(255,255,255,0.2); pointer-events: auto;
font-family: monospace; font-size: 16px;
}/* PIP VIDEO */
.live-pip-video {
position: absolute; top: 60px; right: 20px; 
width: 140px; height: 100px;
background: rgba(0,0,0,0.6);
border: 1px solid rgba(255,255,255,0.2);
border-radius: 12px;
z-index: 1001;
overflow: hidden;
backdrop-filter: blur(3px);
transition: 0.3s;
opacity: 0.7;
}.live-pip-video:hover {
opacity: 1;
transform: scale(1.05);
border-color: white;
box-shadow: 0 8px 25px rgba(0,0,0,0.4);
}/* CONTROLS */
.live-controls-dock {
position: fixed; bottom: 155px; left: 35%; transform: translateX(-50%) scale(0.8);
background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
padding: 10px 25px; border-radius: 50px;
display: flex; gap: 15px; border: 1px solid rgba(255,255,255,0.1);
z-index: 1000;
}

.live-btn {
width: 50px; height: 50px; border-radius: 50%; border: none;
font-size: 20px; cursor: pointer; color: white;
background: rgba(0, 0, 0, 0.5);
transition: 0.2s;
display: flex; align-items: center; justify-content: center;
}.live-btn:hover { background: #555; transform: translateY(-3px); }.live-btn.active-mic {
background: #dc3545;
box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
}.live-btn.active-cam {
background: #1877F2;
box-shadow: 0 0 15px rgba(24, 119, 242, 0.5);
}.live-btn.hangup {
background: var(--danger-color);
width: 60px;
border-radius: 30px;
}/* PIANO AREA */
.live-piano-area {
height: var(--piano-height);
background: var(--piano-bg);
position: relative;
border-top: 1px solid #444;
z-index: 35;
flex-shrink: 0;
}#piano-top-casing {
position: relative;
width: 100%;
height: 20px;
background: #333;
z-index: 4;
display: flex;
justify-content: center;
border-radius: 4px 4px 0 0;
}.casing-note-label {
position: absolute;
top: 10px;
color: #fff;
font-size: 11px;
font-weight: 600;
background: rgba(0,0,0,0.6);
padding: 2px 6px;
border-radius: 4px;
pointer-events: none;
transform: translateX(-50%);
z-index: 20;
white-space: nowrap;
}#piano-wrapper-live {
position: relative;
width: 100%;
height: calc(var(--piano-height) - 20px);
display: flex;
justify-content: center;
overflow-x: auto;
overflow-y: hidden;
}#piano-wrapper-live::-webkit-scrollbar { height: 8px; background: #222; }
#piano-wrapper-live::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }#hit-line {
position: absolute;
top: 5px;
left: 0;
width: 100%;
height: 4px;
background: rgba(255, 0, 0, 0.7);
box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
z-index: 10;
pointer-events: none;
}#piano-keys-container {
position: relative;
display: flex;
margin-top: 10px;
height: 100%;
}.key {
position: relative;
float: left;
cursor: pointer;
transition: all 0.05s;
}.key.white {
width: 24px;
height: var(--key-white-height);
background: #fff;
border: 1px solid #ccc;
border-right: 1px solid #e0e0e0;
border-radius: 0 0 4px 4px;
z-index: 1;
}.key.white.active {
background: var(--primary-color);
box-shadow: 0 0 15px rgba(255, 71, 87, 0.6);
transform: translateY(2px);
}.key.black {
width: 14px;
height: var(--key-black-height);
background: #333;
border: 1px solid #555;
margin-left: -7px;
margin-right: -7px;
z-index: 2;
border-radius: 0 0 3px 3px;
}.key.black.active {
background: var(--primary-color) !important;
box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
border: 1px solid rgba(255, 255, 255, 0.6) !important;
border-bottom: 2px solid rgba(255, 255, 255, 0.8) !important;
}/* SIDEBAR */
.live-sidebar {
background: white;
border-left: 1px solid #ddd;
display: flex;
flex-direction: column;
z-index: 50;
height: 100%; 
    overflow: hidden;
}.live-visualizer-box {
height: 160px;
background: #fff;
border-bottom: 1px solid #eee;
position: relative;
display: flex;
flex-direction: column;
}.chord-toast {
position: absolute;
top: 10px;
left: 0;
width: 100%;
text-align: center;
color: var(--primary-color);
font-weight: 800;
font-size: 20px;
z-index: 10;
}#staff-container {
flex: 1;
width: 100%;
position: relative;
}/* TABS */
.live-tabs {
display: flex;
border-bottom: 1px solid #eee;
flex-shrink: 0;
}.live-tab {
flex: 1;
padding: 15px;
border: none;
background: #f9f9f9;
cursor: pointer;
font-weight: 600;
color: #888;
transition: 0.2s;
}.live-tab.active {
background: white;
color: var(--primary-color);
border-bottom: 3px solid var(--primary-color);
}.live-panel-content {
flex: 1;
overflow-y: auto;
padding: 0;
display: flex;
flex-direction: column;
overflow: hidden;
    min-height: 0;
}/* CHAT */
.live-chat-list {
flex: 1;
padding: 15px;
overflow-y: auto;
display: flex;
flex-direction: column;
gap: 10px;
}
.scrollable-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}
.live-msg {
display: flex;
gap: 10px;
font-size: 13px;
}.live-msg.me {
flex-direction: row-reverse;
}.live-msg-bubble {
background: #f1f2f6;
padding: 10px;
border-radius: 12px;
max-width: 80%;
}.live-msg.me .live-msg-bubble {
background: var(--primary-color);
color: white;
}.live-chat-input {
padding: 15px;
border-top: 1px solid #eee;
display: flex;
gap: 10px;
flex-shrink: 0;
}.live-input {
flex: 1;
padding: 10px;
border-radius: 20px;
border: 1px solid #ddd;
outline: none;
}.send-btn {
width: 36px;
height: 36px;
background: var(--primary-color);
color: white;
border: none;
border-radius: 50%;
cursor: pointer;
font-size: 12px;
}/* MATERIALS */
.live-mat-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 15px;
border-bottom: 1px solid #f5f5f5;
transition: 0.2s;
}.live-mat-item:hover {
background: #f9f9f9;
}/* FOOTER METRONOMO */
.live-footer {
padding: 15px;
border-top: 1px solid #eee;
background: #fcfcfc;
flex-shrink: 0;
}.metro-control-box {
display: flex;
justify-content: space-between;
align-items: center;
background: white;
border: 1px solid #ddd;
padding: 8px 15px;
border-radius: 10px;
}.metro-btn-small {
width: 28px;
height: 28px;
border-radius: 6px;
border: 1px solid var(--border-color);
background: white;
cursor: pointer;
color: var(--text-muted);
font-size: 12px;
}.metro-play {
width: 36px;
height: 36px;
border-radius: 50%;
border: none;
background: var(--text-dark);
color: white;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: 0.2s;
}.metro-play.active {
background: var(--primary-color);
box-shadow: 0 0 10px rgba(255, 71, 87, 0.4);
}/* SVG VISUALIZER */
.staff-line { stroke: #999; stroke-width: 1; }
.ledger-line { stroke: #999; stroke-width: 1; }
.note-head { fill: #333; }
.note-stem { stroke: #333; stroke-width: 2; }
.note-accidental { fill: #333; font-family: serif; font-size: 20px; font-weight: bold; }
.clef { fill: #333; font-family: serif; font-size: 60px; }
.bass-clef { font-size: 55px; }/* MODAL DRAGGABLE */
.live-modal {
position: absolute;
top: 10%;
left: 10%;
width: 600px;
height: 500px;
background: white;
border-radius: 8px;
box-shadow: 0 20px 50px rgba(0,0,0,0.5);
display: flex;
flex-direction: column;
z-index: 1000;
overflow: hidden;
}.live-modal-header {
background: #333;
color: white;
padding: 10px 15px;
display: flex;
justify-content: space-between;
align-items: center;
cursor: move;
user-select: none;
}/* RESPONSIVE */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4); /* Fondo blanco semitransparente */
    backdrop-filter: blur(8px); /* <--- AQUÍ ESTÁ EL EFECTO BORROSO */
    z-index: 9999; /* Por encima de todo */
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.loading-content {
    background: white;
    padding: 30px 50px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
    border: 1px solid var(--border-color);
}

.loading-content p {
    margin-top: 15px;
    font-weight: 600;
    color: var(--text-dark);
}

/* Spinner animado */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    margin: 0 auto;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@media (max-width: 900px) {
.dashboard-grid { grid-template-columns: 1fr; }
.live-session-container { grid-template-columns: 1fr; }
.live-sidebar { display: none; }
.live-pip-video { width: 100px; height: 75px; top: 60px; }
.key.white { width: 18px; }
.key.black { width: 10px; margin: 0 -5px; }
}@media (max-width: 768px) {
.key.white { width: 14px; }
.key.black { width: 9px; margin-left: -4.5px; margin-right: -4.5px; }
}@media (max-width: 550px) {
      .banner-text {
                left: 20px;
                right: 20px; 
                max-width: 100%;
            }
            .banner-text h1 {
                font-size: 32px;
            }
.key.white { width: 11px; height: 75px; }
.key.black { width: 7px; height: 48px; margin-left: -3.5px; margin-right: -3.5px; }
.live-modal { width: 95%; height: 80%; top: 10% !important; left: 2.5% !important; }
}
</style>
<body>
  <div id="app"> <div class="banner-header" v-show="currentView === 'dashboard'">
        <img src="https://lh3.googleusercontent.com/d/17COvDCHgM1s1NJXm9cddvj4E6927k2wt" class="banner-image">
        <div class="banner-overlay"></div>
        <div class="banner-text">
            <h1><span class="subtitle">Aula Virtual</span> Sesiones</h1>
             <p style="color: #596275; margin-top: 10px; font-weight: 500;">
                Sistema de aprendizaje secuencial.
            </p>
        </div>
        <div class="banner-loader" v-show="connectionStatus === 'connecting'">
            <i class="fas fa-circle-notch fa-spin"></i>
            <span>Conectando...</span>
        </div>
        <div class="banner-loader" v-show="isLoading">
            <i class="fas fa-circle-notch fa-spin"></i>
            <span>Actualizando...</span>
        </div>
    </div>

    <div class="container" v-show="currentView === 'dashboard'">
        <br>
        <div class="dashboard-grid">
            <div class="main-content">
                <div class="card">
                    <div class="class-header">
                        <div class="class-title">
                            <div class="status-container">
                                <span class="led-dot" 
                                    :class="{
                                        'led-red': connectionStatus === 'idle' || connectionStatus === 'failed',
                                        'led-orange-blink': connectionStatus === 'connecting',
                                        'led-green': connectionStatus === 'connected'
                                    }">
                                </span>
                                <div class="status-text">
                                    <h4>{{ getStatusTitle }}</h4> <small>{{ getStatusSubtitle }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge">Confirmada</div>
                    </div>

                    <div class="class-info-grid">
                        <div class="info-box">
                            <div class="info-icon"><i class="far fa-calendar-alt"></i></div>
                            <div class="info-text">
                                <h4>Fecha</h4>
                                <p>{{nextClass.dateStr}}</p>
                            </div>
                        </div>
                        <div class="info-box">
                            <div class="info-icon"><i class="far fa-clock"></i></div>
                            <div class="info-text">
                                <h4>Hora</h4>
                                <p>{{nextClass.time}}</p>
                            </div>
                        </div>
                    </div>

                    <div class="controls-area">
                        <button class="join-btn"
                            @click="joinClass"
                            :disabled="connectionStatus === 'connecting' || connectionStatus === 'connected'"
                            :class="{
                                'btn-blue': connectionStatus === 'idle' || connectionStatus === 'ended',
                                'btn-orange': connectionStatus === 'connecting',
                                'btn-red': connectionStatus === 'failed'
                            }">
                            
                            <span v-if="connectionStatus === 'idle'">Conectarse a la clase</span>
                            <span v-if="connectionStatus === 'connecting'">Solicitando acceso...</span>
                            <span v-if="connectionStatus === 'failed'">Sin respuesta (Recargando)</span>
                            <span v-if="connectionStatus === 'connected'">Conectado</span>
                            <span v-if="connectionStatus === 'ended'">Volver a conectarse</span>
                        </button>
                    </div>
                    <p class="security-note"><i class="fas fa-lock"></i> Conexión segura y encriptada</p>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 class="section-title">Agenda</h3>
                    <div class="agenda-list">
                        <div class="agenda-item" 
                             v-for="(clase, index) in schedule" 
                             :key="index"
                             :class="clase.status"
                             :id="clase.status === 'next' ? 'scroll-target' : ''">
                            <div class="agenda-date">
                                <div class="date-box">
                                    <div class="date-day">{{clase.dayNum}}</div>
                                    <div class="date-month">{{clase.monthStr}}</div>
                                </div>
                                <div class="class-details">
                                    <h4>{{clase.title}}</h4>
                                    <p class="meta-text">{{clase.time}} • 60 min</p>
                                </div>
                            </div>
                            <div class="agenda-action">
                                <span class="status-next-badge" v-if="clase.status === 'next'">Próxima</span>
                                <i class="fas fa-chevron-right" style="color: #ccc;" v-if="clase.status === 'future'"></i>
                                <span class="status-finished" v-if="clase.status === 'past'">Finalizada</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="card sidebar-card">
                    <h3 class="sidebar-title">Tu Profesor</h3>
                    <div class="teacher-profile">
                        <img :src="teacher.photo" class="teacher-avatar">
                        <div class="teacher-name">{{teacher.name}}</div>
                        <div class="teacher-specialty">{{teacher.specialty}}</div>
                        <div class="teacher-actions">
                            <button class="action-btn" @click="sendMessage">
                                <i class="far fa-comment-dots"></i> Chat
                            </button>
                            <button class="action-btn cancel" @click="cancelClass(teacher.num)">
                                <i class="fa-brands fa-whatsapp" style="font-size: 15px"></i> Whatsapp
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card sidebar-card">
                    <h3 class="sidebar-title">Archivos de Clase</h3>
                    <div>
                        <button class="library-btn" @click="openLibrary">
                            <i class="fas fa-layer-group"></i> Ver Biblioteca de Unidades
                        </button>
                    </div>
                    <div class="materials-list" style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                         <h3 class="sidebar-title">Archivos complementarios</h3>
                        <div class="material-item" v-for="(file, i) in materials" :key="i">
                            <div class="file-info">
                                <div class="file-icon">
                                    <i class="fas" :class="file.icon"></i>
                                </div>
                                <div class="file-details">
                                    <h4 :title="file.title">{{file.title}}</h4>
                                    <p>{{file.size}}</p>
                                </div>
                            </div>
                            <a :href="file.url" target="_blank" class="download-btn">
                                <i class="fas fa-arrow-up-right-from-square"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; font-size: 13px; color: var(--text-muted);">
                    ¿Problemas técnicos? <br>
                    <a href="#" style="color: var(--primary-color); font-weight: 600;">Contactar Soporte</a>
                </div>
            </aside>
        </div>
    </div>

    <div class="live-wrapper" v-show="currentView === 'live'">
        <div class="live-session-container">
            <div class="live-stage-area">
                <div class="live-overlay-header">
                    <div class="live-class-meta">
                        <img :src="teacher.photo" class="live-avatar">
                        <div class="live-text">
                            <h2>{{teacher.name}}</h2>
                            <p>{{nextClass.title}} • En Vivo</p>
                        </div>
                    </div>
                    <div class="live-timer">
                        <i class="fas fa-circle" style="color: red; font-size: 10px;"></i>
                        {{liveTimerDisplay}}
                    </div>
                </div>

                <div class="live-main-video">
                    <img v-show="!remoteStreamActive" src="https://lh3.googleusercontent.com/d/14Z2nzr2OrqWXu_CtVEc203hy7_eJfwSP=s1000" 
                         style="width: 100%; height: 100%; object-fit: cover;">
                    
                    <video id="remote-video" autoplay playsinline 
                           v-show="remoteStreamActive"
                           style="width: 100%; height: 100%; object-fit: cover; background: #000;">
                    </video>
                </div>
                
                <div class="live-pip-video" id="pipContainer">
                    <video id="student-video" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover; display:none;"></video>
                    <div v-show="!camOn" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:white;">
                        <i class="fas fa-video-slash" style="font-size: 24px;"></i>
                    </div>
                </div>

                <div class="live-controls-dock">
                    <button class="live-btn" :class="{'active-mic': micOn}" @click="toggleMic">
                        <i class="fas" :class="micOn ? 'fa-microphone' : 'fa-microphone-slash'"></i>
                    </button>
                    <button class="live-btn" :class="{'active-cam': camOn}" @click="toggleCam">
                        <i class="fas" :class="camOn ? 'fa-video' : 'fa-video-slash'"></i>
                    </button>
                    <button class="live-btn hangup" @click="leaveClass">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>

                <div class="live-piano-area">
                    <div id="piano-top-casing"></div>
                    <div id="piano-wrapper-live">
                        <div id="hit-line"></div>
                        <div id="piano-keys-container"></div>
                    </div>
                </div>
            </div>

            <aside class="live-sidebar">
                <div class="live-visualizer-box">
                    <div class="chord-toast">{{detectedChord}}</div>
                    <div id="staff-container" style="flex:1; width:100%;">
                        <svg id="staff-svg" width="100%" height="100%"></svg>
                    </div>
                </div>

                <div class="live-footer">
                    <div class="metro-control-box">
                        <div style="font-size: 11px; font-weight: 700; color:#888;">METRÓNOMO</div>
                        <div style="font-weight: 800; font-size: 18px;">{{bpm}} BPM</div>
                        <div style="display:flex; gap:5px;">
                            <button class="metro-btn-small" @click="changeBpm(-5)">-5</button>
                            <button class="metro-play" @click="toggleMetronome" :class="{'active': isMetroPlaying}">
                                <i class="fas" :class="isMetroPlaying ? 'fa-pause' : 'fa-play'"></i>
                            </button>
                            <button class="metro-btn-small" @click="changeBpm(5)">+5</button>
                        </div>
                    </div>
                </div>

                <div class="live-tabs">
                    <button class="live-tab" :class="{'active': activeTab=='chat'}" @click="activeTab='chat'">Chat</button>
                    <button class="live-tab" :class="{'active': activeTab=='materials'}" @click="activeTab='materials'">Material</button>
                </div>

                <div class="live-panel-content" v-show="activeTab=='chat'">
                    <div class="live-chat-list" id="chatList">
                        <div class="live-msg" v-for="(msg, i) in chatMessages" :key="i" :class="{'me': msg.isMe}">
                            <img v-if="!msg.isMe" :src="teacher.photo" style="width: 25px; height: 25px; border-radius: 50%;">
                            <div class="live-msg-bubble">
                                <strong>{{msg.sender}}</strong><br>
                                {{msg.text}}
                            </div>
                        </div>
                    </div>
                    <div class="live-chat-input">
                        <input type="text" class="live-input" placeholder="Escribe algo..." v-model="chatInput" @keyup.enter="sendChatMessage">
                        <button class="send-btn" @click="sendChatMessage"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <div class="live-panel-content" v-show="activeTab=='materials'">
                    <div class="scrollable-list">
                       <div class="live-mat-item" v-for="(mat, i) in materials" :key="i">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <i class="fas" :class="mat.icon" style="color:var(--primary-color);"></i>
                                <div>
                                    <div style="font-weight:700; font-size:13px;">{{mat.title}}</div>
                                    <div style="font-size:11px; color:#888;">{{mat.type}}</div>
                                </div>
                            </div>
                            <button class="download-btn" @click="openPdf(mat.url)">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <div class="live-modal" v-show="showPdfModal" id="draggableModal">
            <div class="live-modal-header" id="modalHeader">
                <span><i class="fas fa-file-alt"></i> Visualizador de Material</span>
                <button @click="closePdfModal" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">×</button>
            </div>
            <div style="flex:1; background:#eee;">
                <iframe id="pdfIframe" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>

    <div class="modal-overlay" :class="{'active': showLibraryModal}">
        <div class="library-content">
            <div class="library-header">
                <h3><i class="fas fa-book-open"></i> Material Didáctico</h3>
                <button class="close-icon" @click="closeLibrary"><i class="fas fa-times"></i></button>
            </div>
            
            <p style="color: var(--text-muted); margin-bottom: 20px;">
                Accede a los libros y partituras de niveles anteriores.
            </p>

           <div class="carousel-wrapper">
                <a class="book-card" 
                   v-for="(book, i) in libraryBooks" 
                   :key="i"
                   href="#" 
                   @click.prevent="downloadBook(book)">
                   
                    <div class="book-cover-container">
                        <img :src="book.cover" class="book-img">
                        <div class="book-overlay">
                            <i class="fas fa-download"></i>
                        </div>
                    </div>
                    <div class="book-info">
                        <h4>{{book.level}}</h4>
                        <p>{{book.unit}}</p>
                    </div>
                </a>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="join-btn" style="padding: 12px; width: auto;" @click="closeLibrary">
                    Cerrar Biblioteca
                </button>
            </div>
        </div>
    </div>
  
  <div class="loading-overlay" v-if="isDownloading">
    <div class="loading-content">
        <div class="spinner"></div>
        <p>Preparando descarga...</p>
    </div>
</div>
  </div> 
</body>

<script>
const { createApp, ref, reactive, computed, onMounted, nextTick, onBeforeUnmount } = Vue;

const app = createApp({
    setup() {
        // ==================== STATE VARIABLES ====================
        const schedule = ref([]);
        const nextClass = ref({});
        const canJoin = ref(true);
        const isLoading = ref(true);
        const isDownloading = ref(false);
        const currentView = ref('dashboard');
        const activeTab = ref('chat');
        const micOn = ref(false);
        const camOn = ref(false);
        const bpm = ref(60);
        const isMetroPlaying = ref(false);
        const liveTimerDisplay = ref("00:00");
        const detectedChord = ref("---");
        const chatInput = ref("");
        const showPdfModal = ref(false);
        const showLibraryModal = ref(false);
        const userName = ref("");
        
        // WebRTC & Firebase Vars
        const connectionStatus = ref('idle');
        const remoteStreamActive = ref(false);
        const chatMessages = ref([
            { sender: "Profesor", text: "¡Hola! Prueba el nuevo piano interactivo.", isMe: false }
        ]);
        
        let peer = null;
        let db = null;
        let room = "piano-class";
        let myId = "alumno-" + Math.floor(Math.random() * 10000);
        let rtcLocalStream = null;
        let usersRef = null;
        let signalsRef = null;
        let midiAccess = null;
        let midiInput = null;
        let connectionTimeoutPromise = null;
        const TIMEOUT_LIMIT = 30000;

        // ToneJS & Piano Vars
        let sampler = null;
        let activeNotes = reactive({});
        let metronomeAudio = null;
        let liveInterval = null;
        let localStream = null; 


       
        const teacher = ref({});
        const materials = ref([]);
        const libraryBooks = ref([]);

       const fb_config = {
  apiKey: "AIzaSyCb_t1xm9ueLy0lURXBovtZVdowSgTTT7c",
  authDomain: "mozartplus-85ab1.firebaseapp.com",
  databaseURL: "https://mozartplus-85ab1-default-rtdb.firebaseio.com",
  projectId: "mozartplus-85ab1",
  storageBucket: "mozartplus-85ab1.firebasestorage.app",
  messagingSenderId: "742478520566"
};

        const iceServers = [
            { urls: "stun:stun.relay.metered.ca:80" },
            { urls: "turn:a.relay.metered.ca:80", username: "fad444a63bcf5c8176a3e139", credential: "MQm2u8W0l1TCVMm0" },
            { urls: "turn:a.relay.metered.ca:443", username: "fad444a63bcf5c8176a3e139", credential: "MQm2u8W0l1TCVMm0" }
        ];

        const NOTE_NAMES = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const CHORD_MAP = {
            '0,4,7': { name: 'Mayor', short: '' },
            '0,3,7': { name: 'Menor', short: 'm' },
            '0,3,6': { name: 'Dism', short: 'dim' },
            '0,4,8': { name: 'Aum', short: 'aug' },
            '0,4,7,10': { name: 'Dom 7', short: '7' },
            '0,4,7,11': { name: 'Maj 7', short: 'maj7' },
            '0,3,7,10': { name: 'Menor 7', short: 'm7' },
            '0,3,7,11': { name: 'Menor Maj7', short: 'mM7' },
            '0,3,6,9': { name: 'Dism 7', short: 'dim7' },
            '0,3,6,10': { name: 'Semi Dism', short: 'm7b5' }
        };
        const VISUALIZER_CONFIG = {
            staffYTop: 40,
            staffLineGap: 12,
            noteRadiusX: 8,
            noteRadiusY: 6,
            accidentalGap: 26
        };

        // ==================== COMPUTED ====================
        const getStatusTitle = computed(() => {
            switch(connectionStatus.value) {
                case 'idle': return 'Desconectado';
                case 'connecting': return 'Estableciendo conexión...';
                case 'connected': return 'En Vivo';
                case 'failed': return 'Error de conexión';
                case 'ended': return 'Clase Finalizada';
                default: return 'Desconectado';
            }
        });

        const getStatusSubtitle = computed(() => {
            switch(connectionStatus.value) {
                case 'idle': return 'No conectado a ninguna clase';
                case 'connecting': return 'Esperando al profesor...';
                case 'connected': return 'Clase en curso';
                case 'failed': return 'Tiempo de espera agotado';
                case 'ended': return 'Has sido desconectado de la sesión';
                default: return '';
            }
        });

const getMaterialIcon = (type) => {
    const t = (type || '').toUpperCase();
    if (t === 'PDF') return 'fa-file-pdf';
    if (t === 'IMG' || t === 'JPG' || t === 'PNG') return 'fa-file-image';
    if (t === 'WEB' || t === 'LINK') return 'fa-globe';
    if (t === 'VIDEO' || t === 'MP4') return 'fa-play-circle';
    return 'fa-file'; // Default
};

const processAgenda = (rawData) => {
    const hoy = new Date();
    const months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
    const sorted = rawData.sort((a, b) => a.date - b.date);
    let foundNext = false;

    schedule.value = sorted.map(function(item) {
        let status = '';
        
        item.dayNum = item.date.getDate();
        const nombreDia = item.date.toLocaleDateString('es-MX', { weekday: 'long' });
        item.day = nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1);
        item.monthStr = months[item.date.getMonth()];
        item.dateStr = `${item.day}, ${item.dayNum} de ${months[item.date.getMonth()]}`;

        // Lógica de estados (Pasada, Siguiente, Futura)
        if (item.date < hoy) {
            status = 'past';
        } else if (!foundNext) {
            status = 'next';
            foundNext = true;
            nextClass.value = {
                title: item.title,
                dateStr: item.dateStr,
                time: item.time
            };
        } else {
            status = 'future';
        }
        item.status = status;
        return item;
    });
};

        // Firebase Init
        const initFirebase = () => {
            if (!firebase.apps.length) {
                firebase.initializeApp(fb_config);
            }
            db = firebase.database();
            usersRef = db.ref(room + '/users');
            signalsRef = db.ref(room + '/signals');
            usersRef.child(myId).onDisconnect().remove();
        };

        // User Data Fetch
        const fetchUserData = async () => {
            const requestData = {
                action: "getUserData",
                token: localStorage.getItem('MStoken')
            };
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', {
                    method: 'POST',
                    body: JSON.stringify(requestData),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
                const data = await response.json();
                userName.value = data.name;
                const serverSchedule = JSON.parse(data.agenda) || [];
                
                  const formattedSchedule = serverSchedule.map(event => {
                  const dateObj = new Date(event.start);
                  return {
                      title: event.title,
                      date: dateObj, 
                      time: dateObj.toLocaleTimeString('es-MX', {
                          hour: '2-digit', 
                          minute:'2-digit', 
                          hour12: false
                      })
                  };
              });
              processAgenda(formattedSchedule);
              scrollToCurrent();

              const serverMaterials = JSON.parse(data.files) || [];  
        materials.value = serverMaterials.map(m => ({
            title: m.name || m.title, // Soporta que el server mande "name" o "title"
            type: m.type || 'FILE',
            size: m.size || '',
            url: m.url || '#',
            icon: getMaterialIcon(m.type) // Asigna el icono FontAwesome
        }));

        const manuals = JSON.parse(data.manuals) || [{"level": "Nivel Preparatorio", "unit": "Unidad 1", "cover": "https://lh3.googleusercontent.com/d/1rFNza9NDinXOb0OOG3pTEYx8IYWygNKF=s300","fileUrl": "https://drive.google.com/uc?export=download&id=1rFNza9NDinXOb0OOG3pTEYx8IYWygNKF"}];
        libraryBooks.value = manuals.map(m => ({
            level: m.level, 
            unit: m.unit,
            cover: m.cover,
            fileUrl: m.fileUrl
        }));


        teacher.value = JSON.parse(data.teacher);
            } catch(e) {
                console.error("Fetch error", e);
            }finally {
                isLoading.value = false;
            }
        };


        const scrollToCurrent = () => {
    nextTick(() => {
        const el = document.getElementById('scroll-target');
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        };


        const downloadBook = (book) => {
    isDownloading.value = true;
    setTimeout(() => {
        const link = document.createElement('a');
        link.href = book.fileUrl;
        link.download = `${book.level} - ${book.unit}.pdf`; 
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => {
            isDownloading.value = false;
        }, 3000); 

    }, 500); 
};

        // Connection / WebRTC
        const joinClass = () => {
            if (connectionStatus.value === 'connecting' || connectionStatus.value === 'connected') return;
            connectionStatus.value = 'connecting';
            
            connectionTimeoutPromise = setTimeout(handleConnectionTimeout, TIMEOUT_LIMIT);
            
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then((stream) => {
                    rtcLocalStream = stream;
                    micOn.value = true;
                    usersRef.child(myId).set({ 
                        id: myId, 
                        role: "user", 
                        name: userName.value 
                    });
                    listenForSignals();
                })
                .catch(err => {
                    console.error("Error mic:", err);
                    alert("Se requiere micrófono para la clase.");
                    clearTimeout(connectionTimeoutPromise);
                    connectionStatus.value = 'failed';
                });
        };

        const handleConnectionTimeout = () => {
            connectionStatus.value = 'failed';
            alert("El profesor no aceptó la conexión a tiempo. Recargando...");
            window.location.reload();
        };

        const onProfessorAccepted = () => {
            if (connectionTimeoutPromise) clearTimeout(connectionTimeoutPromise);
            connectionStatus.value = 'connected';
            remoteStreamActive.value = true;
            currentView.value = 'live';

            nextTick(() => {
                initLiveEnvironment();
                startLiveTimer();
                setupDraggableModal();
            });
        };

        const startPeer = (initiator, remoteId) => {
            peer = new SimplePeer({ 
                initiator: initiator, 
                stream: rtcLocalStream,
                config: { iceServers: iceServers }
            });

            peer.on("signal", data => {
                signalsRef.push({ from: myId, to: remoteId, data });
            });

            peer.on("track", (track, stream) => {
                console.log(`🔊 Nuevo track recibido: ${track.kind}`);
                nextTick(() => {
                    const remoteVideo = document.getElementById('remote-video');
                    if (remoteVideo) {
                        if (remoteVideo.srcObject) {
                            const existingTracks = remoteVideo.srcObject.getTracks();
                            const allTracks = [...existingTracks, track];
                            const newStream = new MediaStream(allTracks);
                            remoteVideo.srcObject = newStream;
                        } else {
                            remoteVideo.srcObject = stream;
                        }
                        if (remoteVideo.paused) {
                            remoteVideo.play().catch(console.error);
                        }
                        remoteStreamActive.value = true;
                    }
                });
            });

            peer.on("stream", stream => {
                console.log("📹 Stream inicial recibido");
                nextTick(() => {
                    const remoteVideo = document.getElementById('remote-video');
                    if (remoteVideo && !remoteVideo.srcObject) {
                        remoteVideo.srcObject = stream;
                        remoteVideo.play().catch(console.error);
                        remoteStreamActive.value = true;
                    }
                    onProfessorAccepted();
                });
            });

            peer.on("data", data => {
                const msgData = JSON.parse(data.toString());
                if (msgData.type === 'chat') {
                    chatMessages.value.push({ 
                        sender: "Profesor", 
                        text: msgData.text, 
                        isMe: false 
                    });
                    scrollToChatBottom();
                }
                else if (msgData.type === 'midi') {
                    handleIncomingMIDI(msgData);
                }
            });

            peer.on("error", err => console.error("WebRTC Error:", err));
            peer.on("close", () => {
                remoteStreamActive.value = false;
                cleanupSession();
            });
        };

        const listenForSignals = () => {
            signalsRef.on("child_added", snap => {
                const signal = snap.val();
                if (signal.to === myId) {
                    if (!peer) {
                        startPeer(false, signal.from);
                    }
                    try {
                        peer.signal(signal.data);
                    } catch(e) { console.error(e); }
                }
            });
        };

        const leaveClass = () => {
            if(confirm("¿Salir de la clase?")) {
                cleanupSession(); 
            }
        };

        const cleanupSession = () => {
            stopMetronome();
            if (peer) { peer.destroy(); peer = null; }
            if (rtcLocalStream) {
                rtcLocalStream.getTracks().forEach(t => t.stop());
                rtcLocalStream = null;
            }
            if (usersRef) usersRef.child(myId).remove();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (liveInterval) clearInterval(liveInterval);

            remoteStreamActive.value = false;
            currentView.value = 'dashboard';
            camOn.value = false;
            micOn.value = false;
            connectionStatus.value = 'ended';
        };

        // Chat
        const sendChatMessage = () => {
            if(!chatInput.value || !chatInput.value.trim()) return;
            const text = chatInput.value;
            
            chatMessages.value.push({ sender: "Tú", text: text, isMe: true });

            if (peer) {
                try {
                    const payload = JSON.stringify({ type: 'chat', text: text });
                    peer.send(payload);
                } catch(e) { console.log("No conectado aun"); }
            }

            chatInput.value = "";
            scrollToChatBottom();
        };

        const scrollToChatBottom = () => {
            nextTick(() => {
                const list = document.getElementById('chatList');
                if(list) list.scrollTop = list.scrollHeight;
            });
        };

        // UI Helpers
        const openLibrary = () => showLibraryModal.value = true;
        const closeLibrary = () => showLibraryModal.value = false;
        
        const openPdf = (url) => {
            showPdfModal.value = true;
            nextTick(() => {
                const iframe = document.getElementById('pdfIframe');
                if(iframe) iframe.src = url;
            });
        };
        
        const closePdfModal = () => {
            showPdfModal.value = false;
            const iframe = document.getElementById('pdfIframe');
            if(iframe) iframe.src = "";
        };

        const sendMessage = () => alert("Función de mensajería próximamente");
        const cancelClass = (num) => {
           var url = "http://wa.me/"+num
           window.open(url, '_blank');
        };

        // Cam & Mic
        const toggleCam = async () => {
            const videoEl = document.getElementById('student-video');
            if(!camOn.value) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoEl.srcObject = localStream;
                    videoEl.style.display = 'block';
                    camOn.value = true;
                } catch(e) {
                    alert("Error al acceder a la cámara: " + e.message);
                }
            } else {
                if(localStream) {
                    localStream.getTracks().forEach(t => t.stop());
                }
                videoEl.style.display = 'none';
                videoEl.srcObject = null;
                camOn.value = false;
            }
        };

        const toggleMic = () => {
            micOn.value = !micOn.value;
            if (rtcLocalStream) {
                const audioTrack = rtcLocalStream.getAudioTracks()[0];
                if (audioTrack) audioTrack.enabled = micOn.value;
            }
        };

        // Metronome
        const toggleMetronome = async () => {
            await Tone.start();
            if(!metronomeAudio) {
                metronomeAudio = document.createElement('audio');
                metronomeAudio.src = "https://dashboard.mozartacademy.mx/media/metronom.mp3";
                metronomeAudio.loop = true;
            }

            if(isMetroPlaying.value) {
                metronomeAudio.pause();
                metronomeAudio.currentTime = 0;
                isMetroPlaying.value = false;
            } else {
                metronomeAudio.playbackRate = bpm.value / 60; // BASE_BPM = 60
                try {
                    await metronomeAudio.play();
                    isMetroPlaying.value = true;
                } catch(err) { console.error("Error metronomo:", err); }
            }
        };

        const changeBpm = (val) => {
            bpm.value += val;
            if(bpm.value < 40) bpm.value = 40;
            if(bpm.value > 200) bpm.value = 200;
            if(metronomeAudio) {
                metronomeAudio.playbackRate = bpm.value / 60;
            }
        };

        const stopMetronome = () => {
            if(metronomeAudio) {
                metronomeAudio.pause();
                metronomeAudio.currentTime = 0;
            }
            isMetroPlaying.value = false;
        };

        // Live Timer
        const startLiveTimer = () => {
            let sec = 0;
            liveInterval = setInterval(() => {
                sec++;
                let m = Math.floor(sec/60).toString().padStart(2,'0');
                let s = (sec%60).toString().padStart(2,'0');
                liveTimerDisplay.value = `${m}:${s}`;
            }, 1000);
        };

        // Piano Logic
        const initLiveEnvironment = () => {
            console.log("Inicializando Piano y Sampler...");
            sampler = new Tone.Sampler({
                urls: {
                    A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3",
                    C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3", C3: "C3.mp3",
                    "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3",
                    "F#4": "Fs4.mp3", A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3",
                    A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3", A6: "A6.mp3",
                    C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3", A7: "A7.mp3", C8: "C8.mp3"
                },
                release: 1,
                baseUrl: "https://tonejs.github.io/audio/salamander/"
            }).toDestination();

            renderPianoKeys();
            setupKeyboardInput();
            initMIDI();
        };

        const renderPianoKeys = () => {
            const container = document.getElementById('piano-keys-container');
            if(!container) return;
            container.innerHTML = '';
            
            const pattern = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = { 'C': 'Db', 'D': 'Eb', 'F': 'Gb', 'G': 'Ab', 'A': 'Bb' };
            
            for (let octave = 1; octave <= 7; octave++) {
                for (let i = 0; i <= 6; i++) {
                    const note = pattern[i];
                    const noteName = `${note}${octave}`;
                    
                    const whiteKey = document.createElement('div');
                    whiteKey.className = 'key white';
                    whiteKey.id = `key-${noteName}`;
                    whiteKey.dataset.note = noteName;
                    addKeyEvents(whiteKey, noteName);
                    container.appendChild(whiteKey);

                    if (blackKeys[note]) {
                        const blackNoteName = `${blackKeys[note]}${octave}`;
                        const blackKey = document.createElement('div');
                        blackKey.className = 'key black';
                        blackKey.id = `key-${blackNoteName}`;
                        blackKey.dataset.note = blackNoteName;
                        addKeyEvents(blackKey, blackNoteName);
                        container.appendChild(blackKey);
                    }
                }
            }
        };

        const addKeyEvents = (el, note) => {
            let mouseIsDown = false;
            el.addEventListener('mousedown', () => { mouseIsDown = true; triggerNoteOn(note); });
            el.addEventListener('mouseenter', () => { if (mouseIsDown) triggerNoteOn(note); });
            el.addEventListener('mouseup', () => triggerNoteOff(note));
            el.addEventListener('mouseleave', () => triggerNoteOff(note));
            el.addEventListener('touchstart', (e) => { e.preventDefault(); triggerNoteOn(note); });
            el.addEventListener('touchend', (e) => { e.preventDefault(); triggerNoteOff(note); });
        };

        const triggerNoteOn = (noteName) => {
            if (Tone.context.state !== 'running') Tone.start();
            if (activeNotes[noteName]) return;
            
            if (sampler) sampler.triggerAttack(noteName, Tone.now());

            const domKey = document.getElementById(`key-${noteName}`);
            if (domKey) {
                domKey.classList.add('active');
                createFloatingLabel(noteName, domKey);
            }

            activeNotes[noteName] = true;
            updateMusicalDisplays();
        };

        const triggerNoteOff = (noteName) => {
            if (!activeNotes[noteName]) return;
            if (sampler) sampler.triggerRelease(noteName);

            const domKey = document.getElementById(`key-${noteName}`);
            if (domKey) domKey.classList.remove('active');

            removeFloatingLabel(noteName);
            delete activeNotes[noteName];
            updateMusicalDisplays();
        };

        const createFloatingLabel = (noteName, keyElement) => {
            const casing = document.getElementById('piano-top-casing');
            if (!casing) return;
            const keyRect = keyElement.getBoundingClientRect();
            const casingRect = casing.getBoundingClientRect();
            const keyCenterX = keyRect.left + (keyRect.width / 2);
            const relativeX = keyCenterX - casingRect.left;
            
            if (relativeX < 0 || relativeX > casingRect.width) return;

            const lbl = document.createElement('div');
            lbl.className = 'casing-note-label';
            lbl.id = `lbl-${noteName}`;
            lbl.innerText = noteName.replace(/[0-9]/g, '');
            lbl.style.left = `${relativeX}px`;
            casing.appendChild(lbl);
        };

        const removeFloatingLabel = (noteName) => {
            const lbl = document.getElementById(`lbl-${noteName}`);
            if (lbl) lbl.remove();
        };

        const setupKeyboardInput = () => {
             const keyMap = {
                'a': 'C4', 'w': 'Db4', 's': 'D4', 'e': 'Eb4', 'd': 'E4',
                'f': 'F4', 't': 'Gb4', 'g': 'G4', 'y': 'Ab4', 'h': 'A4',
                'u': 'Bb4', 'j': 'B4', 'k': 'C5', 'o': 'Db5', 'l': 'D5',
                'p': 'Eb5', ';': 'E5'
            };
            document.addEventListener('keydown', (e) => {
                if (!e.repeat && keyMap[e.key]) triggerNoteOn(keyMap[e.key]);
            });
            document.addEventListener('keyup', (e) => {
                if (keyMap[e.key]) triggerNoteOff(keyMap[e.key]);
            });
        };

        // Musical Analysis Helpers
        const noteNameToMidi = (noteName) => {
            const noteMap = { 'C': 0, 'Db': 1, 'D': 2, 'Eb': 3, 'E': 4, 'F': 5, 'Gb': 6, 'G': 7, 'Ab': 8, 'A': 9, 'Bb': 10, 'B': 11 };
            const match = noteName.match(/^([A-G]b?)(\d+)$/);
            if (!match) return 0;
            let [, note, octave] = match;
            if (note.includes('#')) {
                const mapSharp = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
                if (mapSharp[note]) note = mapSharp[note];
            }
            return (parseInt(octave) + 1) * 12 + noteMap[note];
        };

        const getInterval = (note1, note2) => {
            const intervals = ['Unísono', '2da Menor', '2da Mayor', '3ra Menor', '3ra Mayor', '4ta Justa', 'Tritono', '5ta Justa', '6ta Menor', '6ta Mayor', '7ma Menor', '7ma Mayor', 'Octava'];
            const diff = Math.abs(noteNameToMidi(note2) - noteNameToMidi(note1)) % 12;
            return intervals[diff] || 'Intervalo';
        };

        const getChordName = (notes) => {
            if (notes.length < 3) return null;
            const midis = notes.map(noteNameToMidi).sort((a, b) => a - b);
            const bassMidi = midis[0];
            const bassNoteName = NOTE_NAMES[bassMidi % 12];
            const uniquePCs = [...new Set(midis.map(m => m % 12))];

            for (let i = 0; i < uniquePCs.length; i++) {
                const potentialRoot = uniquePCs[i];
                const intervals = uniquePCs.map(pc => (pc - potentialRoot + 12) % 12).sort((a, b) => a - b).join(',');
                const chordInfo = CHORD_MAP[intervals];
                if (chordInfo) {
                    const rootName = NOTE_NAMES[potentialRoot];
                    const chordLabel = rootName + chordInfo.short;
                    return (potentialRoot !== (bassMidi % 12)) ? `${chordLabel}/${bassNoteName}` : chordLabel;
                }
            }
            return null;
        };

        const updateMusicalDisplays = () => {
            const activeNames = Object.keys(activeNotes);
            let text = '---';
            if (activeNames.length === 1) text = activeNames[0].replace(/[0-9]/g, '');
            else if (activeNames.length === 2) text = getInterval(activeNames[0], activeNames[1]);
            else if (activeNames.length >= 3) text = getChordName(activeNames) || 'Acorde desc.';
            
            detectedChord.value = text;
            drawStaff(activeNames);
        };

        // SVG Drawing
        const createSvgElement = (name, attributes) => {
            const el = document.createElementNS("http://www.w3.org/2000/svg", name);
            for (let key in attributes) el.setAttribute(key, attributes[key]);
            return el;
        };

        const drawStaff = (activeNotesArray) => {
            const svg = document.getElementById('staff-svg');
            if (!svg) return;
            svg.innerHTML = '';
            const container = document.getElementById('staff-container');
            const width = container ? container.clientWidth : 300;

            for (let i = 0; i < 5; i++) {
                const y = VISUALIZER_CONFIG.staffYTop + (i * VISUALIZER_CONFIG.staffLineGap);
                svg.appendChild(createSvgElement('line', { x1: 10, y1: y, x2: width - 10, y2: y, class: 'staff-line' }));
            }

            let useTreble = true;
            if (activeNotesArray.length > 0) {
                const midis = activeNotesArray.map(noteNameToMidi).sort((a, b) => a - b);
                if (midis[0] < 60) useTreble = false;
            }

            const clefY = useTreble ? VISUALIZER_CONFIG.staffYTop + 46 : VISUALIZER_CONFIG.staffYTop + 35;
            const clefText = createSvgElement('text', { x: 5, y: clefY, class: useTreble ? 'clef' : 'clef bass-clef' });
            clefText.textContent = useTreble ? '𝄞' : '𝄢';
            svg.appendChild(clefText);

            if (activeNotesArray.length === 0) return;
            const midis = activeNotesArray.map(noteNameToMidi).sort((a, b) => a - b);
            const baseX = 80;
            midis.forEach((midi, index) => {
                const x = baseX + (index * 35);
                drawNote(midi, x, useTreble, svg);
            });
        };

        const drawNote = (midi, x, isTreble, svg) => {
            const octave = Math.floor(midi / 12) - 1;
            const noteIndex = midi % 12;
            const noteName = NOTE_NAMES[noteIndex];
            const diatonicMap = { 'C': 0, 'Db': 1, 'D': 1, 'Eb': 2, 'E': 2, 'F': 3, 'Gb': 4, 'G': 4, 'Ab': 5, 'A': 5, 'Bb': 6, 'B': 6 };
            const myDiatonicIndex = (octave * 7) + diatonicMap[noteName.replace(/[0-9]/g, '')];
            const refDiatonicIndex = isTreble ? 38 : 26;
            const stepsFromTop = refDiatonicIndex - myDiatonicIndex;
            const stepSize = VISUALIZER_CONFIG.staffLineGap / 2;
            const y = VISUALIZER_CONFIG.staffYTop + (stepsFromTop * stepSize);

            const head = createSvgElement('ellipse', { cx: x, cy: y, rx: VISUALIZER_CONFIG.noteRadiusX, ry: VISUALIZER_CONFIG.noteRadiusY, class: 'note-head', transform: `rotate(-20, ${x}, ${y})` });
            svg.appendChild(head);
            
            const stemHeight = 35;
            svg.appendChild(createSvgElement('line', { x1: x + (VISUALIZER_CONFIG.noteRadiusX - 1), y1: y, x2: x + (VISUALIZER_CONFIG.noteRadiusX - 1), y2: y - stemHeight, class: 'note-stem' }));

            if (noteName.includes('b') || noteName.includes('#')) {
                const symbol = noteName.includes('#') ? '♯' : '♭';
                const acc = createSvgElement('text', { x: x - VISUALIZER_CONFIG.accidentalGap, y: y + 6, class: 'note-accidental' });
                acc.textContent = symbol;
                svg.appendChild(acc);
            }

            // Ledger lines logic simplified
            if (stepsFromTop < 0 || stepsFromTop > 8) {
                // Simplified for brevity, same logic as before
                const isEven = stepsFromTop % 2 === 0;
                 // Custom logic for ledger lines if needed
            }
        };

        // MIDI
        const initMIDI = async () => {
             if (navigator.requestMIDIAccess) {
                try {
                    midiAccess = await navigator.requestMIDIAccess();
                    console.log('✅ MIDI Acceso concedido');
                    const inputs = midiAccess.inputs.values();
                    for (let input of inputs) {
                        midiInput = input;
                        midiInput.onmidimessage = handleMIDIMessage;
                    }
                    midiAccess.onstatechange = (e) => {
                         if (e.port.type === 'input' && e.port.state === 'connected') {
                            midiInput = e.port;
                            midiInput.onmidimessage = handleMIDIMessage;
                        }
                    };
                } catch (err) { console.error('❌ Error MIDI:', err); }
             }
        };

        const handleMIDIMessage = (message) => {
            const [command, note, velocity] = message.data;
            if (command === 144 && velocity > 0) triggerNoteOn(midiNoteToName(note));
            else if (command === 128 || (command === 144 && velocity === 0)) triggerNoteOff(midiNoteToName(note));
        };

        const handleIncomingMIDI = (midiData) => {
            if (midiData.action === 'noteOn') triggerNoteOn(midiData.note);
            else if (midiData.action === 'noteOff') triggerNoteOff(midiData.note);
        };

        const midiNoteToName = (midiNote) => {
            const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            const octave = Math.floor(midiNote / 12) - 1;
            return `${noteNames[midiNote % 12]}${octave}`;
        };

        // Draggable Modal
        const setupDraggableModal = () => {
            const modal = document.getElementById('draggableModal');
            const header = document.getElementById('modalHeader');
            if (!modal || !header) return;

            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            let xOffset = 0, yOffset = 0;

            const dragStart = (e) => {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                if (e.target === header || e.target.parentNode === header) isDragging = true;
            };
            const dragEnd = () => { initialX = currentX; initialY = currentY; isDragging = false; };
            const drag = (e) => {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    modal.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
                }
            };
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', drag);
        };

        // Lifecycle
        onMounted(() => {
            initFirebase();
            fetchUserData();
        });

        // Return to Template
        return {
            schedule, nextClass, isLoading, isDownloading, downloadBook, canJoin, currentView, activeTab, micOn, camOn,
            bpm, isMetroPlaying, liveTimerDisplay, detectedChord, chatInput,
            showPdfModal, showLibraryModal, userName, connectionStatus,
            remoteStreamActive, chatMessages, teacher, materials, libraryBooks, 
            getStatusTitle, getStatusSubtitle,
            joinClass, leaveClass, sendChatMessage, openLibrary, closeLibrary,
            openPdf, closePdfModal, sendMessage, cancelClass, toggleCam, toggleMic,
            toggleMetronome, changeBpm
        };
    }
});

app.mount('#app');
</script>
</html> 
